<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="5AUIVYTbHIAuz-eQtxSfZbWW5eg9_EVZMSQycIuXrG0">

<link rel="stylesheet" href="/blog/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&family=Inconsolata:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"phoenixsu9.github.io","root":"/blog/","images":"/blog/images","scheme":"Gemini","darkmode":true,"version":"8.23.1","exturl":true,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":"default"},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":true,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":true,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/blog/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/blog/js/config.js" defer></script>

    <meta name="description" content="深入剖析Apache ZooKeeper核心源码，详解ZAB一致性算法、Leader选举机制、数据同步流程等关键技术，结合实际应用场景提供分布式协调服务的最佳实践指导。">
<meta property="og:type" content="article">
<meta property="og:title" content="ZooKeeper源码深度解析：从核心算法到实战应用">
<meta property="og:url" content="https://phoenixsu9.github.io/blog/2020/01/17/zookeeper%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/index.html">
<meta property="og:site_name" content="Addroc&#39;s Blog">
<meta property="og:description" content="深入剖析Apache ZooKeeper核心源码，详解ZAB一致性算法、Leader选举机制、数据同步流程等关键技术，结合实际应用场景提供分布式协调服务的最佳实践指导。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://phoenixsu9.github.io/blog/images/zookeeper/arti/zookeeper%E9%9B%86%E7%BE%A4.png">
<meta property="og:image" content="https://phoenixsu9.github.io/blog/images/zookeeper/arti/zookeeper%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BB%84%E4%BB%B6%E6%9E%B6%E6%9E%84.png">
<meta property="og:image" content="https://phoenixsu9.github.io/blog/images/zookeeper/arti/Leader%E9%80%89%E4%B8%BE%E7%AE%97%E6%B3%95.png">
<meta property="og:image" content="https://phoenixsu9.github.io/blog/images/zookeeper/arti/%E9%80%89%E4%B8%BE%E7%AE%97%E6%B3%95%E6%B5%81%E7%A8%8B%E5%9B%BE.png">
<meta property="og:image" content="https://phoenixsu9.github.io/blog/images/zookeeper/arti/Leader%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E6%B5%81%E7%A8%8B.png">
<meta property="og:image" content="https://phoenixsu9.github.io/blog/images/zookeeper/arti/%E4%BA%8B%E5%8A%A1%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B.png">
<meta property="og:image" content="https://phoenixsu9.github.io/blog/images/zookeeper/arti/Watch%E6%9C%BA%E5%88%B6%E6%9E%B6%E6%9E%84.png">
<meta property="og:image" content="https://phoenixsu9.github.io/blog/images/zookeeper/arti/Watch%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B.png">
<meta property="og:image" content="https://phoenixsu9.github.io/blog/images/zookeeper/arti/NIO%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%9E%B6%E6%9E%84.png">
<meta property="og:image" content="https://phoenixsu9.github.io/blog/images/zookeeper/arti/%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E9%93%BE%E6%9E%B6%E6%9E%84.png">
<meta property="og:image" content="https://phoenixsu9.github.io/blog/images/zookeeper/arti/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E6%9E%B6%E6%9E%84.png">
<meta property="og:image" content="https://phoenixsu9.github.io/blog/images/zookeeper/arti/%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E6%9E%B6%E6%9E%84.png">
<meta property="article:published_time" content="2020-01-17T00:28:47.000Z">
<meta property="article:modified_time" content="2025-12-19T06:51:32.295Z">
<meta property="article:author" content="Addroc">
<meta property="article:tag" content="分布式系统">
<meta property="article:tag" content="大数据">
<meta property="article:tag" content="zookeeper">
<meta property="article:tag" content="源码解析">
<meta property="article:tag" content="一致性算法">
<meta property="article:tag" content="ZAB协议">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://phoenixsu9.github.io/blog/images/zookeeper/arti/zookeeper%E9%9B%86%E7%BE%A4.png">


<link rel="canonical" href="https://phoenixsu9.github.io/blog/2020/01/17/zookeeper%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://phoenixsu9.github.io/blog/2020/01/17/zookeeper%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/","path":"2020/01/17/zookeeper源码解析/","title":"ZooKeeper源码深度解析：从核心算法到实战应用"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>ZooKeeper源码深度解析：从核心算法到实战应用 | Addroc's Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-43861RVV8R"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-43861RVV8R","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/blog/js/third-party/analytics/google-analytics.js" defer></script>








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous" defer></script>
<script src="/blog/js/utils.js" defer></script><script src="/blog/js/motion.js" defer></script><script src="/blog/js/sidebar.js" defer></script><script src="/blog/js/next-boot.js" defer></script><script src="/blog/js/pjax.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous" defer></script>
<script src="/blog/js/third-party/search/local-search.js" defer></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.5.0/mermaid.min.js","integrity":"sha256-2obLuIPcceEhkE3G09G33hBdmE55ivVcZUlcKcGNHjU="}}</script>
  <script src="/blog/js/third-party/tags/mermaid.js" defer></script>

  <script class="next-config" data-name="wavedrom" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/wavedrom.min.js","integrity":"sha256-INLAoJc6quTNfiMWkGZniYO2cxE8mHpddnLow1m6RFs="}}</script>
  <script class="next-config" data-name="wavedrom_skin" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/skins/default.js","integrity":"sha256-fduc/Zszk5ezWws2uInY/ALWVmIrmV6VTgXbsYSReFI="}}</script>
  <script src="/blog/js/third-party/tags/wavedrom.js" defer></script>




  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"ams","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/blog/js/third-party/math/mathjax.js" defer></script>



  <noscript>
    <link rel="stylesheet" href="/blog/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Addroc's Blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Addroc blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/blog/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-archives"><a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">21</span></a></li><li class="menu-item menu-item-categories"><a href="/blog/categories/" rel="section"><i class="fa fa-folder-open fa-fw"></i>分类<span class="badge">20</span></a></li><li class="menu-item menu-item-tags"><a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">63</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#ZooKeeper%E6%BA%90%E7%A0%81%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%EF%BC%9A%E4%BB%8E%E6%A0%B8%E5%BF%83%E7%AE%97%E6%B3%95%E5%88%B0%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8"><span class="nav-number">1.</span> <span class="nav-text">ZooKeeper源码深度解析：从核心算法到实战应用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81ZooKeeper%E6%9E%B6%E6%9E%84%E6%A6%82%E8%A7%88"><span class="nav-number">1.2.</span> <span class="nav-text">一、ZooKeeper架构概览</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="nav-number">1.2.1.</span> <span class="nav-text">1.1 整体架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E5%85%B3%E9%94%AE%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">1.2.2.</span> <span class="nav-text">1.2 关键数据结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-ZooKeeper%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BB%84%E4%BB%B6%E6%9E%B6%E6%9E%84"><span class="nav-number">1.2.3.</span> <span class="nav-text">1.3 ZooKeeper服务器组件架构</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81ZAB%E5%8D%8F%E8%AE%AE%E6%A0%B8%E5%BF%83%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90"><span class="nav-number">1.3.</span> <span class="nav-text">二、ZAB协议核心算法分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-ZAB%E5%8D%8F%E8%AE%AE%E6%A6%82%E8%BF%B0"><span class="nav-number">1.3.1.</span> <span class="nav-text">2.1 ZAB协议概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-Leader%E9%80%89%E4%B8%BE%E7%AE%97%E6%B3%95"><span class="nav-number">1.3.2.</span> <span class="nav-text">2.2 Leader选举算法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-1-FastLeaderElection%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">2.2.1 FastLeaderElection实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-2-%E9%80%89%E4%B8%BE%E7%AE%97%E6%B3%95%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">2.2.2 选举算法流程图</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-3-%E9%80%89%E4%B8%BE%E7%AE%97%E6%B3%95%E6%A0%B8%E5%BF%83%E8%A6%81%E7%82%B9"><span class="nav-number">1.3.2.3.</span> <span class="nav-text">2.2.3 选举算法核心要点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E6%9C%BA%E5%88%B6"><span class="nav-number">1.3.3.</span> <span class="nav-text">2.3 数据同步机制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-1-Leader%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E6%B5%81%E7%A8%8B"><span class="nav-number">1.3.3.1.</span> <span class="nav-text">2.3.1 Leader数据同步流程</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E4%BA%8B%E5%8A%A1%E5%A4%84%E7%90%86%E6%9C%BA%E5%88%B6"><span class="nav-number">1.4.</span> <span class="nav-text">三、事务处理机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E4%BA%8B%E5%8A%A1%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="nav-number">1.4.1.</span> <span class="nav-text">3.1 事务处理流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E4%BA%8B%E5%8A%A1%E6%97%A5%E5%BF%97%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.4.2.</span> <span class="nav-text">3.2 事务日志实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-%E5%BF%AB%E7%85%A7%E6%9C%BA%E5%88%B6"><span class="nav-number">1.4.3.</span> <span class="nav-text">3.3 快照机制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81Watch%E6%9C%BA%E5%88%B6%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="nav-number">1.5.</span> <span class="nav-text">四、Watch机制源码解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-Watch%E6%9C%BA%E5%88%B6%E6%9E%B6%E6%9E%84"><span class="nav-number">1.5.1.</span> <span class="nav-text">4.1 Watch机制架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-Watch%E7%AE%A1%E7%90%86%E5%99%A8%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.5.2.</span> <span class="nav-text">4.2 Watch管理器实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-Watch%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="nav-number">1.5.3.</span> <span class="nav-text">4.3 Watch事件处理流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-Watch%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.5.4.</span> <span class="nav-text">4.4 Watch事件处理实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6"><span class="nav-number">1.6.</span> <span class="nav-text">五、网络通信机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-NIO%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%9E%B6%E6%9E%84"><span class="nav-number">1.6.1.</span> <span class="nav-text">5.1 NIO服务器架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-NIO%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.6.2.</span> <span class="nav-text">5.2 NIO服务器实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E9%93%BE%E6%9E%B6%E6%9E%84"><span class="nav-number">1.6.3.</span> <span class="nav-text">5.3 请求处理链架构</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E4%B8%8E%E7%9B%91%E6%8E%A7"><span class="nav-number">1.7.</span> <span class="nav-text">六、性能优化与监控</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E4%BC%98%E5%8C%96"><span class="nav-number">1.7.1.</span> <span class="nav-text">6.1 内存管理优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-JMX%E7%9B%91%E6%8E%A7%E6%8C%87%E6%A0%87"><span class="nav-number">1.7.2.</span> <span class="nav-text">6.2 JMX监控指标</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%83%E3%80%81%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">1.8.</span> <span class="nav-text">七、实战应用场景</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.8.1.</span> <span class="nav-text">7.1 分布式锁实现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-1-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E6%9E%B6%E6%9E%84"><span class="nav-number">1.8.1.1.</span> <span class="nav-text">7.1.1 分布式锁架构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-2-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.8.1.2.</span> <span class="nav-text">7.1.2 分布式锁实现</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.8.2.</span> <span class="nav-text">7.2 配置中心实现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-1-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E6%9E%B6%E6%9E%84"><span class="nav-number">1.8.2.1.</span> <span class="nav-text">7.2.1 配置中心架构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-2-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.8.2.2.</span> <span class="nav-text">7.2.2 配置中心实现</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-3-%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.8.3.</span> <span class="nav-text">7.3 服务发现实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AB%E3%80%81%E8%BF%90%E7%BB%B4%E4%B8%8E%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5"><span class="nav-number">1.9.</span> <span class="nav-text">八、运维与故障排查</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%AF%8A%E6%96%AD"><span class="nav-number">1.9.1.</span> <span class="nav-text">8.1 常见问题诊断</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#8-1-1-%E8%BF%9E%E6%8E%A5%E8%B6%85%E6%97%B6%E9%97%AE%E9%A2%98"><span class="nav-number">1.9.1.1.</span> <span class="nav-text">8.1.1 连接超时问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-1-2-%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E6%8E%92%E6%9F%A5"><span class="nav-number">1.9.1.2.</span> <span class="nav-text">8.1.2 内存泄漏排查</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E5%BB%BA%E8%AE%AE"><span class="nav-number">1.9.2.</span> <span class="nav-text">8.2 性能调优建议</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#8-2-1-JVM%E5%8F%82%E6%95%B0%E4%BC%98%E5%8C%96"><span class="nav-number">1.9.2.1.</span> <span class="nav-text">8.2.1 JVM参数优化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-2-2-%E9%85%8D%E7%BD%AE%E4%BC%98%E5%8C%96"><span class="nav-number">1.9.2.2.</span> <span class="nav-text">8.2.2 配置优化</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B9%9D%E3%80%81%E6%80%BB%E7%BB%93"><span class="nav-number">1.10.</span> <span class="nav-text">九、总结</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Addroc"
      src="/blog/images/touxiang.jpg">
  <p class="site-author-name" itemprop="name">Addroc</p>
  <div class="site-description" itemprop="description">Addroc's blog</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/blog/archives/">
          <span class="site-state-item-count">21</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/blog/categories/">
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/blog/tags/">
        <span class="site-state-item-count">63</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRlZS5jb20vYWRkcm9j" title="GitHub → https:&#x2F;&#x2F;gitee.com&#x2F;addroc"><i class="fab fa-github fa-fw"></i></span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="bWFpbHRvOmFkZHJvY19zdWVAMTYzLmNvbQ==" title="E-Mail → mailto:addroc_sue@163.com"><i class="fa fa-envelope fa-fw"></i></span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkZHJvY19zdWU=" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;addroc_sue"><i class="fa fa-rss fa-fw"></i></span>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/big/by_nc_sa.svg" alt="Creative Commons"></span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://phoenixsu9.github.io/blog/2020/01/17/zookeeper%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/touxiang.jpg">
      <meta itemprop="name" content="Addroc">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Addroc's Blog">
      <meta itemprop="description" content="Addroc's blog">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="ZooKeeper源码深度解析：从核心算法到实战应用 | Addroc's Blog">
      <meta itemprop="description" content="深入剖析Apache ZooKeeper核心源码，详解ZAB一致性算法、Leader选举机制、数据同步流程等关键技术，结合实际应用场景提供分布式协调服务的最佳实践指导。">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ZooKeeper源码深度解析：从核心算法到实战应用<span class="exturl post-edit-link" data-url="aHR0cHM6Ly9naXRodWIuY29tL25leHQtdGhlbWUvdGhlbWUtbmV4dC1kb2NzL2VkaXQvbWFzdGVyL3NvdXJjZS9fcG9zdHMvem9va2VlcGVy5rqQ56CB6Kej5p6QLm1k" title="编辑"><i class="fa fa-pen-nib"></i></span>
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-01-17 08:28:47" itemprop="dateCreated datePublished" datetime="2020-01-17T08:28:47+08:00">2020-01-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">大数据技术</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%8A%80%E6%9C%AF/Zookeeper/" itemprop="url" rel="index"><span itemprop="name">Zookeeper</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/blog/2020/01/17/zookeeper%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/01/17/zookeeper源码解析/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

            <div class="post-description">深入剖析Apache ZooKeeper核心源码，详解ZAB一致性算法、Leader选举机制、数据同步流程等关键技术，结合实际应用场景提供分布式协调服务的最佳实践指导。</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="ZooKeeper源码深度解析：从核心算法到实战应用"><a href="#ZooKeeper源码深度解析：从核心算法到实战应用" class="headerlink" title="ZooKeeper源码深度解析：从核心算法到实战应用"></a>ZooKeeper源码深度解析：从核心算法到实战应用</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Apache ZooKeeper作为分布式协调服务的事实标准，在大数据生态系统中扮演着至关重要的角色。本文将深入剖析ZooKeeper的核心源码，重点分析其关键算法和机制，并结合实际应用场景提供实战指导。</p>
<h2 id="一、ZooKeeper架构概览"><a href="#一、ZooKeeper架构概览" class="headerlink" title="一、ZooKeeper架构概览"></a>一、ZooKeeper架构概览</h2><h3 id="1-1-整体架构"><a href="#1-1-整体架构" class="headerlink" title="1.1 整体架构"></a>1.1 整体架构</h3><p>ZooKeeper采用主从架构，集群中包含一个Leader和多个Follower&#x2F;Observer节点。</p>
<p><img src="/blog/images/zookeeper/arti/zookeeper%E9%9B%86%E7%BE%A4.png" alt="服务器状态转换图"></p>
<p>核心组件包括：</p>
<ul>
<li><strong>ServerCnxnFactory</strong>: 网络连接管理器</li>
<li><strong>ZooKeeperServer</strong>: 核心服务器实现</li>
<li><strong>DataTree</strong>: 内存数据结构</li>
<li><strong>FileTxnLog</strong>: 事务日志</li>
<li><strong>FileTxnSnapLog</strong>: 快照和日志管理</li>
</ul>
<h3 id="1-2-关键数据结构"><a href="#1-2-关键数据结构" class="headerlink" title="1.2 关键数据结构"></a>1.2 关键数据结构</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * DataTree是ZooKeeper内存数据结构的核心类</span></span><br><span class="line"><span class="comment"> * 维护了所有节点的树形结构和监听器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataTree</span> &#123;</span><br><span class="line">    <span class="comment">// 存储所有节点的映射表，key为节点路径，value为节点数据</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, DataNode&gt; nodes;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 数据变化监听器管理器</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WatchManager dataWatches;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 子节点变化监听器  </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WatchManager childWatches;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 最后处理的事务ID，用于保证事务的顺序性</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">long</span> <span class="variable">lastProcessedZxid</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * DataNode表示ZooKeeper中的一个节点</span></span><br><span class="line"><span class="comment"> * 包含节点数据、ACL权限、统计信息和子节点集合</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataNode</span> <span class="keyword">implements</span> <span class="title class_">Record</span> &#123;</span><br><span class="line">    <span class="comment">// 节点存储的实际数据</span></span><br><span class="line">    <span class="type">byte</span> data[];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 节点的访问控制列表ID</span></span><br><span class="line">    Long acl;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 节点的统计信息（创建时间、修改时间、版本等）</span></span><br><span class="line">    <span class="keyword">public</span> StatPersisted stat;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 子节点名称集合</span></span><br><span class="line">    <span class="keyword">private</span> Set&lt;String&gt; children = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-ZooKeeper服务器组件架构"><a href="#1-3-ZooKeeper服务器组件架构" class="headerlink" title="1.3 ZooKeeper服务器组件架构"></a>1.3 ZooKeeper服务器组件架构</h3><p><img src="/blog/images/zookeeper/arti/zookeeper%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BB%84%E4%BB%B6%E6%9E%B6%E6%9E%84.png" alt="zookeeper服务器组件架构"></p>
<h2 id="二、ZAB协议核心算法分析"><a href="#二、ZAB协议核心算法分析" class="headerlink" title="二、ZAB协议核心算法分析"></a>二、ZAB协议核心算法分析</h2><h3 id="2-1-ZAB协议概述"><a href="#2-1-ZAB协议概述" class="headerlink" title="2.1 ZAB协议概述"></a>2.1 ZAB协议概述</h3><p>ZAB（ZooKeeper Atomic Broadcast）协议是ZooKeeper的核心共识算法，确保分布式环境下的数据一致性。</p>
<p><img src="/blog/images/zookeeper/arti/Leader%E9%80%89%E4%B8%BE%E7%AE%97%E6%B3%95.png" alt="Leader选举算法"></p>
<h3 id="2-2-Leader选举算法"><a href="#2-2-Leader选举算法" class="headerlink" title="2.2 Leader选举算法"></a>2.2 Leader选举算法</h3><h4 id="2-2-1-FastLeaderElection实现"><a href="#2-2-1-FastLeaderElection实现" class="headerlink" title="2.2.1 FastLeaderElection实现"></a>2.2.1 FastLeaderElection实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FastLeaderElection</span> <span class="keyword">implements</span> <span class="title class_">Election</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 核心选举逻辑</span></span><br><span class="line"><span class="comment">     * 使用改进的Paxos算法进行Leader选举</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 选举结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> InterruptedException 中断异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Vote <span class="title function_">lookForLeader</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 接收到的选票集合，key为服务器ID，value为选票</span></span><br><span class="line">        HashMap&lt;Long, Vote&gt; recvset = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Long, Vote&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 已经退出选举的服务器选票</span></span><br><span class="line">        HashMap&lt;Long, Vote&gt; outofelection = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Long, Vote&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 同步块：更新本地选举轮次和提议</span></span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="built_in">this</span>)&#123;</span><br><span class="line">            <span class="comment">// 递增逻辑时钟，开始新一轮选举</span></span><br><span class="line">            logicalclock.incrementAndGet();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 初始化自己的提议：投票给自己</span></span><br><span class="line">            <span class="comment">// 参数：服务器ID、最后日志的zxid、当前epoch</span></span><br><span class="line">            updateProposal(getInitId(), getInitLastLoggedZxid(), getPeerEpoch());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 向所有服务器发送选票通知</span></span><br><span class="line">        sendNotifications();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 选举主循环：持续到选出Leader或停止选举</span></span><br><span class="line">        <span class="keyword">while</span> ((self.getPeerState() == ServerState.LOOKING) &amp;&amp; (!stop)) &#123;</span><br><span class="line">            <span class="comment">// 从接收队列中获取选票通知，设置超时时间</span></span><br><span class="line">            <span class="type">Notification</span> <span class="variable">n</span> <span class="operator">=</span> recvqueue.poll(notTimeout, TimeUnit.MILLISECONDS);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (n == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 超时处理：检查消息是否已发送</span></span><br><span class="line">                <span class="keyword">if</span> (manager.haveDelivered()) &#123;</span><br><span class="line">                    <span class="comment">// 重新发送选票</span></span><br><span class="line">                    sendNotifications();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 重新连接所有服务器</span></span><br><span class="line">                    manager.connectAll();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 处理接收到的选票</span></span><br><span class="line">                <span class="comment">// 验证选票的有效性：发送者和Leader候选者都必须是合法的投票者</span></span><br><span class="line">                <span class="keyword">if</span> (validVoter(n.sid) &amp;&amp; validVoter(n.leader)) &#123;</span><br><span class="line">                    <span class="keyword">switch</span> (n.state) &#123;</span><br><span class="line">                        <span class="keyword">case</span> LOOKING:</span><br><span class="line">                            <span class="comment">// 处理来自LOOKING状态服务器的选票</span></span><br><span class="line">                            <span class="keyword">if</span> (n.electionEpoch &gt; logicalclock.get()) &#123;</span><br><span class="line">                                <span class="comment">// 收到更高轮次的选票，更新本地轮次</span></span><br><span class="line">                                logicalclock.set(n.electionEpoch);</span><br><span class="line">                                recvset.clear();</span><br><span class="line">                                </span><br><span class="line">                                <span class="comment">// 比较选票优先级，决定是否更新自己的提议</span></span><br><span class="line">                                <span class="keyword">if</span> (totalOrderPredicate(n.leader, n.zxid, n.peerEpoch,</span><br><span class="line">                                        getInitId(), getInitLastLoggedZxid(), getPeerEpoch())) &#123;</span><br><span class="line">                                    <span class="comment">// 对方选票优先级更高，更新为对方的提议</span></span><br><span class="line">                                    updateProposal(n.leader, n.zxid, n.peerEpoch);</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    <span class="comment">// 坚持自己的提议</span></span><br><span class="line">                                    updateProposal(getInitId(), getInitLastLoggedZxid(), getPeerEpoch());</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="comment">// 发送更新后的选票</span></span><br><span class="line">                                sendNotifications();</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (n.electionEpoch &lt; logicalclock.get()) &#123;</span><br><span class="line">                                <span class="comment">// 收到过期轮次的选票，忽略</span></span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="comment">// 相同轮次的选票处理</span></span><br><span class="line">                                <span class="keyword">if</span> (totalOrderPredicate(n.leader, n.zxid, n.peerEpoch,</span><br><span class="line">                                        proposedLeader, proposedZxid, proposedEpoch)) &#123;</span><br><span class="line">                                    updateProposal(n.leader, n.zxid, n.peerEpoch);</span><br><span class="line">                                    sendNotifications();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            </span><br><span class="line">                            <span class="comment">// 记录收到的选票</span></span><br><span class="line">                            recvset.put(n.sid, <span class="keyword">new</span> <span class="title class_">Vote</span>(n.leader, n.zxid, n.electionEpoch, n.peerEpoch));</span><br><span class="line">                            </span><br><span class="line">                            <span class="comment">// 检查是否达成选举结果</span></span><br><span class="line">                            <span class="keyword">if</span> (termPredicate(recvset, <span class="keyword">new</span> <span class="title class_">Vote</span>(proposedLeader, proposedZxid, </span><br><span class="line">                                    logicalclock.get(), proposedEpoch))) &#123;</span><br><span class="line">                                </span><br><span class="line">                                <span class="comment">// 验证选举结果的有效性</span></span><br><span class="line">                                <span class="keyword">while</span> ((n = recvqueue.poll(finalizeWait, TimeUnit.MILLISECONDS)) != <span class="literal">null</span>) &#123;</span><br><span class="line">                                    <span class="keyword">if</span> (totalOrderPredicate(n.leader, n.zxid, n.peerEpoch,</span><br><span class="line">                                            proposedLeader, proposedZxid, proposedEpoch)) &#123;</span><br><span class="line">                                        recvqueue.put(n);</span><br><span class="line">                                        <span class="keyword">break</span>;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                                </span><br><span class="line">                                <span class="keyword">if</span> (n == <span class="literal">null</span>) &#123;</span><br><span class="line">                                    <span class="comment">// 选举成功，设置最终状态</span></span><br><span class="line">                                    self.setPeerState((proposedLeader == self.getId()) ? </span><br><span class="line">                                            ServerState.LEADING : ServerState.FOLLOWING);</span><br><span class="line">                                    </span><br><span class="line">                                    <span class="type">Vote</span> <span class="variable">endVote</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Vote</span>(proposedLeader, proposedZxid, </span><br><span class="line">                                            logicalclock.get(), proposedEpoch);</span><br><span class="line">                                    leaveInstance(endVote);</span><br><span class="line">                                    <span class="keyword">return</span> endVote;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                            </span><br><span class="line">                        <span class="keyword">case</span> OBSERVING:</span><br><span class="line">                            <span class="comment">// Observer不参与选举，忽略</span></span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                            </span><br><span class="line">                        <span class="keyword">case</span> FOLLOWING:</span><br><span class="line">                        <span class="keyword">case</span> LEADING:</span><br><span class="line">                            <span class="comment">// 处理来自已确定状态服务器的选票</span></span><br><span class="line">                            <span class="keyword">if</span> (n.electionEpoch == logicalclock.get()) &#123;</span><br><span class="line">                                recvset.put(n.sid, <span class="keyword">new</span> <span class="title class_">Vote</span>(n.leader, n.zxid, n.electionEpoch, n.peerEpoch));</span><br><span class="line">                                </span><br><span class="line">                                <span class="keyword">if</span> (termPredicate(recvset, <span class="keyword">new</span> <span class="title class_">Vote</span>(n.leader, n.zxid, </span><br><span class="line">                                        n.electionEpoch, n.peerEpoch, n.state)) &amp;&amp; </span><br><span class="line">                                        checkLeader(outofelection, n.leader, n.electionEpoch)) &#123;</span><br><span class="line">                                    </span><br><span class="line">                                    self.setPeerState((n.leader == self.getId()) ? </span><br><span class="line">                                            ServerState.LEADING : ServerState.FOLLOWING);</span><br><span class="line">                                    </span><br><span class="line">                                    <span class="type">Vote</span> <span class="variable">endVote</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Vote</span>(n.leader, n.zxid, </span><br><span class="line">                                            n.electionEpoch, n.peerEpoch);</span><br><span class="line">                                    leaveInstance(endVote);</span><br><span class="line">                                    <span class="keyword">return</span> endVote;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            </span><br><span class="line">                            outofelection.put(n.sid, <span class="keyword">new</span> <span class="title class_">Vote</span>(n.leader, n.zxid, </span><br><span class="line">                                    n.electionEpoch, n.peerEpoch, n.state));</span><br><span class="line">                            </span><br><span class="line">                            <span class="keyword">if</span> (termPredicate(outofelection, <span class="keyword">new</span> <span class="title class_">Vote</span>(n.leader, n.zxid, </span><br><span class="line">                                    n.electionEpoch, n.peerEpoch, n.state)) &amp;&amp; </span><br><span class="line">                                    checkLeader(outofelection, n.leader, n.electionEpoch)) &#123;</span><br><span class="line">                                </span><br><span class="line">                                <span class="keyword">synchronized</span>(<span class="built_in">this</span>) &#123;</span><br><span class="line">                                    logicalclock.set(n.electionEpoch);</span><br><span class="line">                                    self.setPeerState((n.leader == self.getId()) ? </span><br><span class="line">                                            ServerState.LEADING : ServerState.FOLLOWING);</span><br><span class="line">                                &#125;</span><br><span class="line">                                </span><br><span class="line">                                <span class="type">Vote</span> <span class="variable">endVote</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Vote</span>(n.leader, n.zxid, </span><br><span class="line">                                        n.electionEpoch, n.peerEpoch);</span><br><span class="line">                                leaveInstance(endVote);</span><br><span class="line">                                <span class="keyword">return</span> endVote;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 选票比较逻辑 - 全序关系谓词</span></span><br><span class="line"><span class="comment">     * 比较两个选票的优先级，优先级高的选票会被选中</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * 比较顺序：</span></span><br><span class="line"><span class="comment">     * 1. epoch (选举轮次) - 越大越优先</span></span><br><span class="line"><span class="comment">     * 2. zxid (事务ID) - 越大越优先  </span></span><br><span class="line"><span class="comment">     * 3. myid (服务器ID) - 越大越优先</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newId 新选票的服务器ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newZxid 新选票的事务ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newEpoch 新选票的epoch</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> curId 当前选票的服务器ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> curZxid 当前选票的事务ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> curEpoch 当前选票的epoch</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true表示新选票优先级更高</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">totalOrderPredicate</span><span class="params">(<span class="type">long</span> newId, <span class="type">long</span> newZxid, <span class="type">long</span> newEpoch,</span></span><br><span class="line"><span class="params">            <span class="type">long</span> curId, <span class="type">long</span> curZxid, <span class="type">long</span> curEpoch)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 首先比较epoch，epoch大的优先</span></span><br><span class="line">        <span class="keyword">if</span> (newEpoch &gt; curEpoch) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newEpoch &lt; curEpoch) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// epoch相同，比较zxid，zxid大的优先（数据更新）</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (newZxid &gt; curZxid) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newZxid &lt; curZxid) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// epoch和zxid都相同，比较服务器ID，ID大的优先</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (newId &gt; curId) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 检查是否达到选举终止条件</span></span><br><span class="line"><span class="comment">     * 需要获得超过半数服务器的投票支持</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> votes 收到的选票集合</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> vote 候选选票</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true表示达到终止条件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">termPredicate</span><span class="params">(HashMap&lt;Long, Vote&gt; votes, Vote vote)</span> &#123;</span><br><span class="line">        HashSet&lt;Long&gt; set = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Long&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 统计支持该候选者的服务器数量</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;Long, Vote&gt; entry : votes.entrySet()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (vote.equals(entry.getValue())) &#123;</span><br><span class="line">                set.add(entry.getKey());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检查是否超过半数</span></span><br><span class="line">        <span class="keyword">return</span> self.getQuorumVerifier().containsQuorum(set);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-2-选举算法流程图"><a href="#2-2-2-选举算法流程图" class="headerlink" title="2.2.2 选举算法流程图"></a>2.2.2 选举算法流程图</h4><p><img src="/blog/images/zookeeper/arti/%E9%80%89%E4%B8%BE%E7%AE%97%E6%B3%95%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="选举算法流程图"></p>
<h4 id="2-2-3-选举算法核心要点"><a href="#2-2-3-选举算法核心要点" class="headerlink" title="2.2.3 选举算法核心要点"></a>2.2.3 选举算法核心要点</h4><ol>
<li><strong>三元组比较</strong>: (epoch, zxid, myid) - 确保选出数据最新且ID最大的服务器</li>
<li><strong>过半机制</strong>: 需要获得超过半数节点的投票 - 防止脑裂问题</li>
<li><strong>数据最新性</strong>: 优先选择拥有最新数据的节点 - 保证数据一致性</li>
</ol>
<h3 id="2-3-数据同步机制"><a href="#2-3-数据同步机制" class="headerlink" title="2.3 数据同步机制"></a>2.3 数据同步机制</h3><h4 id="2-3-1-Leader数据同步流程"><a href="#2-3-1-Leader数据同步流程" class="headerlink" title="2.3.1 Leader数据同步流程"></a>2.3.1 Leader数据同步流程</h4><p><img src="/blog/images/zookeeper/arti/Leader%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E6%B5%81%E7%A8%8B.png" alt="Leader数据同步流程"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LearnerHandler</span> <span class="keyword">extends</span> <span class="title class_">ZooKeeperThread</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步数据到Follower</span></span><br><span class="line"><span class="comment">     * 根据Follower的数据状态选择合适的同步策略</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> peerLastZxid Follower的最后事务ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> leader Leader实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">syncFollower</span><span class="params">(<span class="type">long</span> peerLastZxid, LearnerMaster leader)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">needSnap</span> <span class="operator">=</span> <span class="literal">true</span>;  <span class="comment">// 是否需要快照同步</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获取Leader的关键状态信息</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">lastLoggedZxid</span> <span class="operator">=</span> leader.getLastLoggedZxid();        <span class="comment">// Leader最后记录的事务ID</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">leaderLastCommitted</span> <span class="operator">=</span> leader.getLastCommitted();    <span class="comment">// Leader最后提交的事务ID</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 判断同步方式的决策逻辑</span></span><br><span class="line">        <span class="keyword">if</span> (peerLastZxid == leaderLastCommitted) &#123;</span><br><span class="line">            <span class="comment">// 情况1：数据已同步</span></span><br><span class="line">            <span class="comment">// Follower的数据与Leader完全一致，无需同步</span></span><br><span class="line">            LOG.info(<span class="string">&quot;Peer is already sync with leader, lastZxid: &#123;&#125;&quot;</span>, peerLastZxid);</span><br><span class="line">            needSnap = <span class="literal">false</span>;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (peerLastZxid &gt; leaderLastCommitted) &#123;</span><br><span class="line">            <span class="comment">// 情况2：Follower数据比Leader新，需要回滚</span></span><br><span class="line">            <span class="comment">// 这种情况发生在Leader切换时，新Leader可能没有旧Leader的部分数据</span></span><br><span class="line">            LOG.warn(<span class="string">&quot;Peer has newer data than leader, need truncate. &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;peerLastZxid: &#123;&#125;, leaderLastCommitted: &#123;&#125;&quot;</span>, </span><br><span class="line">                    peerLastZxid, leaderLastCommitted);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 发送TRUNC命令，让Follower回滚到Leader的提交点</span></span><br><span class="line">            <span class="type">QuorumPacket</span> <span class="variable">qp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QuorumPacket</span>(Leader.TRUNC, leaderLastCommitted, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            writePacket(qp, <span class="literal">true</span>);</span><br><span class="line">            needSnap = <span class="literal">true</span>;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 情况3：Follower数据落后，需要同步</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">minCommittedLog</span> <span class="operator">=</span> leader.getMinCommittedLog();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (peerLastZxid &gt;= minCommittedLog) &#123;</span><br><span class="line">                <span class="comment">// 情况3a：可以通过DIFF增量同步</span></span><br><span class="line">                <span class="comment">// Follower的数据在Leader的事务日志范围内，可以增量同步</span></span><br><span class="line">                LOG.info(<span class="string">&quot;Using DIFF sync for peer, peerLastZxid: &#123;&#125;, minCommittedLog: &#123;&#125;&quot;</span>, </span><br><span class="line">                        peerLastZxid, minCommittedLog);</span><br><span class="line">                </span><br><span class="line">                needSnap = <span class="literal">false</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 发送DIFF命令</span></span><br><span class="line">                <span class="type">QuorumPacket</span> <span class="variable">qp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QuorumPacket</span>(Leader.DIFF, peerLastZxid, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">                writePacket(qp, <span class="literal">true</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 发送差异事务数据</span></span><br><span class="line">                queueCommittedProposals(leader, peerLastZxid, <span class="literal">null</span>);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 情况3b：需要全量快照同步</span></span><br><span class="line">                <span class="comment">// Follower的数据太旧，已经超出了Leader的事务日志范围</span></span><br><span class="line">                LOG.info(<span class="string">&quot;Using SNAP sync for peer, peerLastZxid: &#123;&#125;, minCommittedLog: &#123;&#125;&quot;</span>, </span><br><span class="line">                        peerLastZxid, minCommittedLog);</span><br><span class="line">                </span><br><span class="line">                needSnap = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 执行快照同步</span></span><br><span class="line">        <span class="keyword">if</span> (needSnap) &#123;</span><br><span class="line">            <span class="comment">// 使用快照限流器防止过多的快照传输影响性能</span></span><br><span class="line">            leader.getLearnerSnapshotThrottler().beginSnapshot();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 获取当前数据树的最新状态</span></span><br><span class="line">                <span class="type">long</span> <span class="variable">zxidToSend</span> <span class="operator">=</span> leader.getZKDatabase().getDataTreeLastProcessedZxid();</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 发送SNAP命令头</span></span><br><span class="line">                <span class="type">QuorumPacket</span> <span class="variable">snapPacket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QuorumPacket</span>(Leader.SNAP, zxidToSend, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">                writePacket(snapPacket, <span class="literal">true</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 序列化并发送完整的数据快照</span></span><br><span class="line">                <span class="comment">// 包括所有节点数据、ACL信息、会话信息等</span></span><br><span class="line">                <span class="type">BufferedOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(sock.getOutputStream());</span><br><span class="line">                <span class="type">BinaryOutputArchive</span> <span class="variable">boa</span> <span class="operator">=</span> BinaryOutputArchive.getArchive(bos);</span><br><span class="line">                </span><br><span class="line">                leader.getZKDatabase().serializeSnapshot(boa);</span><br><span class="line">                bos.flush();</span><br><span class="line">                </span><br><span class="line">                LOG.info(<span class="string">&quot;Snapshot sent to peer, zxid: &#123;&#125;&quot;</span>, zxidToSend);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// 释放快照限流器</span></span><br><span class="line">                leader.getLearnerSnapshotThrottler().endSnapshot();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 发送NEWLEADER命令，标识同步完成</span></span><br><span class="line">        <span class="type">QuorumPacket</span> <span class="variable">newLeaderPacket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QuorumPacket</span>(Leader.NEWLEADER, </span><br><span class="line">                leader.getZKDatabase().getDataTreeLastProcessedZxid(), <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        writePacket(newLeaderPacket, <span class="literal">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 等待Follower确认</span></span><br><span class="line">        <span class="type">QuorumPacket</span> <span class="variable">ack</span> <span class="operator">=</span> readPacket();</span><br><span class="line">        <span class="keyword">if</span> (ack.getType() != Leader.ACK) &#123;</span><br><span class="line">            LOG.error(<span class="string">&quot;Expected ACK from peer, but got: &#123;&#125;&quot;</span>, ack.getType());</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 同步完成，Follower可以开始正常服务</span></span><br><span class="line">        LOG.info(<span class="string">&quot;Peer sync completed successfully&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 队列化已提交的提议</span></span><br><span class="line"><span class="comment">     * 将指定zxid之后的所有已提交事务发送给Follower</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> leader Leader实例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> peerLastZxid Follower的最后事务ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> maxZxid 最大事务ID限制</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">queueCommittedProposals</span><span class="params">(LearnerMaster leader, <span class="type">long</span> peerLastZxid, Long maxZxid)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isPeerNewEpochZxid</span> <span class="operator">=</span> (peerLastZxid &amp; <span class="number">0xffffffffL</span>) == <span class="number">0</span>;</span><br><span class="line">        <span class="type">long</span> <span class="variable">currentZxid</span> <span class="operator">=</span> peerLastZxid;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">needCommit</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 遍历Leader的提议队列</span></span><br><span class="line">        <span class="keyword">synchronized</span> (leader.getProposalStats()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Proposal p : leader.getProposalStats().getCommittedProposals()) &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">packetZxid</span> <span class="operator">=</span> p.packet.getZxid();</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 跳过已经处理过的事务</span></span><br><span class="line">                <span class="keyword">if</span> (packetZxid &lt;= peerLastZxid) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 检查最大zxid限制</span></span><br><span class="line">                <span class="keyword">if</span> (maxZxid != <span class="literal">null</span> &amp;&amp; packetZxid &gt; maxZxid) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 发送提议数据</span></span><br><span class="line">                writePacket(p.packet, <span class="literal">false</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 发送提交命令</span></span><br><span class="line">                <span class="type">QuorumPacket</span> <span class="variable">commitPacket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QuorumPacket</span>(Leader.COMMIT, packetZxid, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">                writePacket(commitPacket, <span class="literal">false</span>);</span><br><span class="line">                </span><br><span class="line">                currentZxid = packetZxid;</span><br><span class="line">                needCommit = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (needCommit) &#123;</span><br><span class="line">            <span class="comment">// 刷新输出缓冲区，确保所有数据都发送出去</span></span><br><span class="line">            flushBuffer();</span><br><span class="line">            LOG.info(<span class="string">&quot;Queued committed proposals from &#123;&#125; to &#123;&#125;&quot;</span>, peerLastZxid, currentZxid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="三、事务处理机制"><a href="#三、事务处理机制" class="headerlink" title="三、事务处理机制"></a>三、事务处理机制</h2><h3 id="3-1-事务处理流程"><a href="#3-1-事务处理流程" class="headerlink" title="3.1 事务处理流程"></a>3.1 事务处理流程</h3><p><img src="/blog/images/zookeeper/arti/%E4%BA%8B%E5%8A%A1%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B.png" alt="事务处理流程"></p>
<h3 id="3-2-事务日志实现"><a href="#3-2-事务日志实现" class="headerlink" title="3.2 事务日志实现"></a>3.2 事务日志实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileTxnLog</span> <span class="keyword">implements</span> <span class="title class_">TxnLog</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 事务日志魔数，用于文件格式验证</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">TXNLOG_MAGIC</span> <span class="operator">=</span> ByteBuffer.wrap(<span class="string">&quot;ZKLG&quot;</span>.getBytes()).getInt();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 日志文件版本号</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">VERSION</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 预分配文件大小，减少频繁的文件扩展</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">preAllocSize</span> <span class="operator">=</span> <span class="number">65536</span> * <span class="number">1024</span>;  <span class="comment">// 64MB</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 写入事务日志</span></span><br><span class="line"><span class="comment">     * 这是ZooKeeper持久化的核心方法，确保事务的持久性</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> hdr 事务头，包含zxid、时间戳、会话ID等</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> txn 事务体，包含具体的操作内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 写入是否成功</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException IO异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">append</span><span class="params">(TxnHeader hdr, Record txn)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">if</span> (hdr == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 验证事务ID的单调递增性，这是ZooKeeper一致性的关键保证</span></span><br><span class="line">        <span class="keyword">if</span> (hdr.getZxid() &lt;= lastZxidSeen) &#123;</span><br><span class="line">            LOG.warn(<span class="string">&quot;Current zxid &#123;&#125; is &lt;= &#123;&#125; for &#123;&#125;&quot;</span>, </span><br><span class="line">                    hdr.getZxid(), lastZxidSeen, hdr.getType());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            lastZxidSeen = hdr.getZxid();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检查是否需要创建新的日志文件</span></span><br><span class="line">        <span class="keyword">if</span> (logStream == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (LOG.isInfoEnabled()) &#123;</span><br><span class="line">                LOG.info(<span class="string">&quot;Creating new log file: &#123;&#125;&quot;</span>, Util.makeLogName(hdr.getZxid()));</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 基于zxid创建新的日志文件</span></span><br><span class="line">            logFileWrite = <span class="keyword">new</span> <span class="title class_">File</span>(logDir, Util.makeLogName(hdr.getZxid()));</span><br><span class="line">            fos = <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(logFileWrite);</span><br><span class="line">            logStream = <span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(fos);</span><br><span class="line">            oa = BinaryOutputArchive.getArchive(logStream);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 写入文件头信息</span></span><br><span class="line">            <span class="type">FileHeader</span> <span class="variable">fhdr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileHeader</span>(TXNLOG_MAGIC, VERSION, dbId);</span><br><span class="line">            fhdr.serialize(oa, <span class="string">&quot;fileheader&quot;</span>);</span><br><span class="line">            logStream.flush();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 预分配文件空间，提高写入性能</span></span><br><span class="line">        padFile(fos);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 序列化事务数据</span></span><br><span class="line">        <span class="type">byte</span>[] buf = Util.marshallTxnEntry(hdr, txn);</span><br><span class="line">        <span class="keyword">if</span> (buf == <span class="literal">null</span> || buf.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;Faulty serialization for header and txn&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 计算并写入校验和，确保数据完整性</span></span><br><span class="line">        <span class="type">Checksum</span> <span class="variable">crc</span> <span class="operator">=</span> makeChecksumAlgorithm();</span><br><span class="line">        crc.update(buf, <span class="number">0</span>, buf.length);</span><br><span class="line">        oa.writeLong(crc.getValue(), <span class="string">&quot;txnEntryCRC&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 写入事务数据</span></span><br><span class="line">        Util.writeTxnBytes(oa, buf);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 预分配文件空间</span></span><br><span class="line"><span class="comment">     * 通过预分配避免频繁的文件系统调用，提高性能</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file 文件输出流</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException IO异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">padFile</span><span class="params">(FileOutputStream file)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">newFileSize</span> <span class="operator">=</span> file.getChannel().position() + preAllocSize;</span><br><span class="line">        <span class="type">long</span> <span class="variable">currentFileSize</span> <span class="operator">=</span> file.getChannel().size();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (currentFileSize &lt; newFileSize) &#123;</span><br><span class="line">            <span class="comment">// 使用文件洞(file hole)技术预分配空间</span></span><br><span class="line">            <span class="comment">// 这样可以避免实际写入大量零字节</span></span><br><span class="line">            file.getChannel().write((ByteBuffer) ByteBuffer.allocate(<span class="number">1</span>).put((<span class="type">byte</span>) <span class="number">0</span>).flip(), </span><br><span class="line">                    newFileSize - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建校验和算法</span></span><br><span class="line"><span class="comment">     * 使用Adler32算法，比CRC32更快但安全性略低</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 校验和算法实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Checksum <span class="title function_">makeChecksumAlgorithm</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Adler32</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同步日志到磁盘</span></span><br><span class="line"><span class="comment">     * 确保日志数据真正写入持久化存储</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException IO异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">commit</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">if</span> (logStream != <span class="literal">null</span>) &#123;</span><br><span class="line">            logStream.flush();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (fos != <span class="literal">null</span>) &#123;</span><br><span class="line">            fos.getFD().sync();  <span class="comment">// 强制同步到磁盘</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭日志文件</span></span><br><span class="line"><span class="comment">     * 清理资源并确保数据完整性</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException IO异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">if</span> (logStream != <span class="literal">null</span>) &#123;</span><br><span class="line">            logStream.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (fos != <span class="literal">null</span>) &#123;</span><br><span class="line">            fos.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 读取事务日志</span></span><br><span class="line"><span class="comment">     * 用于故障恢复和数据同步</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> zxid 起始事务ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 事务迭代器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException IO异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> TxnIterator <span class="title function_">read</span><span class="params">(<span class="type">long</span> zxid)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FileTxnIterator</span>(logDir, zxid);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取最后一个事务ID</span></span><br><span class="line"><span class="comment">     * 用于确定日志的最新状态</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 最后的事务ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException IO异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getLastLoggedZxid</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        File[] files = getLogFiles(logDir.listFiles(), <span class="number">0</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">maxLog</span> <span class="operator">=</span> files.length &gt; <span class="number">0</span> ? Util.getZxidFromName(files[files.length - <span class="number">1</span>].getName(), <span class="string">&quot;log&quot;</span>) : -<span class="number">1</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 从最新的日志文件中读取最后一个事务ID</span></span><br><span class="line">        <span class="keyword">if</span> (maxLog &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">TxnIterator</span> <span class="variable">itr</span> <span class="operator">=</span> read(maxLog);</span><br><span class="line">            <span class="type">long</span> <span class="variable">lastZxid</span> <span class="operator">=</span> maxLog;</span><br><span class="line">            <span class="keyword">while</span> (itr.next()) &#123;</span><br><span class="line">                <span class="type">TxnHeader</span> <span class="variable">hdr</span> <span class="operator">=</span> itr.getHeader();</span><br><span class="line">                lastZxid = hdr.getZxid();</span><br><span class="line">            &#125;</span><br><span class="line">            itr.close();</span><br><span class="line">            <span class="keyword">return</span> lastZxid;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-快照机制"><a href="#3-3-快照机制" class="headerlink" title="3.3 快照机制"></a>3.3 快照机制</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileSnap</span> <span class="keyword">implements</span> <span class="title class_">SnapShot</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 快照文件魔数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">SNAP_MAGIC</span> <span class="operator">=</span> ByteBuffer.wrap(<span class="string">&quot;ZKSN&quot;</span>.getBytes()).getInt();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 序列化快照</span></span><br><span class="line"><span class="comment">     * 将内存中的数据树和会话信息持久化到磁盘</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dt 数据树</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sessions 会话映射</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> oa 输出归档</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> header 文件头</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException IO异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(DataTree dt, Map&lt;Long, Integer&gt; sessions, </span></span><br><span class="line"><span class="params">            OutputArchive oa, FileHeader header)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 写入文件头信息</span></span><br><span class="line">        header.serialize(oa, <span class="string">&quot;fileheader&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 序列化会话信息</span></span><br><span class="line">        <span class="comment">// 会话信息包括会话ID和超时时间</span></span><br><span class="line">        SerializeUtils.serializeSnapshot(dt, oa, sessions);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 写入结束标记，用于验证快照完整性</span></span><br><span class="line">        oa.writeString(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;path&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        LOG.info(<span class="string">&quot;Snapshot serialization completed, zxid: &#123;&#125;&quot;</span>, header.getLastZxid());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 反序列化快照</span></span><br><span class="line"><span class="comment">     * 从磁盘加载快照数据到内存</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dt 数据树</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sessions 会话映射</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ia 输入归档</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 快照的最后事务ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException IO异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">deserialize</span><span class="params">(DataTree dt, Map&lt;Long, Integer&gt; sessions, </span></span><br><span class="line"><span class="params">            InputArchive ia)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 读取并验证文件头</span></span><br><span class="line">        <span class="type">FileHeader</span> <span class="variable">header</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileHeader</span>();</span><br><span class="line">        header.deserialize(ia, <span class="string">&quot;fileheader&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (header.getMagic() != SNAP_MAGIC) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;mismatched magic headers &quot;</span> + header.getMagic() + </span><br><span class="line">                    <span class="string">&quot; != &quot;</span> + FileSnap.SNAP_MAGIC);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 反序列化数据树和会话信息</span></span><br><span class="line">        SerializeUtils.deserializeSnapshot(dt, ia, sessions);</span><br><span class="line">        </span><br><span class="line">        LOG.info(<span class="string">&quot;Snapshot deserialization completed, zxid: &#123;&#125;&quot;</span>, header.getLastZxid());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> header.getLastZxid();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查找最新的快照文件</span></span><br><span class="line"><span class="comment">     * 用于故障恢复时确定最新的数据状态</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> snapDir 快照目录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 最新快照文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> File <span class="title function_">findMostRecentSnapshot</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        File[] files = snapDir.listFiles();</span><br><span class="line">        <span class="keyword">if</span> (files == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        List&lt;File&gt; validFiles = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (File f : files) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Util.isValidSnapshot(f)) &#123;</span><br><span class="line">                validFiles.add(f);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (validFiles.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 按zxid排序，选择最新的</span></span><br><span class="line">        validFiles.sort((f1, f2) -&gt; &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">zxid1</span> <span class="operator">=</span> Util.getZxidFromName(f1.getName(), <span class="string">&quot;snapshot&quot;</span>);</span><br><span class="line">            <span class="type">long</span> <span class="variable">zxid2</span> <span class="operator">=</span> Util.getZxidFromName(f2.getName(), <span class="string">&quot;snapshot&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> Long.compare(zxid1, zxid2);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> validFiles.get(validFiles.size() - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="四、Watch机制源码解析"><a href="#四、Watch机制源码解析" class="headerlink" title="四、Watch机制源码解析"></a>四、Watch机制源码解析</h2><h3 id="4-1-Watch机制架构"><a href="#4-1-Watch机制架构" class="headerlink" title="4.1 Watch机制架构"></a>4.1 Watch机制架构</h3><p><img src="/blog/images/zookeeper/arti/Watch%E6%9C%BA%E5%88%B6%E6%9E%B6%E6%9E%84.png" alt="Watch机制架构.png"></p>
<h3 id="4-2-Watch管理器实现"><a href="#4-2-Watch管理器实现" class="headerlink" title="4.2 Watch管理器实现"></a>4.2 Watch管理器实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WatchManager</span> &#123;</span><br><span class="line">    <span class="comment">// 路径到监听器的映射表：一个路径可能有多个监听器</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String, HashSet&lt;Watcher&gt;&gt; watchTable = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 监听器到路径的映射表：一个监听器可能监听多个路径</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;Watcher, HashSet&lt;String&gt;&gt; watch2Paths = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加Watch监听器</span></span><br><span class="line"><span class="comment">     * 建立路径与监听器的双向映射关系</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> path 监听的路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> watcher 监听器实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">addWatch</span><span class="params">(String path, Watcher watcher)</span> &#123;</span><br><span class="line">        <span class="comment">// 在路径映射表中添加监听器</span></span><br><span class="line">        HashSet&lt;Watcher&gt; list = watchTable.get(path);</span><br><span class="line">        <span class="keyword">if</span> (list == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 初始容量设为4，平衡内存使用和性能</span></span><br><span class="line">            list = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Watcher&gt;(<span class="number">4</span>);</span><br><span class="line">            watchTable.put(path, list);</span><br><span class="line">        &#125;</span><br><span class="line">        list.add(watcher);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 在监听器映射表中添加路径</span></span><br><span class="line">        HashSet&lt;String&gt; paths = watch2Paths.get(watcher);</span><br><span class="line">        <span class="keyword">if</span> (paths == <span class="literal">null</span>) &#123;</span><br><span class="line">            paths = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;String&gt;();</span><br><span class="line">            watch2Paths.put(watcher, paths);</span><br><span class="line">        &#125;</span><br><span class="line">        paths.add(path);</span><br><span class="line">        </span><br><span class="line">        LOG.debug(<span class="string">&quot;Added watch for path: &#123;&#125;, watcher: &#123;&#125;&quot;</span>, path, watcher);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 触发Watch事件</span></span><br><span class="line"><span class="comment">     * 当数据发生变化时，通知相关的监听器</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> path 发生变化的路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type 事件类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 被触发的监听器集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Set&lt;Watcher&gt; <span class="title function_">triggerWatch</span><span class="params">(String path, EventType type)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> triggerWatch(path, type, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 触发Watch事件（带抑制列表）</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> path 发生变化的路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type 事件类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> supress 需要抑制的监听器集合</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 被触发的监听器集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Set&lt;Watcher&gt; <span class="title function_">triggerWatch</span><span class="params">(String path, EventType type, Set&lt;Watcher&gt; supress)</span> &#123;</span><br><span class="line">        <span class="comment">// 创建Watch事件对象</span></span><br><span class="line">        <span class="type">WatchedEvent</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WatchedEvent</span>(type, KeeperState.SyncConnected, path);</span><br><span class="line">        HashSet&lt;Watcher&gt; watchers;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            <span class="comment">// 从映射表中移除并获取监听器</span></span><br><span class="line">            <span class="comment">// Watch是一次性的，触发后即删除</span></span><br><span class="line">            watchers = watchTable.remove(path);</span><br><span class="line">            <span class="keyword">if</span> (watchers == <span class="literal">null</span> || watchers.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">                    LOG.trace(<span class="string">&quot;No watchers for path: &#123;&#125;&quot;</span>, path);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 清理反向映射</span></span><br><span class="line">            <span class="keyword">for</span> (Watcher w : watchers) &#123;</span><br><span class="line">                HashSet&lt;String&gt; paths = watch2Paths.get(w);</span><br><span class="line">                <span class="keyword">if</span> (paths != <span class="literal">null</span>) &#123;</span><br><span class="line">                    paths.remove(path);</span><br><span class="line">                    <span class="comment">// 如果监听器不再监听任何路径，则完全移除</span></span><br><span class="line">                    <span class="keyword">if</span> (paths.isEmpty()) &#123;</span><br><span class="line">                        watch2Paths.remove(w);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 异步通知所有监听器</span></span><br><span class="line">        <span class="keyword">for</span> (Watcher w : watchers) &#123;</span><br><span class="line">            <span class="comment">// 检查是否在抑制列表中</span></span><br><span class="line">            <span class="keyword">if</span> (supress != <span class="literal">null</span> &amp;&amp; supress.contains(w)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 调用监听器的处理方法</span></span><br><span class="line">                w.process(e);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                LOG.error(<span class="string">&quot;Error processing watcher for path: &#123;&#125;&quot;</span>, path, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        LOG.debug(<span class="string">&quot;Triggered &#123;&#125; watchers for path: &#123;&#125;, event: &#123;&#125;&quot;</span>, </span><br><span class="line">                watchers.size(), path, type);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> watchers;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 移除指定路径的所有监听器</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> path 路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 被移除的监听器集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> Set&lt;Watcher&gt; <span class="title function_">removeWatches</span><span class="params">(String path)</span> &#123;</span><br><span class="line">        HashSet&lt;Watcher&gt; watchers = watchTable.remove(path);</span><br><span class="line">        <span class="keyword">if</span> (watchers != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Watcher w : watchers) &#123;</span><br><span class="line">                HashSet&lt;String&gt; paths = watch2Paths.get(w);</span><br><span class="line">                <span class="keyword">if</span> (paths != <span class="literal">null</span>) &#123;</span><br><span class="line">                    paths.remove(path);</span><br><span class="line">                    <span class="keyword">if</span> (paths.isEmpty()) &#123;</span><br><span class="line">                        watch2Paths.remove(w);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> watchers;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 移除指定监听器的所有路径</span></span><br><span class="line"><span class="comment">     * 通常在客户端断开连接时调用</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> watcher 监听器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 被移除的路径集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> Set&lt;String&gt; <span class="title function_">removeWatcher</span><span class="params">(Watcher watcher)</span> &#123;</span><br><span class="line">        HashSet&lt;String&gt; paths = watch2Paths.remove(watcher);</span><br><span class="line">        <span class="keyword">if</span> (paths != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String path : paths) &#123;</span><br><span class="line">                HashSet&lt;Watcher&gt; watchers = watchTable.get(path);</span><br><span class="line">                <span class="keyword">if</span> (watchers != <span class="literal">null</span>) &#123;</span><br><span class="line">                    watchers.remove(watcher);</span><br><span class="line">                    <span class="keyword">if</span> (watchers.isEmpty()) &#123;</span><br><span class="line">                        watchTable.remove(path);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> paths;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取监听器统计信息</span></span><br><span class="line"><span class="comment">     * 用于监控和调试</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 统计信息字符串</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        sb.append(<span class="string">&quot;WatchManager Stats:\n&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;  Total paths watched: &quot;</span>).append(watchTable.size()).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;  Total watchers: &quot;</span>).append(watch2Paths.size()).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> <span class="variable">totalWatches</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (HashSet&lt;Watcher&gt; watchers : watchTable.values()) &#123;</span><br><span class="line">            totalWatches += watchers.size();</span><br><span class="line">        &#125;</span><br><span class="line">        sb.append(<span class="string">&quot;  Total watch registrations: &quot;</span>).append(totalWatches).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 清理所有监听器</span></span><br><span class="line"><span class="comment">     * 通常在服务器关闭时调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span> &#123;</span><br><span class="line">        watchTable.clear();</span><br><span class="line">        watch2Paths.clear();</span><br><span class="line">        LOG.info(<span class="string">&quot;All watchers cleared&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-Watch事件处理流程"><a href="#4-3-Watch事件处理流程" class="headerlink" title="4.3 Watch事件处理流程"></a>4.3 Watch事件处理流程</h3><p><img src="/blog/images/zookeeper/arti/Watch%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B.png" alt="Watch事件处理流程.png"></p>
<h3 id="4-4-Watch事件处理实现"><a href="#4-4-Watch事件处理实现" class="headerlink" title="4.4 Watch事件处理实现"></a>4.4 Watch事件处理实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NIOServerCnxn</span> <span class="keyword">extends</span> <span class="title class_">ServerCnxn</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 输出缓冲区，用于批量发送数据</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ByteBuffer</span> <span class="variable">outgoingBuffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">40960</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 是否已初始化</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">initialized</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理Watch事件</span></span><br><span class="line"><span class="comment">     * 将事件转换为网络消息发送给客户端</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> event Watch事件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(WatchedEvent event)</span> &#123;</span><br><span class="line">        <span class="comment">// 构造响应头，Watch事件的xid为-1</span></span><br><span class="line">        <span class="type">ReplyHeader</span> <span class="variable">h</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReplyHeader</span>(-<span class="number">1</span>, -<span class="number">1L</span>, <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">            LOG.trace(<span class="string">&quot;Delivering watch event to client: &#123;&#125;, event: &#123;&#125;&quot;</span>, </span><br><span class="line">                    getRemoteSocketAddress(), event);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 将WatchedEvent转换为网络传输格式</span></span><br><span class="line">        <span class="type">WatcherEvent</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WatcherEvent</span>(</span><br><span class="line">                event.getType().getIntValue(),      <span class="comment">// 事件类型</span></span><br><span class="line">                event.getState().getIntValue(),     <span class="comment">// 连接状态</span></span><br><span class="line">                event.getPath()                     <span class="comment">// 事件路径</span></span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 发送事件响应</span></span><br><span class="line">        sendResponse(h, e, <span class="string">&quot;notification&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送响应消息</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> h 响应头</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> r 响应体</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tag 日志标签</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendResponse</span><span class="params">(ReplyHeader h, Record r, String tag)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 序列化响应数据</span></span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            <span class="type">BinaryOutputArchive</span> <span class="variable">bos</span> <span class="operator">=</span> BinaryOutputArchive.getArchive(baos);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                baos.write(<span class="string">&quot;mntr&quot;</span>.getBytes());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                LOG.error(<span class="string">&quot;Error writing magic number&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            bos.writeRecord(h, <span class="string">&quot;header&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (r != <span class="literal">null</span>) &#123;</span><br><span class="line">                bos.writeRecord(r, tag);</span><br><span class="line">            &#125;</span><br><span class="line">            baos.close();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 获取序列化后的数据</span></span><br><span class="line">            <span class="type">byte</span>[] data = baos.toByteArray();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!initialized) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 写入长度前缀</span></span><br><span class="line">                outgoingBuffer.putInt(data.length);</span><br><span class="line">                outgoingBuffer.put(data);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 启用写操作</span></span><br><span class="line">                enableWrite();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOG.error(<span class="string">&quot;Error sending response&quot;</span>, e);</span><br><span class="line">            close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 启用写操作</span></span><br><span class="line"><span class="comment">     * 设置SelectionKey的写事件，让NIO selector能够处理写操作</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">enableWrite</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> sk.interestOps();</span><br><span class="line">        <span class="keyword">if</span> ((i &amp; SelectionKey.OP_WRITE) == <span class="number">0</span>) &#123;</span><br><span class="line">            sk.interestOps(i | SelectionKey.OP_WRITE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理IO事件</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> k SelectionKey</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> InterruptedException 中断异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">doIO</span><span class="params">(SelectionKey k)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (k.isReadable()) &#123;</span><br><span class="line">                <span class="comment">// 处理读事件</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">rc</span> <span class="operator">=</span> sock.read(incomingBuffer);</span><br><span class="line">                <span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">EndOfStreamException</span>(<span class="string">&quot;Unable to read additional data from client&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (incomingBuffer.remaining() == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="type">boolean</span> isPayload;</span><br><span class="line">                    <span class="keyword">if</span> (incomingBuffer == lenBuffer) &#123;</span><br><span class="line">                        <span class="comment">// 读取长度信息</span></span><br><span class="line">                        incomingBuffer.flip();</span><br><span class="line">                        isPayload = readLength(k);</span><br><span class="line">                        incomingBuffer.clear();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// 读取消息体</span></span><br><span class="line">                        isPayload = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> (isPayload) &#123;</span><br><span class="line">                        readPayload();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (k.isWritable()) &#123;</span><br><span class="line">                <span class="comment">// 处理写事件</span></span><br><span class="line">                <span class="keyword">if</span> (outgoingBuffer.remaining() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">rc</span> <span class="operator">=</span> sock.write(outgoingBuffer);</span><br><span class="line">                    <span class="keyword">if</span> (outgoingBuffer.remaining() == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// 写完成，取消写事件</span></span><br><span class="line">                        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> sk.interestOps();</span><br><span class="line">                        <span class="keyword">if</span> ((i &amp; SelectionKey.OP_WRITE) != <span class="number">0</span>) &#123;</span><br><span class="line">                            sk.interestOps(i &amp; (~SelectionKey.OP_WRITE));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (CancelledKeyException e) &#123;</span><br><span class="line">            LOG.warn(<span class="string">&quot;CancelledKeyException causing close of session&quot;</span>);</span><br><span class="line">            close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            LOG.warn(<span class="string">&quot;IOException causing close of session&quot;</span>, e);</span><br><span class="line">            close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="五、网络通信机制"><a href="#五、网络通信机制" class="headerlink" title="五、网络通信机制"></a>五、网络通信机制</h2><h3 id="5-1-NIO服务器架构"><a href="#5-1-NIO服务器架构" class="headerlink" title="5.1 NIO服务器架构"></a>5.1 NIO服务器架构</h3><p><img src="/blog/images/zookeeper/arti/NIO%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%9E%B6%E6%9E%84.png" alt="NIO服务器架构"></p>
<h3 id="5-2-NIO服务器实现"><a href="#5-2-NIO服务器实现" class="headerlink" title="5.2 NIO服务器实现"></a>5.2 NIO服务器实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NIOServerCnxnFactory</span> <span class="keyword">extends</span> <span class="title class_">ServerCnxnFactory</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// NIO Selector，用于多路复用IO</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 服务器Socket通道</span></span><br><span class="line">    <span class="keyword">private</span> ServerSocketChannel ss;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 客户端连接集合</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashSet&lt;NIOServerCnxn&gt; cnxns = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;NIOServerCnxn&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 线程池，用于处理客户端请求</span></span><br><span class="line">    <span class="keyword">private</span> ExecutorService workerPool;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 接受线程数量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">numWorkerThreads</span> <span class="operator">=</span> <span class="number">64</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置并启动NIO服务器</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> addr 监听地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> maxcc 最大客户端连接数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException IO异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(InetSocketAddress addr, <span class="type">int</span> maxcc)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        configureSaslLogin();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 创建并配置服务器Socket通道</span></span><br><span class="line">        ss = ServerSocketChannel.open();</span><br><span class="line">        ss.socket().setReuseAddress(<span class="literal">true</span>);</span><br><span class="line">        ss.socket().bind(addr);</span><br><span class="line">        ss.configureBlocking(<span class="literal">false</span>);  <span class="comment">// 设置为非阻塞模式</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 注册到Selector，监听连接事件</span></span><br><span class="line">        ss.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 创建工作线程池</span></span><br><span class="line">        workerPool = Executors.newFixedThreadPool(numWorkerThreads, </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ThreadFactory</span>() &#123;</span><br><span class="line">                    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">threadNumber</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">                    </span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> Thread <span class="title function_">newThread</span><span class="params">(Runnable r)</span> &#123;</span><br><span class="line">                        <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(r, <span class="string">&quot;NIOWorker-&quot;</span> + threadNumber++);</span><br><span class="line">                        t.setDaemon(<span class="literal">true</span>);</span><br><span class="line">                        <span class="keyword">return</span> t;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        </span><br><span class="line">        LOG.info(<span class="string">&quot;NIO server configured on &#123;&#125;:&#123;&#125;&quot;</span>, addr.getHostName(), addr.getPort());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主事件循环</span></span><br><span class="line"><span class="comment">     * 处理所有的IO事件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (!stopped &amp;&amp; !Thread.currentThread().isInterrupted()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 等待IO事件，超时时间1秒</span></span><br><span class="line">                    selector.select(<span class="number">1000</span>);</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 获取就绪的事件</span></span><br><span class="line">                    Set&lt;SelectionKey&gt; selected = selector.selectedKeys();</span><br><span class="line">                    ArrayList&lt;SelectionKey&gt; selectedList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;SelectionKey&gt;(selected);</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 随机打乱处理顺序，避免饥饿现象</span></span><br><span class="line">                    Collections.shuffle(selectedList);</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 处理每个就绪的事件</span></span><br><span class="line">                    <span class="keyword">for</span> (SelectionKey k : selectedList) &#123;</span><br><span class="line">                        <span class="keyword">if</span> ((k.readyOps() &amp; SelectionKey.OP_ACCEPT) != <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="comment">// 处理新连接</span></span><br><span class="line">                            handleAccept();</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((k.readyOps() &amp; (SelectionKey.OP_READ | SelectionKey.OP_WRITE)) != <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="comment">// 处理读写事件</span></span><br><span class="line">                            handleIO(k);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            LOG.warn(<span class="string">&quot;Unexpected ops in select: &#123;&#125;&quot;</span>, k.readyOps());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 清理已处理的事件</span></span><br><span class="line">                    selected.clear();</span><br><span class="line">                    </span><br><span class="line">                &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">                    LOG.warn(<span class="string">&quot;Ignoring unexpected runtime exception&quot;</span>, e);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    LOG.warn(<span class="string">&quot;Ignoring exception&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 清理资源</span></span><br><span class="line">            closeAll();</span><br><span class="line">            LOG.info(<span class="string">&quot;NIO server stopped&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理新的客户端连接</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException IO异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleAccept</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">SocketChannel</span> <span class="variable">sc</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 接受新连接</span></span><br><span class="line">            sc = ss.accept();</span><br><span class="line">            <span class="keyword">if</span> (sc != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 配置Socket选项</span></span><br><span class="line">                sc.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">                sc.socket().setTcpNoDelay(<span class="literal">true</span>);</span><br><span class="line">                sc.socket().setKeepAlive(<span class="literal">true</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 注册到Selector，监听读事件</span></span><br><span class="line">                <span class="type">SelectionKey</span> <span class="variable">sk</span> <span class="operator">=</span> sc.register(selector, SelectionKey.OP_READ);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 创建连接对象</span></span><br><span class="line">                <span class="type">NIOServerCnxn</span> <span class="variable">cnxn</span> <span class="operator">=</span> createConnection(sc, sk);</span><br><span class="line">                sk.attach(cnxn);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 添加到连接集合</span></span><br><span class="line">                <span class="keyword">synchronized</span> (cnxns) &#123;</span><br><span class="line">                    cnxns.add(cnxn);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                LOG.info(<span class="string">&quot;Accepted connection from &#123;&#125;&quot;</span>, sc.getRemoteAddress());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sc != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    sc.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException ie) &#123;</span><br><span class="line">                    LOG.warn(<span class="string">&quot;Error closing socket&quot;</span>, ie);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理IO事件</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key SelectionKey</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> InterruptedException 中断异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleIO</span><span class="params">(SelectionKey key)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">NIOServerCnxn</span> <span class="variable">c</span> <span class="operator">=</span> (NIOServerCnxn) key.attachment();</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 提交到线程池处理</span></span><br><span class="line">        workerPool.submit(<span class="keyword">new</span> <span class="title class_">IOWorkRequest</span>(c, key));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建服务器连接</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sock Socket通道</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sk SelectionKey</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 服务器连接对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException IO异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> NIOServerCnxn <span class="title function_">createConnection</span><span class="params">(SocketChannel sock, SelectionKey sk)</span> </span><br><span class="line">            <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">NIOServerCnxn</span>(zkServer, sock, sk, <span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * IO工作请求</span></span><br><span class="line"><span class="comment">     * 封装IO处理逻辑，提交到线程池执行</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">IOWorkRequest</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> NIOServerCnxn cnxn;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> SelectionKey key;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">IOWorkRequest</span><span class="params">(NIOServerCnxn cnxn, SelectionKey key)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.cnxn = cnxn;</span><br><span class="line">            <span class="built_in">this</span>.key = key;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 检查连接是否有效</span></span><br><span class="line">                <span class="keyword">if</span> (key.isValid()) &#123;</span><br><span class="line">                    cnxn.doIO(key);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                LOG.warn(<span class="string">&quot;Interrupted while processing IO&quot;</span>, e);</span><br><span class="line">                Thread.currentThread().interrupt();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                LOG.warn(<span class="string">&quot;Error processing IO&quot;</span>, e);</span><br><span class="line">                cnxn.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭所有连接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">closeAll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (cnxns) &#123;</span><br><span class="line">            <span class="keyword">for</span> (NIOServerCnxn cnxn : cnxns) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    cnxn.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    LOG.warn(<span class="string">&quot;Error closing connection&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            cnxns.clear();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (workerPool != <span class="literal">null</span>) &#123;</span><br><span class="line">            workerPool.shutdown();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!workerPool.awaitTermination(<span class="number">5</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">                    workerPool.shutdownNow();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                workerPool.shutdownNow();</span><br><span class="line">                Thread.currentThread().interrupt();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-请求处理链架构"><a href="#5-3-请求处理链架构" class="headerlink" title="5.3 请求处理链架构"></a>5.3 请求处理链架构</h3><p><img src="/blog/images/zookeeper/arti/%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E9%93%BE%E6%9E%B6%E6%9E%84.png" alt="请求处理链架构"></p>
<h2 id="六、性能优化与监控"><a href="#六、性能优化与监控" class="headerlink" title="六、性能优化与监控"></a>六、性能优化与监控</h2><h3 id="6-1-内存管理优化"><a href="#6-1-内存管理优化" class="headerlink" title="6.1 内存管理优化"></a>6.1 内存管理优化</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataTree</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 优化内存使用的路径缓存</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">PathTrie</span> <span class="variable">pathTrie</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PathTrie</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 节点统计信息</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateCount</span><span class="params">(String path, <span class="type">int</span> count)</span> &#123;</span><br><span class="line">        <span class="type">DataNode</span> <span class="variable">node</span> <span class="operator">=</span> nodes.get(path);</span><br><span class="line">        <span class="keyword">if</span> (node != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (node) &#123;</span><br><span class="line">                node.stat.setCzxid(node.stat.getCzxid());</span><br><span class="line">                node.stat.setNumChildren(count);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 内存清理</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span> &#123;</span><br><span class="line">        root = <span class="literal">null</span>;</span><br><span class="line">        nodes.clear();</span><br><span class="line">        dataWatches.clear();</span><br><span class="line">        childWatches.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-JMX监控指标"><a href="#6-2-JMX监控指标" class="headerlink" title="6.2 JMX监控指标"></a>6.2 JMX监控指标</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ZooKeeperServerBean</span> <span class="keyword">implements</span> <span class="title class_">ZooKeeperServerMXBean</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getOutstandingRequests</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> zks.getOutstandingRequests();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getAvgRequestLatency</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> zks.getAvgRequestLatency();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getMaxRequestLatency</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> zks.getMaxRequestLatency();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getMinRequestLatency</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> zks.getMinRequestLatency();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getNumAliveConnections</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> zks.getNumAliveConnections();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="七、实战应用场景"><a href="#七、实战应用场景" class="headerlink" title="七、实战应用场景"></a>七、实战应用场景</h2><h3 id="7-1-分布式锁实现"><a href="#7-1-分布式锁实现" class="headerlink" title="7.1 分布式锁实现"></a>7.1 分布式锁实现</h3><h4 id="7-1-1-分布式锁架构"><a href="#7-1-1-分布式锁架构" class="headerlink" title="7.1.1 分布式锁架构"></a>7.1.1 分布式锁架构</h4><p><img src="/blog/images/zookeeper/arti/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E6%9E%B6%E6%9E%84.png" alt="分布式锁架构"></p>
<h4 id="7-1-2-分布式锁实现"><a href="#7-1-2-分布式锁实现" class="headerlink" title="7.1.2 分布式锁实现"></a>7.1.2 分布式锁实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistributedLock</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ZooKeeper zk;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String lockPath;</span><br><span class="line">    <span class="keyword">private</span> String currentPath;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">mutex</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 锁状态</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">locked</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DistributedLock</span><span class="params">(ZooKeeper zk, String lockPath)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.zk = zk;</span><br><span class="line">        <span class="built_in">this</span>.lockPath = lockPath;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 确保锁根目录存在</span></span><br><span class="line">        ensureLockPathExists();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 尝试获取锁</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timeout 超时时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> unit 时间单位</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 是否成功获取锁</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> InterruptedException 中断异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">long</span> <span class="variable">waitTime</span> <span class="operator">=</span> unit.toMillis(timeout);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 步骤1：创建临时有序节点</span></span><br><span class="line">            currentPath = zk.create(lockPath + <span class="string">&quot;/lock-&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>], </span><br><span class="line">                    ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL);</span><br><span class="line">            </span><br><span class="line">            LOG.info(<span class="string">&quot;Created lock node: &#123;&#125;&quot;</span>, currentPath);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="comment">// 步骤2：获取所有子节点并排序</span></span><br><span class="line">                List&lt;String&gt; children = zk.getChildren(lockPath, <span class="literal">false</span>);</span><br><span class="line">                Collections.sort(children);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 步骤3：检查是否获得锁</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">currentNode</span> <span class="operator">=</span> currentPath.substring(lockPath.length() + <span class="number">1</span>);</span><br><span class="line">                <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> children.indexOf(currentNode);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (index == -<span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Current node not found in children list&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (index == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// 获得锁：当前节点是最小的</span></span><br><span class="line">                    <span class="keyword">synchronized</span> (mutex) &#123;</span><br><span class="line">                        locked = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    LOG.info(<span class="string">&quot;Lock acquired: &#123;&#125;&quot;</span>, currentPath);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 步骤4：监听前一个节点</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">prevNode</span> <span class="operator">=</span> children.get(index - <span class="number">1</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">prevPath</span> <span class="operator">=</span> lockPath + <span class="string">&quot;/&quot;</span> + prevNode;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">final</span> <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 设置监听器</span></span><br><span class="line">                <span class="type">Stat</span> <span class="variable">stat</span> <span class="operator">=</span> zk.exists(prevPath, <span class="keyword">new</span> <span class="title class_">Watcher</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(WatchedEvent event)</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (event.getType() == Event.EventType.NodeDeleted) &#123;</span><br><span class="line">                            latch.countDown();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 检查前一个节点是否还存在</span></span><br><span class="line">                <span class="keyword">if</span> (stat == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 前一个节点已删除，重新检查</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 步骤5：等待前一个节点删除</span></span><br><span class="line">                <span class="type">long</span> <span class="variable">remainTime</span> <span class="operator">=</span> waitTime - (System.currentTimeMillis() - startTime);</span><br><span class="line">                <span class="keyword">if</span> (remainTime &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    LOG.info(<span class="string">&quot;Lock acquisition timeout: &#123;&#125;&quot;</span>, currentPath);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                LOG.info(<span class="string">&quot;Waiting for lock, watching: &#123;&#125;&quot;</span>, prevPath);</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">notified</span> <span class="operator">=</span> latch.await(remainTime, TimeUnit.MILLISECONDS);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (!notified) &#123;</span><br><span class="line">                    LOG.info(<span class="string">&quot;Lock acquisition timeout after waiting: &#123;&#125;&quot;</span>, currentPath);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (KeeperException e) &#123;</span><br><span class="line">            LOG.error(<span class="string">&quot;Failed to acquire lock&quot;</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to acquire lock&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 如果获取锁失败，清理节点</span></span><br><span class="line">            <span class="keyword">if</span> (!locked &amp;&amp; currentPath != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    zk.delete(currentPath, -<span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    LOG.warn(<span class="string">&quot;Failed to cleanup lock node: &#123;&#125;&quot;</span>, currentPath, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 释放锁</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mutex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!locked) &#123;</span><br><span class="line">                LOG.warn(<span class="string">&quot;Attempting to unlock when not locked&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (currentPath != <span class="literal">null</span>) &#123;</span><br><span class="line">                    zk.delete(currentPath, -<span class="number">1</span>);</span><br><span class="line">                    LOG.info(<span class="string">&quot;Lock released: &#123;&#125;&quot;</span>, currentPath);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (KeeperException | InterruptedException e) &#123;</span><br><span class="line">                LOG.error(<span class="string">&quot;Failed to release lock: &#123;&#125;&quot;</span>, currentPath, e);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to release lock&quot;</span>, e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                locked = <span class="literal">false</span>;</span><br><span class="line">                currentPath = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 检查是否持有锁</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 是否持有锁</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isLocked</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mutex) &#123;</span><br><span class="line">            <span class="keyword">return</span> locked;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 确保锁根目录存在</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">ensureLockPathExists</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Stat</span> <span class="variable">stat</span> <span class="operator">=</span> zk.exists(lockPath, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (stat == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 创建持久节点作为锁根目录</span></span><br><span class="line">                zk.create(lockPath, <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>], </span><br><span class="line">                        ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line">                LOG.info(<span class="string">&quot;Created lock root path: &#123;&#125;&quot;</span>, lockPath);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (KeeperException.NodeExistsException e) &#123;</span><br><span class="line">            <span class="comment">// 节点已存在，忽略</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (KeeperException | InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to create lock root path&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取当前等待队列信息</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 等待队列信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getWaitingQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;String&gt; children = zk.getChildren(lockPath, <span class="literal">false</span>);</span><br><span class="line">            Collections.sort(children);</span><br><span class="line">            <span class="keyword">return</span> children;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (KeeperException | InterruptedException e) &#123;</span><br><span class="line">            LOG.error(<span class="string">&quot;Failed to get waiting queue&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-2-配置中心实现"><a href="#7-2-配置中心实现" class="headerlink" title="7.2 配置中心实现"></a>7.2 配置中心实现</h3><h4 id="7-2-1-配置中心架构"><a href="#7-2-1-配置中心架构" class="headerlink" title="7.2.1 配置中心架构"></a>7.2.1 配置中心架构</h4><p><img src="/blog/images/zookeeper/arti/%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E6%9E%B6%E6%9E%84.png" alt="配置中心架构"></p>
<h4 id="7-2-2-配置中心实现"><a href="#7-2-2-配置中心实现" class="headerlink" title="7.2.2 配置中心实现"></a>7.2.2 配置中心实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigCenter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ZooKeeper zk;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String configPath;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 本地配置缓存</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, String&gt; localCache = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 配置变更监听器</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Set&lt;ConfigChangeListener&gt;&gt; listeners = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 配置版本管理</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Integer&gt; configVersions = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ConfigCenter</span><span class="params">(ZooKeeper zk, String configPath)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.zk = zk;</span><br><span class="line">        <span class="built_in">this</span>.configPath = configPath;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 确保配置根目录存在</span></span><br><span class="line">        ensureConfigPathExists();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监听配置变化</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 配置键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> listener 变更监听器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">watchConfig</span><span class="params">(String key, ConfigChangeListener listener)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> configPath + <span class="string">&quot;/&quot;</span> + key;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 添加监听器到集合</span></span><br><span class="line">        listeners.computeIfAbsent(key, k -&gt; ConcurrentHashMap.newKeySet()).add(listener);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获取初始值</span></span><br><span class="line">            loadConfigValue(key, path);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOG.error(<span class="string">&quot;Failed to watch config: &#123;&#125;&quot;</span>, key, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to watch config&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加载配置值</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 配置键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> path 配置路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loadConfigValue</span><span class="params">(String key, String path)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 设置监听器并获取数据</span></span><br><span class="line">            <span class="type">Stat</span> <span class="variable">stat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Stat</span>();</span><br><span class="line">            <span class="type">byte</span>[] data = zk.getData(path, <span class="keyword">new</span> <span class="title class_">ConfigWatcher</span>(key), stat);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (data != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(data, StandardCharsets.UTF_8);</span><br><span class="line">                <span class="type">String</span> <span class="variable">oldValue</span> <span class="operator">=</span> localCache.put(key, value);</span><br><span class="line">                configVersions.put(key, stat.getVersion());</span><br><span class="line">                </span><br><span class="line">                LOG.info(<span class="string">&quot;Loaded config: &#123;&#125; = &#123;&#125;&quot;</span>, key, value);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 通知监听器（仅在值发生变化时）</span></span><br><span class="line">                <span class="keyword">if</span> (!value.equals(oldValue)) &#123;</span><br><span class="line">                    notifyListeners(key, oldValue, value);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (KeeperException.NoNodeException e) &#123;</span><br><span class="line">            <span class="comment">// 节点不存在，创建默认值</span></span><br><span class="line">            LOG.info(<span class="string">&quot;Config node not found, creating default: &#123;&#125;&quot;</span>, key);</span><br><span class="line">            localCache.put(key, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            configVersions.put(key, -<span class="number">1</span>);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOG.error(<span class="string">&quot;Failed to load config: &#123;&#125;&quot;</span>, key, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置监听器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ConfigWatcher</span> <span class="keyword">implements</span> <span class="title class_">Watcher</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String key;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">ConfigWatcher</span><span class="params">(String key)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.key = key;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(WatchedEvent event)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (event.getType() == Event.EventType.NodeDataChanged) &#123;</span><br><span class="line">                <span class="comment">// 配置发生变化，重新加载</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> configPath + <span class="string">&quot;/&quot;</span> + key;</span><br><span class="line">                loadConfigValue(key, path);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType() == Event.EventType.NodeDeleted) &#123;</span><br><span class="line">                <span class="comment">// 配置被删除</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">oldValue</span> <span class="operator">=</span> localCache.remove(key);</span><br><span class="line">                configVersions.remove(key);</span><br><span class="line">                </span><br><span class="line">                LOG.info(<span class="string">&quot;Config deleted: &#123;&#125;&quot;</span>, key);</span><br><span class="line">                notifyListeners(key, oldValue, <span class="literal">null</span>);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType() == Event.EventType.NodeCreated) &#123;</span><br><span class="line">                <span class="comment">// 配置被创建</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> configPath + <span class="string">&quot;/&quot;</span> + key;</span><br><span class="line">                loadConfigValue(key, path);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通知配置变更监听器</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 配置键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> oldValue 旧值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newValue 新值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">notifyListeners</span><span class="params">(String key, String oldValue, String newValue)</span> &#123;</span><br><span class="line">        Set&lt;ConfigChangeListener&gt; keyListeners = listeners.get(key);</span><br><span class="line">        <span class="keyword">if</span> (keyListeners != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (ConfigChangeListener listener : keyListeners) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    listener.onConfigChanged(key, oldValue, newValue);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    LOG.error(<span class="string">&quot;Error notifying config listener&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新配置</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 配置键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 配置值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateConfig</span><span class="params">(String key, String value)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> configPath + <span class="string">&quot;/&quot;</span> + key;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">version</span> <span class="operator">=</span> configVersions.get(key);</span><br><span class="line">            <span class="type">int</span> <span class="variable">currentVersion</span> <span class="operator">=</span> (version != <span class="literal">null</span>) ? version : -<span class="number">1</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="type">Stat</span> <span class="variable">stat</span> <span class="operator">=</span> zk.exists(path, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (stat != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 更新现有配置</span></span><br><span class="line">                zk.setData(path, value.getBytes(StandardCharsets.UTF_8), currentVersion);</span><br><span class="line">                LOG.info(<span class="string">&quot;Updated config: &#123;&#125; = &#123;&#125;&quot;</span>, key, value);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 创建新配置</span></span><br><span class="line">                zk.create(path, value.getBytes(StandardCharsets.UTF_8), </span><br><span class="line">                        ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line">                LOG.info(<span class="string">&quot;Created config: &#123;&#125; = &#123;&#125;&quot;</span>, key, value);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (KeeperException.BadVersionException e) &#123;</span><br><span class="line">            LOG.warn(<span class="string">&quot;Config version conflict, retrying: &#123;&#125;&quot;</span>, key);</span><br><span class="line">            <span class="comment">// 重新获取版本并重试</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Stat</span> <span class="variable">stat</span> <span class="operator">=</span> zk.exists(path, <span class="literal">false</span>);</span><br><span class="line">                <span class="keyword">if</span> (stat != <span class="literal">null</span>) &#123;</span><br><span class="line">                    zk.setData(path, value.getBytes(StandardCharsets.UTF_8), stat.getVersion());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception retryEx) &#123;</span><br><span class="line">                LOG.error(<span class="string">&quot;Failed to retry config update: &#123;&#125;&quot;</span>, key, retryEx);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to update config&quot;</span>, retryEx);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOG.error(<span class="string">&quot;Failed to update config: &#123;&#125;&quot;</span>, key, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to update config&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取配置值</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 配置键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 配置值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getConfig</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> localCache.get(key);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取配置值（带默认值）</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 配置键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> defaultValue 默认值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 配置值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getConfig</span><span class="params">(String key, String defaultValue)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> localCache.getOrDefault(key, defaultValue);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除配置</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 配置键</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteConfig</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> configPath + <span class="string">&quot;/&quot;</span> + key;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            zk.delete(path, -<span class="number">1</span>);</span><br><span class="line">            LOG.info(<span class="string">&quot;Deleted config: &#123;&#125;&quot;</span>, key);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (KeeperException.NoNodeException e) &#123;</span><br><span class="line">            LOG.warn(<span class="string">&quot;Config not found for deletion: &#123;&#125;&quot;</span>, key);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOG.error(<span class="string">&quot;Failed to delete config: &#123;&#125;&quot;</span>, key, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to delete config&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取所有配置</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 配置映射</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">getAllConfigs</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(localCache);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 确保配置根目录存在</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">ensureConfigPathExists</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Stat</span> <span class="variable">stat</span> <span class="operator">=</span> zk.exists(configPath, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (stat == <span class="literal">null</span>) &#123;</span><br><span class="line">                zk.create(configPath, <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>], </span><br><span class="line">                        ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line">                LOG.info(<span class="string">&quot;Created config root path: &#123;&#125;&quot;</span>, configPath);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (KeeperException.NodeExistsException e) &#123;</span><br><span class="line">            <span class="comment">// 节点已存在，忽略</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to create config root path&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置变更监听器接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ConfigChangeListener</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置变更回调</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 配置键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> oldValue 旧值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newValue 新值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onConfigChanged</span><span class="params">(String key, String oldValue, String newValue)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-3-服务发现实现"><a href="#7-3-服务发现实现" class="headerlink" title="7.3 服务发现实现"></a>7.3 服务发现实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceDiscovery</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ZooKeeper zk;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String servicePath;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, List&lt;ServiceInstance&gt;&gt; serviceCache = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerService</span><span class="params">(String serviceName, ServiceInstance instance)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> servicePath + <span class="string">&quot;/&quot;</span> + serviceName;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 确保服务路径存在</span></span><br><span class="line">            <span class="keyword">if</span> (zk.exists(path, <span class="literal">false</span>) == <span class="literal">null</span>) &#123;</span><br><span class="line">                zk.create(path, <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>], ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 注册服务实例</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">instancePath</span> <span class="operator">=</span> path + <span class="string">&quot;/&quot;</span> + instance.getId();</span><br><span class="line">            <span class="type">String</span> <span class="variable">instanceData</span> <span class="operator">=</span> JSON.toJSONString(instance);</span><br><span class="line">            </span><br><span class="line">            zk.create(instancePath, instanceData.getBytes(StandardCharsets.UTF_8),</span><br><span class="line">                    ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (KeeperException | InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to register service&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> List&lt;ServiceInstance&gt; <span class="title function_">discoverService</span><span class="params">(String serviceName)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> servicePath + <span class="string">&quot;/&quot;</span> + serviceName;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;String&gt; children = zk.getChildren(path, <span class="keyword">new</span> <span class="title class_">Watcher</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(WatchedEvent event)</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (event.getType() == Event.EventType.NodeChildrenChanged) &#123;</span><br><span class="line">                        <span class="comment">// 刷新服务实例缓存</span></span><br><span class="line">                        refreshServiceCache(serviceName);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            List&lt;ServiceInstance&gt; instances = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (String child : children) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">instancePath</span> <span class="operator">=</span> path + <span class="string">&quot;/&quot;</span> + child;</span><br><span class="line">                <span class="type">byte</span>[] data = zk.getData(instancePath, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="type">ServiceInstance</span> <span class="variable">instance</span> <span class="operator">=</span> JSON.parseObject(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">String</span>(data, StandardCharsets.UTF_8), ServiceInstance.class);</span><br><span class="line">                instances.add(instance);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            serviceCache.put(serviceName, instances);</span><br><span class="line">            <span class="keyword">return</span> instances;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (KeeperException | InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to discover service&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">refreshServiceCache</span><span class="params">(String serviceName)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;ServiceInstance&gt; instances = discoverService(serviceName);</span><br><span class="line">            serviceCache.put(serviceName, instances);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOG.error(<span class="string">&quot;Failed to refresh service cache for &quot;</span> + serviceName, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="八、运维与故障排查"><a href="#八、运维与故障排查" class="headerlink" title="八、运维与故障排查"></a>八、运维与故障排查</h2><h3 id="8-1-常见问题诊断"><a href="#8-1-常见问题诊断" class="headerlink" title="8.1 常见问题诊断"></a>8.1 常见问题诊断</h3><h4 id="8-1-1-连接超时问题"><a href="#8-1-1-连接超时问题" class="headerlink" title="8.1.1 连接超时问题"></a>8.1.1 连接超时问题</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查网络连接</span></span><br><span class="line">netstat -an | grep :2181</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看ZooKeeper日志</span></span><br><span class="line"><span class="built_in">tail</span> -f zookeeper.out</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查会话超时配置</span></span><br><span class="line"><span class="built_in">echo</span> <span class="built_in">stat</span> | nc localhost 2181</span><br></pre></td></tr></table></figure>

<h4 id="8-1-2-内存泄漏排查"><a href="#8-1-2-内存泄漏排查" class="headerlink" title="8.1.2 内存泄漏排查"></a>8.1.2 内存泄漏排查</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ZKMemoryMonitor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">monitorMemory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MemoryMXBean</span> <span class="variable">memoryBean</span> <span class="operator">=</span> ManagementFactory.getMemoryMXBean();</span><br><span class="line">        <span class="type">MemoryUsage</span> <span class="variable">heapUsage</span> <span class="operator">=</span> memoryBean.getHeapMemoryUsage();</span><br><span class="line">        </span><br><span class="line">        <span class="type">long</span> <span class="variable">used</span> <span class="operator">=</span> heapUsage.getUsed();</span><br><span class="line">        <span class="type">long</span> <span class="variable">max</span> <span class="operator">=</span> heapUsage.getMax();</span><br><span class="line">        <span class="type">double</span> <span class="variable">usage</span> <span class="operator">=</span> (<span class="type">double</span>) used / max * <span class="number">100</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (usage &gt; <span class="number">80</span>) &#123;</span><br><span class="line">            LOG.warn(<span class="string">&quot;High memory usage: &#123;&#125;%&quot;</span>, usage);</span><br><span class="line">            <span class="comment">// 触发GC或告警</span></span><br><span class="line">            System.gc();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">dumpHeap</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">MBeanServer</span> <span class="variable">server</span> <span class="operator">=</span> ManagementFactory.getPlatformMBeanServer();</span><br><span class="line">            <span class="type">HotSpotDiagnosticMXBean</span> <span class="variable">bean</span> <span class="operator">=</span> ManagementFactory.newPlatformMXBeanProxy(</span><br><span class="line">                    server, <span class="string">&quot;com.sun.management:type=HotSpotDiagnostic&quot;</span>, HotSpotDiagnosticMXBean.class);</span><br><span class="line">            </span><br><span class="line">            <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> <span class="string">&quot;zk-heap-dump-&quot;</span> + System.currentTimeMillis() + <span class="string">&quot;.hprof&quot;</span>;</span><br><span class="line">            bean.dumpHeap(fileName, <span class="literal">true</span>);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOG.error(<span class="string">&quot;Failed to dump heap&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-2-性能调优建议"><a href="#8-2-性能调优建议" class="headerlink" title="8.2 性能调优建议"></a>8.2 性能调优建议</h3><h4 id="8-2-1-JVM参数优化"><a href="#8-2-1-JVM参数优化" class="headerlink" title="8.2.1 JVM参数优化"></a>8.2.1 JVM参数优化</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 推荐JVM参数</span></span><br><span class="line">-Xmx4g</span><br><span class="line">-Xms4g</span><br><span class="line">-XX:+UseG1GC</span><br><span class="line">-XX:MaxGCPauseMillis=200</span><br><span class="line">-XX:+UnlockExperimentalVMOptions</span><br><span class="line">-XX:+UseCGroupMemoryLimitForHeap</span><br><span class="line">-XX:+PrintGCDetails</span><br><span class="line">-XX:+PrintGCTimeStamps</span><br><span class="line">-Xloggc:gc.log</span><br></pre></td></tr></table></figure>

<h4 id="8-2-2-配置优化"><a href="#8-2-2-配置优化" class="headerlink" title="8.2.2 配置优化"></a>8.2.2 配置优化</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># zoo.cfg优化配置</span></span><br><span class="line"><span class="attr">tickTime</span>=<span class="string">2000</span></span><br><span class="line"><span class="attr">initLimit</span>=<span class="string">10</span></span><br><span class="line"><span class="attr">syncLimit</span>=<span class="string">5</span></span><br><span class="line"><span class="attr">maxClientCnxns</span>=<span class="string">60</span></span><br><span class="line"><span class="attr">autopurge.snapRetainCount</span>=<span class="string">3</span></span><br><span class="line"><span class="attr">autopurge.purgeInterval</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">preAllocSize</span>=<span class="string">65536</span></span><br><span class="line"><span class="attr">snapCount</span>=<span class="string">100000</span></span><br></pre></td></tr></table></figure>

<h2 id="九、总结"><a href="#九、总结" class="headerlink" title="九、总结"></a>九、总结</h2><p>ZooKeeper作为分布式协调服务的核心组件，其源码实现体现了分布式系统设计的诸多精髓：</p>
<ol>
<li><strong>一致性保证</strong>: 通过ZAB协议确保强一致性</li>
<li><strong>高可用性</strong>: 通过集群部署和故障转移机制</li>
<li><strong>可扩展性</strong>: 通过读写分离和Observer节点</li>
<li><strong>性能优化</strong>: 通过内存数据结构和批量处理</li>
</ol>
<p>对于大数据开发人员而言，深入理解ZooKeeper的实现原理，不仅有助于更好地使用这一工具，也能为设计和优化分布式系统提供宝贵的经验。</p>
<p>在实际应用中，建议：</p>
<ul>
<li>根据业务场景选择合适的一致性级别</li>
<li>合理配置集群规模和参数</li>
<li>建立完善的监控和告警机制</li>
<li>定期进行性能测试和容量规划</li>
</ul>
<p>通过本文的源码分析和实战案例，相信读者能够更深入地理解ZooKeeper的工作原理，并在实际项目中发挥其最大价值。</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/blog/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/" rel="tag"># 分布式系统</a>
              <a href="/blog/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/" rel="tag"># 大数据</a>
              <a href="/blog/tags/zookeeper/" rel="tag"># zookeeper</a>
              <a href="/blog/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" rel="tag"># 源码解析</a>
              <a href="/blog/tags/%E4%B8%80%E8%87%B4%E6%80%A7%E7%AE%97%E6%B3%95/" rel="tag"># 一致性算法</a>
              <a href="/blog/tags/ZAB%E5%8D%8F%E8%AE%AE/" rel="tag"># ZAB协议</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/blog/2019/02/08/mysql-%E5%AD%97%E7%AC%A6%E9%9B%86%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98/" rel="prev" title="MySQL 字符集深度解析：从latin1到utf8mb4的完整指南">
                  <i class="fa fa-angle-left"></i> MySQL 字符集深度解析：从latin1到utf8mb4的完整指南
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/blog/2020/02/15/Kafka%E7%9F%A5%E8%AF%86%E7%82%B9%E5%8F%8A%E5%AE%9E%E6%88%98%E6%80%BB%E7%BB%93/" rel="next" title="Kafka知识点及实战总结">
                  Kafka知识点及实战总结 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2014 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">NexT</span>
  </div>
  <div class="powered-by">由 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZw==">NexT.Gemini</span> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRlZS5jb20vYWRkcm9j" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"next-theme","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/blog/js/third-party/comments/disqus.js" defer></script>

</body>
</html>
