<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="5AUIVYTbHIAuz-eQtxSfZbWW5eg9_EVZMSQycIuXrG0">

<link rel="stylesheet" href="/blog/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&family=Inconsolata:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"phoenixsu9.github.io","root":"/blog/","images":"/blog/images","scheme":"Gemini","darkmode":true,"version":"8.23.1","exturl":true,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":"default"},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":true,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":true,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/blog/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/blog/js/config.js" defer></script>

    <meta name="description" content="我想分享我们团队如何从0到1打造企业级大模型Agent框架的实战经验，包括架构设计中的关键决策、踩过的坑和最佳实践，帮助技术团队快速落地AI应用。">
<meta property="og:type" content="article">
<meta property="og:title" content="企业级大模型Agent框架架构设计：深度应用与复杂场景突破">
<meta property="og:url" content="https://phoenixsu9.github.io/blog/2025/01/17/%E5%A4%A7%E6%A8%A1%E5%9E%8BAgent%E5%BC%80%E5%8F%91/index.html">
<meta property="og:site_name" content="Addroc&#39;s Blog">
<meta property="og:description" content="我想分享我们团队如何从0到1打造企业级大模型Agent框架的实战经验，包括架构设计中的关键决策、踩过的坑和最佳实践，帮助技术团队快速落地AI应用。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://phoenixsu9.github.io/blog/images/%E5%A4%A7%E6%A8%A1%E5%9E%8B/%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%A4%A7%E6%A8%A1%E5%9E%8BAgent%E6%A1%86%E6%9E%B6%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1.png">
<meta property="article:published_time" content="2025-01-17T05:29:14.000Z">
<meta property="article:modified_time" content="2025-12-19T06:51:32.296Z">
<meta property="article:author" content="Addroc">
<meta property="article:tag" content="架构设计">
<meta property="article:tag" content="大模型">
<meta property="article:tag" content="Agent">
<meta property="article:tag" content="企业级应用">
<meta property="article:tag" content="AI框架">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://phoenixsu9.github.io/blog/images/%E5%A4%A7%E6%A8%A1%E5%9E%8B/%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%A4%A7%E6%A8%A1%E5%9E%8BAgent%E6%A1%86%E6%9E%B6%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1.png">


<link rel="canonical" href="https://phoenixsu9.github.io/blog/2025/01/17/%E5%A4%A7%E6%A8%A1%E5%9E%8BAgent%E5%BC%80%E5%8F%91/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://phoenixsu9.github.io/blog/2025/01/17/%E5%A4%A7%E6%A8%A1%E5%9E%8BAgent%E5%BC%80%E5%8F%91/","path":"2025/01/17/大模型Agent开发/","title":"企业级大模型Agent框架架构设计：深度应用与复杂场景突破"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>企业级大模型Agent框架架构设计：深度应用与复杂场景突破 | Addroc's Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-43861RVV8R"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-43861RVV8R","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/blog/js/third-party/analytics/google-analytics.js" defer></script>








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous" defer></script>
<script src="/blog/js/utils.js" defer></script><script src="/blog/js/motion.js" defer></script><script src="/blog/js/sidebar.js" defer></script><script src="/blog/js/next-boot.js" defer></script><script src="/blog/js/pjax.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous" defer></script>
<script src="/blog/js/third-party/search/local-search.js" defer></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.5.0/mermaid.min.js","integrity":"sha256-2obLuIPcceEhkE3G09G33hBdmE55ivVcZUlcKcGNHjU="}}</script>
  <script src="/blog/js/third-party/tags/mermaid.js" defer></script>

  <script class="next-config" data-name="wavedrom" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/wavedrom.min.js","integrity":"sha256-INLAoJc6quTNfiMWkGZniYO2cxE8mHpddnLow1m6RFs="}}</script>
  <script class="next-config" data-name="wavedrom_skin" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/skins/default.js","integrity":"sha256-fduc/Zszk5ezWws2uInY/ALWVmIrmV6VTgXbsYSReFI="}}</script>
  <script src="/blog/js/third-party/tags/wavedrom.js" defer></script>




  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"ams","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/blog/js/third-party/math/mathjax.js" defer></script>



  <noscript>
    <link rel="stylesheet" href="/blog/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Addroc's Blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Addroc blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/blog/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-archives"><a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">21</span></a></li><li class="menu-item menu-item-categories"><a href="/blog/categories/" rel="section"><i class="fa fa-folder-open fa-fw"></i>分类<span class="badge">20</span></a></li><li class="menu-item menu-item-tags"><a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">63</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%A4%A7%E6%A8%A1%E5%9E%8BAgent%E6%A1%86%E6%9E%B6%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%EF%BC%9A%E6%B7%B1%E5%BA%A6%E5%BA%94%E7%94%A8%E4%B8%8E%E5%A4%8D%E6%9D%82%E5%9C%BA%E6%99%AF%E7%AA%81%E7%A0%B4"><span class="nav-number">1.</span> <span class="nav-text">企业级大模型Agent框架架构设计：深度应用与复杂场景突破</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="nav-number">1.2.</span> <span class="nav-text">一、整体架构设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E6%A6%82%E8%A7%88"><span class="nav-number">1.2.1.</span> <span class="nav-text">1.1 系统架构概览</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E6%A0%B8%E5%BF%83%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99"><span class="nav-number">1.2.2.</span> <span class="nav-text">1.2 核心设计原则</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-1-%E6%A8%A1%E5%9D%97%E5%8C%96%E4%B8%8E%E5%8F%AF%E6%89%A9%E5%B1%95%E6%80%A7"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">1.2.1 模块化与可扩展性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-2-%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86%E4%B8%8E%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">1.2.2 异步处理与并发控制</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90"><span class="nav-number">1.3.</span> <span class="nav-text">二、核心组件深度解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-Agent%E7%BC%96%E6%8E%92%E5%99%A8%E8%AE%BE%E8%AE%A1"><span class="nav-number">1.3.1.</span> <span class="nav-text">2.1 Agent编排器设计</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-1-%E6%99%BA%E8%83%BD%E8%B7%AF%E7%94%B1%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">1.3.1.1.</span> <span class="nav-text">2.1.1 智能路由与负载均衡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-2-%E5%B7%A5%E4%BD%9C%E6%B5%81%E5%BC%95%E6%93%8E"><span class="nav-number">1.3.1.2.</span> <span class="nav-text">2.1.2 工作流引擎</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E5%A4%9A%E6%A8%A1%E6%80%81%E8%9E%8D%E5%90%88Agent"><span class="nav-number">1.3.2.</span> <span class="nav-text">2.2 多模态融合Agent</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-1-%E5%A4%9A%E6%A8%A1%E6%80%81%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">2.2.1 多模态数据处理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E9%9B%86%E6%88%90Agent"><span class="nav-number">1.3.3.</span> <span class="nav-text">2.3 知识图谱集成Agent</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-1-%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="nav-number">1.3.3.1.</span> <span class="nav-text">2.3.1 知识图谱架构设计</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-2-%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1Agent%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.3.3.2.</span> <span class="nav-text">2.3.2 知识图谱Agent实现</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E6%A8%A1%E5%9E%8B%E7%AE%A1%E7%90%86%E4%B8%8E%E6%9C%8D%E5%8A%A1%E5%8C%96"><span class="nav-number">1.4.</span> <span class="nav-text">三、模型管理与服务化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E6%A8%A1%E5%9E%8B%E7%BD%91%E5%85%B3%E6%9E%B6%E6%9E%84"><span class="nav-number">1.4.1.</span> <span class="nav-text">3.1 模型网关架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E6%A8%A1%E5%9E%8B%E7%BD%91%E5%85%B3%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.4.2.</span> <span class="nav-text">3.2 模型网关实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E5%AE%89%E5%85%A8%E4%B8%8E%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6"><span class="nav-number">1.5.</span> <span class="nav-text">四、安全与权限控制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E5%AE%89%E5%85%A8%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="nav-number">1.5.1.</span> <span class="nav-text">4.1 安全架构设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E5%AE%89%E5%85%A8%E6%8E%A7%E5%88%B6%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.5.2.</span> <span class="nav-text">4.2 安全控制实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E7%9B%91%E6%8E%A7%E4%B8%8E%E8%BF%90%E7%BB%B4"><span class="nav-number">1.6.</span> <span class="nav-text">五、监控与运维</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-%E7%9B%91%E6%8E%A7%E6%9E%B6%E6%9E%84"><span class="nav-number">1.6.1.</span> <span class="nav-text">5.1 监控架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.6.2.</span> <span class="nav-text">5.2 监控系统实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E5%A4%8D%E6%9D%82%E5%9C%BA%E6%99%AF%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">1.7.</span> <span class="nav-text">六、复杂场景解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-%E9%95%BF%E5%AF%B9%E8%AF%9D%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AE%A1%E7%90%86"><span class="nav-number">1.7.1.</span> <span class="nav-text">6.1 长对话上下文管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-%E5%A4%9A%E8%BD%AE%E5%A4%8D%E6%9D%82%E6%8E%A8%E7%90%86"><span class="nav-number">1.7.2.</span> <span class="nav-text">6.2 多轮复杂推理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%83%E3%80%81%E6%80%BB%E7%BB%93%E4%B8%8E%E5%B1%95%E6%9C%9B"><span class="nav-number">1.8.</span> <span class="nav-text">七、总结与展望</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-%E6%A1%86%E6%9E%B6%E6%A0%B8%E5%BF%83%E4%BC%98%E5%8A%BF"><span class="nav-number">1.8.1.</span> <span class="nav-text">7.1 框架核心优势</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-1-%E6%9E%B6%E6%9E%84%E4%BC%98%E5%8A%BF"><span class="nav-number">1.8.1.1.</span> <span class="nav-text">7.1.1 架构优势</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-2-%E6%8A%80%E6%9C%AF%E4%BC%98%E5%8A%BF"><span class="nav-number">1.8.1.2.</span> <span class="nav-text">7.1.2 技术优势</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-3-%E5%B7%A5%E7%A8%8B%E4%BC%98%E5%8A%BF"><span class="nav-number">1.8.1.3.</span> <span class="nav-text">7.1.3 工程优势</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-%E9%83%A8%E7%BD%B2%E5%BB%BA%E8%AE%AE"><span class="nav-number">1.8.2.</span> <span class="nav-text">7.2 部署建议</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-1-%E7%A1%AC%E4%BB%B6%E9%85%8D%E7%BD%AE%E5%BB%BA%E8%AE%AE"><span class="nav-number">1.8.2.1.</span> <span class="nav-text">7.2.1 硬件配置建议</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-2-%E9%83%A8%E7%BD%B2%E6%9E%B6%E6%9E%84%E5%BB%BA%E8%AE%AE"><span class="nav-number">1.8.2.2.</span> <span class="nav-text">7.2.2 部署架构建议</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-3-%E9%83%A8%E7%BD%B2%E6%AD%A5%E9%AA%A4"><span class="nav-number">1.8.2.3.</span> <span class="nav-text">7.2.3 部署步骤</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-3-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%BB%BA%E8%AE%AE"><span class="nav-number">1.8.3.</span> <span class="nav-text">7.3 性能优化建议</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-3-1-%E7%B3%BB%E7%BB%9F%E7%BA%A7%E4%BC%98%E5%8C%96"><span class="nav-number">1.8.3.1.</span> <span class="nav-text">7.3.1 系统级优化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-3-2-%E5%BA%94%E7%94%A8%E7%BA%A7%E4%BC%98%E5%8C%96"><span class="nav-number">1.8.3.2.</span> <span class="nav-text">7.3.2 应用级优化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-3-3-%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BC%98%E5%8C%96"><span class="nav-number">1.8.3.3.</span> <span class="nav-text">7.3.3 数据库优化</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-4-%E8%BF%90%E7%BB%B4%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">1.8.4.</span> <span class="nav-text">7.4 运维最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-1-%E7%9B%91%E6%8E%A7%E6%8C%87%E6%A0%87"><span class="nav-number">1.8.4.1.</span> <span class="nav-text">7.4.1 监控指标</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-2-%E5%91%8A%E8%AD%A6%E7%AD%96%E7%95%A5"><span class="nav-number">1.8.4.2.</span> <span class="nav-text">7.4.2 告警策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-3-%E5%AE%B9%E7%81%BE%E6%96%B9%E6%A1%88"><span class="nav-number">1.8.4.3.</span> <span class="nav-text">7.4.3 容灾方案</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-5-%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA%E5%BB%BA%E8%AE%AE"><span class="nav-number">1.8.5.</span> <span class="nav-text">7.5 安全加固建议</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-1-%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8"><span class="nav-number">1.8.5.1.</span> <span class="nav-text">7.5.1 网络安全</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-2-%E5%BA%94%E7%94%A8%E5%AE%89%E5%85%A8"><span class="nav-number">1.8.5.2.</span> <span class="nav-text">7.5.2 应用安全</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-3-%E5%90%88%E8%A7%84%E8%A6%81%E6%B1%82"><span class="nav-number">1.8.5.3.</span> <span class="nav-text">7.5.3 合规要求</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-6-%E6%9C%AA%E6%9D%A5%E5%8F%91%E5%B1%95%E6%96%B9%E5%90%91"><span class="nav-number">1.8.6.</span> <span class="nav-text">7.6 未来发展方向</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-6-1-%E6%8A%80%E6%9C%AF%E6%BC%94%E8%BF%9B"><span class="nav-number">1.8.6.1.</span> <span class="nav-text">7.6.1 技术演进</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-6-2-%E5%8A%9F%E8%83%BD%E6%89%A9%E5%B1%95"><span class="nav-number">1.8.6.2.</span> <span class="nav-text">7.6.2 功能扩展</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-6-3-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-number">1.8.6.3.</span> <span class="nav-text">7.6.3 性能优化</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-7-%E7%BB%93%E8%AF%AD"><span class="nav-number">1.8.7.</span> <span class="nav-text">7.7 结语</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Addroc"
      src="/blog/images/touxiang.jpg">
  <p class="site-author-name" itemprop="name">Addroc</p>
  <div class="site-description" itemprop="description">Addroc's blog</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/blog/archives/">
          <span class="site-state-item-count">21</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/blog/categories/">
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/blog/tags/">
        <span class="site-state-item-count">63</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRlZS5jb20vYWRkcm9j" title="GitHub → https:&#x2F;&#x2F;gitee.com&#x2F;addroc"><i class="fab fa-github fa-fw"></i></span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="bWFpbHRvOmFkZHJvY19zdWVAMTYzLmNvbQ==" title="E-Mail → mailto:addroc_sue@163.com"><i class="fa fa-envelope fa-fw"></i></span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkZHJvY19zdWU=" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;addroc_sue"><i class="fa fa-rss fa-fw"></i></span>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/big/by_nc_sa.svg" alt="Creative Commons"></span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://phoenixsu9.github.io/blog/2025/01/17/%E5%A4%A7%E6%A8%A1%E5%9E%8BAgent%E5%BC%80%E5%8F%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/touxiang.jpg">
      <meta itemprop="name" content="Addroc">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Addroc's Blog">
      <meta itemprop="description" content="Addroc's blog">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="企业级大模型Agent框架架构设计：深度应用与复杂场景突破 | Addroc's Blog">
      <meta itemprop="description" content="我想分享我们团队如何从0到1打造企业级大模型Agent框架的实战经验，包括架构设计中的关键决策、踩过的坑和最佳实践，帮助技术团队快速落地AI应用。">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          企业级大模型Agent框架架构设计：深度应用与复杂场景突破<span class="exturl post-edit-link" data-url="aHR0cHM6Ly9naXRodWIuY29tL25leHQtdGhlbWUvdGhlbWUtbmV4dC1kb2NzL2VkaXQvbWFzdGVyL3NvdXJjZS9fcG9zdHMv5aSn5qih5Z6LQWdlbnTlvIDlj5EubWQ=" title="编辑"><i class="fa fa-pen-nib"></i></span>
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-01-17 13:29:14" itemprop="dateCreated datePublished" datetime="2025-01-17T13:29:14+08:00">2025-01-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/" itemprop="url" rel="index"><span itemprop="name">人工智能</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8/" itemprop="url" rel="index"><span itemprop="name">大模型应用</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/blog/2025/01/17/%E5%A4%A7%E6%A8%A1%E5%9E%8BAgent%E5%BC%80%E5%8F%91/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2025/01/17/大模型Agent开发/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

            <div class="post-description">我想分享我们团队如何从0到1打造企业级大模型Agent框架的实战经验，包括架构设计中的关键决策、踩过的坑和最佳实践，帮助技术团队快速落地AI应用。</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="企业级大模型Agent框架架构设计：深度应用与复杂场景突破"><a href="#企业级大模型Agent框架架构设计：深度应用与复杂场景突破" class="headerlink" title="企业级大模型Agent框架架构设计：深度应用与复杂场景突破"></a>企业级大模型Agent框架架构设计：深度应用与复杂场景突破</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>随着大模型技术的快速发展，企业对智能化应用的需求日益增长。如何构建一个既能支持复杂业务场景，又具备高可用性和可扩展性的大模型Agent框架，成为了技术团队面临的核心挑战。本文将深入剖析企业级大模型Agent框架的架构设计，重点解决多模态融合、复杂推理链、知识图谱集成等关键技术难题。</p>
<h2 id="一、整体架构设计"><a href="#一、整体架构设计" class="headerlink" title="一、整体架构设计"></a>一、整体架构设计</h2><h3 id="1-1-系统架构概览"><a href="#1-1-系统架构概览" class="headerlink" title="1.1 系统架构概览"></a>1.1 系统架构概览</h3><p><img src="/blog/images/%E5%A4%A7%E6%A8%A1%E5%9E%8B/%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%A4%A7%E6%A8%A1%E5%9E%8BAgent%E6%A1%86%E6%9E%B6%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1.png" alt="企业级大模型Agent框架架构设计"></p>
<h3 id="1-2-核心设计原则"><a href="#1-2-核心设计原则" class="headerlink" title="1.2 核心设计原则"></a>1.2 核心设计原则</h3><h4 id="1-2-1-模块化与可扩展性"><a href="#1-2-1-模块化与可扩展性" class="headerlink" title="1.2.1 模块化与可扩展性"></a>1.2.1 模块化与可扩展性</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABC, abstractmethod</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">Any</span>, <span class="type">List</span>, <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AgentType</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Agent类型枚举&quot;&quot;&quot;</span></span><br><span class="line">    CHAT = <span class="string">&quot;chat&quot;</span></span><br><span class="line">    RAG = <span class="string">&quot;rag&quot;</span></span><br><span class="line">    CODE_GEN = <span class="string">&quot;code_generation&quot;</span></span><br><span class="line">    DATA_ANALYSIS = <span class="string">&quot;data_analysis&quot;</span></span><br><span class="line">    MULTIMODAL = <span class="string">&quot;multimodal&quot;</span></span><br><span class="line">    TOOL = <span class="string">&quot;tool&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AgentCapability</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Agent能力定义&quot;&quot;&quot;</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="built_in">str</span></span><br><span class="line">    input_types: <span class="type">List</span>[<span class="built_in">str</span>]</span><br><span class="line">    output_types: <span class="type">List</span>[<span class="built_in">str</span>]</span><br><span class="line">    required_models: <span class="type">List</span>[<span class="built_in">str</span>]</span><br><span class="line">    optional_tools: <span class="type">List</span>[<span class="built_in">str</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BaseAgent</span>(<span class="title class_ inherited__">ABC</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Agent基类 - 定义标准接口&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, agent_id: <span class="built_in">str</span>, config: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">        <span class="variable language_">self</span>.agent_id = agent_id</span><br><span class="line">        <span class="variable language_">self</span>.config = config</span><br><span class="line">        <span class="variable language_">self</span>.capabilities = <span class="variable language_">self</span>._define_capabilities()</span><br><span class="line">        <span class="variable language_">self</span>.state = &#123;&#125;</span><br><span class="line">        </span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_define_capabilities</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[AgentCapability]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;定义Agent能力&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">process</span>(<span class="params">self, input_data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;处理输入数据&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">validate_input</span>(<span class="params">self, input_data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;验证输入数据&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">pre_process</span>(<span class="params">self, input_data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;预处理钩子&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> input_data</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">post_process</span>(<span class="params">self, output_data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;后处理钩子&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> output_data</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_metrics</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取性能指标&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;agent_id&quot;</span>: <span class="variable language_">self</span>.agent_id,</span><br><span class="line">            <span class="string">&quot;processed_requests&quot;</span>: <span class="built_in">getattr</span>(<span class="variable language_">self</span>, <span class="string">&#x27;_processed_requests&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">            <span class="string">&quot;avg_response_time&quot;</span>: <span class="built_in">getattr</span>(<span class="variable language_">self</span>, <span class="string">&#x27;_avg_response_time&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">            <span class="string">&quot;success_rate&quot;</span>: <span class="built_in">getattr</span>(<span class="variable language_">self</span>, <span class="string">&#x27;_success_rate&#x27;</span>, <span class="number">1.0</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AgentRegistry</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Agent注册中心&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>._agents: <span class="type">Dict</span>[<span class="built_in">str</span>, BaseAgent] = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>._capabilities: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">List</span>[<span class="built_in">str</span>]] = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">register_agent</span>(<span class="params">self, agent: BaseAgent</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;注册Agent&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>._agents[agent.agent_id] = agent</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 构建能力索引</span></span><br><span class="line">        <span class="keyword">for</span> capability <span class="keyword">in</span> agent.capabilities:</span><br><span class="line">            <span class="keyword">if</span> capability.name <span class="keyword">not</span> <span class="keyword">in</span> <span class="variable language_">self</span>._capabilities:</span><br><span class="line">                <span class="variable language_">self</span>._capabilities[capability.name] = []</span><br><span class="line">            <span class="variable language_">self</span>._capabilities[capability.name].append(agent.agent_id)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_agent</span>(<span class="params">self, agent_id: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[BaseAgent]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取Agent实例&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>._agents.get(agent_id)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_agents_by_capability</span>(<span class="params">self, capability: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[BaseAgent]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;根据能力查找Agent&quot;&quot;&quot;</span></span><br><span class="line">        agent_ids = <span class="variable language_">self</span>._capabilities.get(capability, [])</span><br><span class="line">        <span class="keyword">return</span> [<span class="variable language_">self</span>._agents[aid] <span class="keyword">for</span> aid <span class="keyword">in</span> agent_ids <span class="keyword">if</span> aid <span class="keyword">in</span> <span class="variable language_">self</span>._agents]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">list_all_agents</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[BaseAgent]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;列出所有Agent&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">list</span>(<span class="variable language_">self</span>._agents.values())</span><br></pre></td></tr></table></figure>

<h4 id="1-2-2-异步处理与并发控制"><a href="#1-2-2-异步处理与并发控制" class="headerlink" title="1.2.2 异步处理与并发控制"></a>1.2.2 异步处理与并发控制</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">from</span> asyncio <span class="keyword">import</span> Semaphore, Queue</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Callable</span>, <span class="type">Coroutine</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> contextlib <span class="keyword">import</span> asynccontextmanager</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AsyncTaskManager</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;异步任务管理器&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, max_concurrent_tasks: <span class="built_in">int</span> = <span class="number">100</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.max_concurrent_tasks = max_concurrent_tasks</span><br><span class="line">        <span class="variable language_">self</span>.semaphore = Semaphore(max_concurrent_tasks)</span><br><span class="line">        <span class="variable language_">self</span>.task_queue = Queue()</span><br><span class="line">        <span class="variable language_">self</span>.active_tasks = <span class="built_in">set</span>()</span><br><span class="line">        <span class="variable language_">self</span>.metrics = &#123;</span><br><span class="line">            <span class="string">&#x27;total_tasks&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&#x27;completed_tasks&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&#x27;failed_tasks&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&#x27;avg_execution_time&#x27;</span>: <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @asynccontextmanager</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">task_context</span>(<span class="params">self, task_id: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;任务执行上下文&quot;&quot;&quot;</span></span><br><span class="line">        start_time = time.time()</span><br><span class="line">        <span class="variable language_">self</span>.metrics[<span class="string">&#x27;total_tasks&#x27;</span>] += <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">async</span> <span class="keyword">with</span> <span class="variable language_">self</span>.semaphore:</span><br><span class="line">                <span class="variable language_">self</span>.active_tasks.add(task_id)</span><br><span class="line">                <span class="keyword">yield</span></span><br><span class="line">                <span class="variable language_">self</span>.metrics[<span class="string">&#x27;completed_tasks&#x27;</span>] += <span class="number">1</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="variable language_">self</span>.metrics[<span class="string">&#x27;failed_tasks&#x27;</span>] += <span class="number">1</span></span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            <span class="variable language_">self</span>.active_tasks.discard(task_id)</span><br><span class="line">            execution_time = time.time() - start_time</span><br><span class="line">            <span class="variable language_">self</span>._update_avg_execution_time(execution_time)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_update_avg_execution_time</span>(<span class="params">self, execution_time: <span class="built_in">float</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;更新平均执行时间&quot;&quot;&quot;</span></span><br><span class="line">        total_completed = <span class="variable language_">self</span>.metrics[<span class="string">&#x27;completed_tasks&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> total_completed &gt; <span class="number">0</span>:</span><br><span class="line">            current_avg = <span class="variable language_">self</span>.metrics[<span class="string">&#x27;avg_execution_time&#x27;</span>]</span><br><span class="line">            <span class="variable language_">self</span>.metrics[<span class="string">&#x27;avg_execution_time&#x27;</span>] = (</span><br><span class="line">                (current_avg * (total_completed - <span class="number">1</span>) + execution_time) / total_completed</span><br><span class="line">            )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">execute_task</span>(<span class="params">self, task_func: <span class="type">Callable</span>, *args, **kwargs</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;执行异步任务&quot;&quot;&quot;</span></span><br><span class="line">        task_id = <span class="string">f&quot;task_<span class="subst">&#123;<span class="built_in">int</span>(time.time() * <span class="number">1000000</span>)&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> <span class="variable language_">self</span>.task_context(task_id):</span><br><span class="line">            <span class="keyword">if</span> asyncio.iscoroutinefunction(task_func):</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">await</span> task_func(*args, **kwargs)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> task_func(*args, **kwargs)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">execute_batch</span>(<span class="params">self, tasks: <span class="type">List</span>[<span class="type">Callable</span>], *args, **kwargs</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;批量执行任务&quot;&quot;&quot;</span></span><br><span class="line">        results = []</span><br><span class="line">        async_tasks = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> task <span class="keyword">in</span> tasks:</span><br><span class="line">            async_task = <span class="variable language_">self</span>.execute_task(task, *args, **kwargs)</span><br><span class="line">            async_tasks.append(async_task)</span><br><span class="line">        </span><br><span class="line">        results = <span class="keyword">await</span> asyncio.gather(*async_tasks, return_exceptions=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> results</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_status</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取任务管理器状态&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;active_tasks&#x27;</span>: <span class="built_in">len</span>(<span class="variable language_">self</span>.active_tasks),</span><br><span class="line">            <span class="string">&#x27;available_slots&#x27;</span>: <span class="variable language_">self</span>.max_concurrent_tasks - <span class="built_in">len</span>(<span class="variable language_">self</span>.active_tasks),</span><br><span class="line">            <span class="string">&#x27;metrics&#x27;</span>: <span class="variable language_">self</span>.metrics.copy()</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h2 id="二、核心组件深度解析"><a href="#二、核心组件深度解析" class="headerlink" title="二、核心组件深度解析"></a>二、核心组件深度解析</h2><h3 id="2-1-Agent编排器设计"><a href="#2-1-Agent编排器设计" class="headerlink" title="2.1 Agent编排器设计"></a>2.1 Agent编排器设计</h3><h4 id="2-1-1-智能路由与负载均衡"><a href="#2-1-1-智能路由与负载均衡" class="headerlink" title="2.1.1 智能路由与负载均衡"></a>2.1.1 智能路由与负载均衡</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Optional</span>, <span class="type">Tuple</span></span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RoutingStrategy</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;路由策略&quot;&quot;&quot;</span></span><br><span class="line">    ROUND_ROBIN = <span class="string">&quot;round_robin&quot;</span></span><br><span class="line">    WEIGHTED_ROUND_ROBIN = <span class="string">&quot;weighted_round_robin&quot;</span></span><br><span class="line">    LEAST_CONNECTIONS = <span class="string">&quot;least_connections&quot;</span></span><br><span class="line">    RESPONSE_TIME = <span class="string">&quot;response_time&quot;</span></span><br><span class="line">    CAPABILITY_BASED = <span class="string">&quot;capability_based&quot;</span></span><br><span class="line">    INTELLIGENT = <span class="string">&quot;intelligent&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AgentInstance</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Agent实例信息&quot;&quot;&quot;</span></span><br><span class="line">    agent_id: <span class="built_in">str</span></span><br><span class="line">    instance_id: <span class="built_in">str</span></span><br><span class="line">    host: <span class="built_in">str</span></span><br><span class="line">    port: <span class="built_in">int</span></span><br><span class="line">    weight: <span class="built_in">float</span> = <span class="number">1.0</span></span><br><span class="line">    current_load: <span class="built_in">int</span> = <span class="number">0</span></span><br><span class="line">    avg_response_time: <span class="built_in">float</span> = <span class="number">0.0</span></span><br><span class="line">    success_rate: <span class="built_in">float</span> = <span class="number">1.0</span></span><br><span class="line">    last_health_check: <span class="built_in">float</span> = <span class="number">0.0</span></span><br><span class="line">    is_healthy: <span class="built_in">bool</span> = <span class="literal">True</span></span><br><span class="line">    capabilities: <span class="type">List</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IntelligentRouter</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;智能路由器&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.agents: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">List</span>[AgentInstance]] = defaultdict(<span class="built_in">list</span>)</span><br><span class="line">        <span class="variable language_">self</span>.routing_strategies: <span class="type">Dict</span>[<span class="built_in">str</span>, RoutingStrategy] = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.load_balancer = LoadBalancer()</span><br><span class="line">        <span class="variable language_">self</span>.health_monitor = HealthMonitor()</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">register_agent_instance</span>(<span class="params">self, agent_type: <span class="built_in">str</span>, instance: AgentInstance</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;注册Agent实例&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.agents[agent_type].append(instance)</span><br><span class="line">        <span class="variable language_">self</span>.health_monitor.add_instance(instance)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">route_request</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                           agent_type: <span class="built_in">str</span>, </span></span><br><span class="line"><span class="params">                           request_context: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>],</span></span><br><span class="line"><span class="params">                           strategy: <span class="type">Optional</span>[RoutingStrategy] = <span class="literal">None</span></span>) -&gt; <span class="type">Optional</span>[AgentInstance]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;路由请求到合适的Agent实例&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        available_instances = <span class="variable language_">self</span>._get_healthy_instances(agent_type)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> available_instances:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 选择路由策略</span></span><br><span class="line">        effective_strategy = strategy <span class="keyword">or</span> <span class="variable language_">self</span>.routing_strategies.get(</span><br><span class="line">            agent_type, RoutingStrategy.INTELLIGENT</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> effective_strategy == RoutingStrategy.INTELLIGENT:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> <span class="variable language_">self</span>._intelligent_routing(available_instances, request_context)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.load_balancer.select_instance(available_instances, effective_strategy)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_intelligent_routing</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                                 instances: <span class="type">List</span>[AgentInstance],</span></span><br><span class="line"><span class="params">                                 context: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; AgentInstance:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;智能路由算法&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 计算每个实例的综合得分</span></span><br><span class="line">        scores = []</span><br><span class="line">        <span class="keyword">for</span> instance <span class="keyword">in</span> instances:</span><br><span class="line">            score = <span class="keyword">await</span> <span class="variable language_">self</span>._calculate_instance_score(instance, context)</span><br><span class="line">            scores.append((instance, score))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 按得分排序，选择最佳实例</span></span><br><span class="line">        scores.sort(key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 引入随机性，避免所有请求都路由到同一实例</span></span><br><span class="line">        top_instances = scores[:<span class="built_in">min</span>(<span class="number">3</span>, <span class="built_in">len</span>(scores))]</span><br><span class="line">        weights = [score <span class="keyword">for</span> _, score <span class="keyword">in</span> top_instances]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>._weighted_random_select(</span><br><span class="line">            [instance <span class="keyword">for</span> instance, _ <span class="keyword">in</span> top_instances], </span><br><span class="line">            weights</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_calculate_instance_score</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                                      instance: AgentInstance,</span></span><br><span class="line"><span class="params">                                      context: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;计算实例综合得分&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 基础性能指标 (40%)</span></span><br><span class="line">        performance_score = (</span><br><span class="line">            (<span class="number">1.0</span> - instance.current_load / <span class="number">100.0</span>) * <span class="number">0.4</span> +  <span class="comment"># 负载情况</span></span><br><span class="line">            instance.success_rate * <span class="number">0.3</span> +  <span class="comment"># 成功率</span></span><br><span class="line">            (<span class="number">1.0</span> / (instance.avg_response_time + <span class="number">0.1</span>)) * <span class="number">0.3</span>  <span class="comment"># 响应时间</span></span><br><span class="line">        ) * <span class="number">0.4</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 能力匹配度 (30%)</span></span><br><span class="line">        capability_score = <span class="variable language_">self</span>._calculate_capability_match(instance, context) * <span class="number">0.3</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 历史表现 (20%)</span></span><br><span class="line">        history_score = <span class="variable language_">self</span>._calculate_history_performance(instance) * <span class="number">0.2</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 实时状态 (10%)</span></span><br><span class="line">        real_time_score = <span class="variable language_">self</span>._calculate_real_time_status(instance) * <span class="number">0.1</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> performance_score + capability_score + history_score + real_time_score</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_calculate_capability_match</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                                  instance: AgentInstance,</span></span><br><span class="line"><span class="params">                                  context: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;计算能力匹配度&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> instance.capabilities:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0.5</span>  <span class="comment"># 默认匹配度</span></span><br><span class="line">        </span><br><span class="line">        required_capabilities = context.get(<span class="string">&#x27;required_capabilities&#x27;</span>, [])</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> required_capabilities:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1.0</span></span><br><span class="line">        </span><br><span class="line">        matched = <span class="built_in">len</span>(<span class="built_in">set</span>(instance.capabilities) &amp; <span class="built_in">set</span>(required_capabilities))</span><br><span class="line">        <span class="keyword">return</span> matched / <span class="built_in">len</span>(required_capabilities)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_weighted_random_select</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                               instances: <span class="type">List</span>[AgentInstance],</span></span><br><span class="line"><span class="params">                               weights: <span class="type">List</span>[<span class="built_in">float</span>]</span>) -&gt; AgentInstance:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;加权随机选择&quot;&quot;&quot;</span></span><br><span class="line">        total_weight = <span class="built_in">sum</span>(weights)</span><br><span class="line">        <span class="keyword">if</span> total_weight == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> random.choice(instances)</span><br><span class="line">        </span><br><span class="line">        normalized_weights = [w / total_weight <span class="keyword">for</span> w <span class="keyword">in</span> weights]</span><br><span class="line">        <span class="keyword">return</span> random.choices(instances, weights=normalized_weights)[<span class="number">0</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_healthy_instances</span>(<span class="params">self, agent_type: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[AgentInstance]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取健康的实例&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            instance <span class="keyword">for</span> instance <span class="keyword">in</span> <span class="variable language_">self</span>.agents[agent_type]</span><br><span class="line">            <span class="keyword">if</span> instance.is_healthy</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LoadBalancer</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;负载均衡器&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.round_robin_counters = defaultdict(<span class="built_in">int</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">select_instance</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                       instances: <span class="type">List</span>[AgentInstance],</span></span><br><span class="line"><span class="params">                       strategy: RoutingStrategy</span>) -&gt; AgentInstance:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;根据策略选择实例&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> strategy == RoutingStrategy.ROUND_ROBIN:</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>._round_robin_select(instances)</span><br><span class="line">        <span class="keyword">elif</span> strategy == RoutingStrategy.WEIGHTED_ROUND_ROBIN:</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>._weighted_round_robin_select(instances)</span><br><span class="line">        <span class="keyword">elif</span> strategy == RoutingStrategy.LEAST_CONNECTIONS:</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>._least_connections_select(instances)</span><br><span class="line">        <span class="keyword">elif</span> strategy == RoutingStrategy.RESPONSE_TIME:</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>._response_time_select(instances)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> random.choice(instances)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_round_robin_select</span>(<span class="params">self, instances: <span class="type">List</span>[AgentInstance]</span>) -&gt; AgentInstance:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;轮询选择&quot;&quot;&quot;</span></span><br><span class="line">        key = <span class="built_in">id</span>(instances)  <span class="comment"># 使用实例列表的ID作为键</span></span><br><span class="line">        index = <span class="variable language_">self</span>.round_robin_counters[key] % <span class="built_in">len</span>(instances)</span><br><span class="line">        <span class="variable language_">self</span>.round_robin_counters[key] += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> instances[index]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_least_connections_select</span>(<span class="params">self, instances: <span class="type">List</span>[AgentInstance]</span>) -&gt; AgentInstance:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;最少连接选择&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">min</span>(instances, key=<span class="keyword">lambda</span> x: x.current_load)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_response_time_select</span>(<span class="params">self, instances: <span class="type">List</span>[AgentInstance]</span>) -&gt; AgentInstance:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;最短响应时间选择&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">min</span>(instances, key=<span class="keyword">lambda</span> x: x.avg_response_time)</span><br></pre></td></tr></table></figure>

<h4 id="2-1-2-工作流引擎"><a href="#2-1-2-工作流引擎" class="headerlink" title="2.1.2 工作流引擎"></a>2.1.2 工作流引擎</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Any</span>, <span class="type">Optional</span>, <span class="type">Callable</span>, <span class="type">Union</span></span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass, field</span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NodeType</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;节点类型&quot;&quot;&quot;</span></span><br><span class="line">    START = <span class="string">&quot;start&quot;</span></span><br><span class="line">    END = <span class="string">&quot;end&quot;</span></span><br><span class="line">    AGENT = <span class="string">&quot;agent&quot;</span></span><br><span class="line">    CONDITION = <span class="string">&quot;condition&quot;</span></span><br><span class="line">    PARALLEL = <span class="string">&quot;parallel&quot;</span></span><br><span class="line">    MERGE = <span class="string">&quot;merge&quot;</span></span><br><span class="line">    LOOP = <span class="string">&quot;loop&quot;</span></span><br><span class="line">    HUMAN = <span class="string">&quot;human&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ExecutionStatus</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;执行状态&quot;&quot;&quot;</span></span><br><span class="line">    PENDING = <span class="string">&quot;pending&quot;</span></span><br><span class="line">    RUNNING = <span class="string">&quot;running&quot;</span></span><br><span class="line">    COMPLETED = <span class="string">&quot;completed&quot;</span></span><br><span class="line">    FAILED = <span class="string">&quot;failed&quot;</span></span><br><span class="line">    CANCELLED = <span class="string">&quot;cancelled&quot;</span></span><br><span class="line">    WAITING = <span class="string">&quot;waiting&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WorkflowNode</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;工作流节点&quot;&quot;&quot;</span></span><br><span class="line">    node_id: <span class="built_in">str</span></span><br><span class="line">    node_type: NodeType</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    config: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>] = field(default_factory=<span class="built_in">dict</span>)</span><br><span class="line">    inputs: <span class="type">List</span>[<span class="built_in">str</span>] = field(default_factory=<span class="built_in">list</span>)</span><br><span class="line">    outputs: <span class="type">List</span>[<span class="built_in">str</span>] = field(default_factory=<span class="built_in">list</span>)</span><br><span class="line">    conditions: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>] = field(default_factory=<span class="built_in">dict</span>)</span><br><span class="line">    retry_config: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>] = field(default_factory=<span class="built_in">dict</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WorkflowEdge</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;工作流边&quot;&quot;&quot;</span></span><br><span class="line">    from_node: <span class="built_in">str</span></span><br><span class="line">    to_node: <span class="built_in">str</span></span><br><span class="line">    condition: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    weight: <span class="built_in">float</span> = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WorkflowDefinition</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;工作流定义&quot;&quot;&quot;</span></span><br><span class="line">    workflow_id: <span class="built_in">str</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="built_in">str</span></span><br><span class="line">    nodes: <span class="type">List</span>[WorkflowNode]</span><br><span class="line">    edges: <span class="type">List</span>[WorkflowEdge]</span><br><span class="line">    global_config: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>] = field(default_factory=<span class="built_in">dict</span>)</span><br><span class="line">    version: <span class="built_in">str</span> = <span class="string">&quot;1.0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WorkflowEngine</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;工作流引擎&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, agent_registry: AgentRegistry</span>):</span><br><span class="line">        <span class="variable language_">self</span>.agent_registry = agent_registry</span><br><span class="line">        <span class="variable language_">self</span>.active_executions: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="string">&#x27;WorkflowExecution&#x27;</span>] = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.execution_history: <span class="type">List</span>[<span class="string">&#x27;WorkflowExecution&#x27;</span>] = []</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">execute_workflow</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                             workflow_def: WorkflowDefinition,</span></span><br><span class="line"><span class="params">                             input_data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>],</span></span><br><span class="line"><span class="params">                             context: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>] = <span class="literal">None</span></span>) -&gt; <span class="string">&#x27;WorkflowExecution&#x27;</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;执行工作流&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        execution_id = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">        execution = WorkflowExecution(</span><br><span class="line">            execution_id=execution_id,</span><br><span class="line">            workflow_def=workflow_def,</span><br><span class="line">            input_data=input_data,</span><br><span class="line">            context=context <span class="keyword">or</span> &#123;&#125;,</span><br><span class="line">            engine=<span class="variable language_">self</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.active_executions[execution_id] = execution</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">await</span> execution.start()</span><br><span class="line">            <span class="keyword">return</span> execution</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            execution.status = ExecutionStatus.FAILED</span><br><span class="line">            execution.error = <span class="built_in">str</span>(e)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            <span class="variable language_">self</span>.execution_history.append(execution)</span><br><span class="line">            <span class="keyword">if</span> execution_id <span class="keyword">in</span> <span class="variable language_">self</span>.active_executions:</span><br><span class="line">                <span class="keyword">del</span> <span class="variable language_">self</span>.active_executions[execution_id]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">cancel_execution</span>(<span class="params">self, execution_id: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;取消执行&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> execution_id <span class="keyword">in</span> <span class="variable language_">self</span>.active_executions:</span><br><span class="line">            execution = <span class="variable language_">self</span>.active_executions[execution_id]</span><br><span class="line">            <span class="keyword">await</span> execution.cancel()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_execution_status</span>(<span class="params">self, execution_id: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取执行状态&quot;&quot;&quot;</span></span><br><span class="line">        execution = <span class="variable language_">self</span>.active_executions.get(execution_id)</span><br><span class="line">        <span class="keyword">if</span> execution:</span><br><span class="line">            <span class="keyword">return</span> execution.get_status()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 查找历史记录</span></span><br><span class="line">        <span class="keyword">for</span> exec_history <span class="keyword">in</span> <span class="variable language_">self</span>.execution_history:</span><br><span class="line">            <span class="keyword">if</span> exec_history.execution_id == execution_id:</span><br><span class="line">                <span class="keyword">return</span> exec_history.get_status()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WorkflowExecution</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;工作流执行实例&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                 execution_id: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">                 workflow_def: WorkflowDefinition,</span></span><br><span class="line"><span class="params">                 input_data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>],</span></span><br><span class="line"><span class="params">                 context: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>],</span></span><br><span class="line"><span class="params">                 engine: WorkflowEngine</span>):</span><br><span class="line">        <span class="variable language_">self</span>.execution_id = execution_id</span><br><span class="line">        <span class="variable language_">self</span>.workflow_def = workflow_def</span><br><span class="line">        <span class="variable language_">self</span>.input_data = input_data</span><br><span class="line">        <span class="variable language_">self</span>.context = context</span><br><span class="line">        <span class="variable language_">self</span>.engine = engine</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.status = ExecutionStatus.PENDING</span><br><span class="line">        <span class="variable language_">self</span>.start_time = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.end_time = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.error = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.result = <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 节点执行状态</span></span><br><span class="line">        <span class="variable language_">self</span>.node_status: <span class="type">Dict</span>[<span class="built_in">str</span>, ExecutionStatus] = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.node_results: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>] = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.node_errors: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">str</span>] = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 构建执行图</span></span><br><span class="line">        <span class="variable language_">self</span>.execution_graph = <span class="variable language_">self</span>._build_execution_graph()</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_build_execution_graph</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">List</span>[<span class="built_in">str</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;构建执行图&quot;&quot;&quot;</span></span><br><span class="line">        graph = defaultdict(<span class="built_in">list</span>)</span><br><span class="line">        <span class="keyword">for</span> edge <span class="keyword">in</span> <span class="variable language_">self</span>.workflow_def.edges:</span><br><span class="line">            graph[edge.from_node].append(edge.to_node)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">dict</span>(graph)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">start</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;开始执行&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.status = ExecutionStatus.RUNNING</span><br><span class="line">        <span class="variable language_">self</span>.start_time = datetime.now()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 找到开始节点</span></span><br><span class="line">        start_nodes = [</span><br><span class="line">            node <span class="keyword">for</span> node <span class="keyword">in</span> <span class="variable language_">self</span>.workflow_def.nodes</span><br><span class="line">            <span class="keyword">if</span> node.node_type == NodeType.START</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> start_nodes:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;No start node found in workflow&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 执行工作流</span></span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">self</span>._execute_node(start_nodes[<span class="number">0</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查执行结果</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.status == ExecutionStatus.RUNNING:</span><br><span class="line">            <span class="variable language_">self</span>.status = ExecutionStatus.COMPLETED</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.end_time = datetime.now()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_execute_node</span>(<span class="params">self, node: WorkflowNode</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;执行节点&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="variable language_">self</span>.node_status[node.node_id] = ExecutionStatus.RUNNING</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> node.node_type == NodeType.START:</span><br><span class="line">                result = <span class="variable language_">self</span>.input_data</span><br><span class="line">            <span class="keyword">elif</span> node.node_type == NodeType.END:</span><br><span class="line">                result = <span class="variable language_">self</span>._collect_final_result()</span><br><span class="line">            <span class="keyword">elif</span> node.node_type == NodeType.AGENT:</span><br><span class="line">                result = <span class="keyword">await</span> <span class="variable language_">self</span>._execute_agent_node(node)</span><br><span class="line">            <span class="keyword">elif</span> node.node_type == NodeType.CONDITION:</span><br><span class="line">                result = <span class="keyword">await</span> <span class="variable language_">self</span>._execute_condition_node(node)</span><br><span class="line">            <span class="keyword">elif</span> node.node_type == NodeType.PARALLEL:</span><br><span class="line">                result = <span class="keyword">await</span> <span class="variable language_">self</span>._execute_parallel_node(node)</span><br><span class="line">            <span class="keyword">elif</span> node.node_type == NodeType.LOOP:</span><br><span class="line">                result = <span class="keyword">await</span> <span class="variable language_">self</span>._execute_loop_node(node)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Unsupported node type: <span class="subst">&#123;node.node_type&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">self</span>.node_status[node.node_id] = ExecutionStatus.COMPLETED</span><br><span class="line">            <span class="variable language_">self</span>.node_results[node.node_id] = result</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 执行后续节点</span></span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">self</span>._execute_next_nodes(node)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="variable language_">self</span>.node_status[node.node_id] = ExecutionStatus.FAILED</span><br><span class="line">            <span class="variable language_">self</span>.node_errors[node.node_id] = <span class="built_in">str</span>(e)</span><br><span class="line">            <span class="variable language_">self</span>.status = ExecutionStatus.FAILED</span><br><span class="line">            <span class="variable language_">self</span>.error = <span class="built_in">str</span>(e)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_execute_agent_node</span>(<span class="params">self, node: WorkflowNode</span>) -&gt; <span class="type">Any</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;执行Agent节点&quot;&quot;&quot;</span></span><br><span class="line">        agent_type = node.config.get(<span class="string">&#x27;agent_type&#x27;</span>)</span><br><span class="line">        agent_config = node.config.get(<span class="string">&#x27;agent_config&#x27;</span>, &#123;&#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 获取Agent实例</span></span><br><span class="line">        agent = <span class="variable language_">self</span>.engine.agent_registry.get_agent(agent_type)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> agent:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Agent not found: <span class="subst">&#123;agent_type&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 准备输入数据</span></span><br><span class="line">        input_data = <span class="variable language_">self</span>._prepare_node_input(node)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 执行Agent</span></span><br><span class="line">        result = <span class="keyword">await</span> agent.process(input_data)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_execute_condition_node</span>(<span class="params">self, node: WorkflowNode</span>) -&gt; <span class="type">Any</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;执行条件节点&quot;&quot;&quot;</span></span><br><span class="line">        condition_expr = node.config.get(<span class="string">&#x27;condition&#x27;</span>)</span><br><span class="line">        input_data = <span class="variable language_">self</span>._prepare_node_input(node)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 评估条件</span></span><br><span class="line">        condition_result = <span class="variable language_">self</span>._evaluate_condition(condition_expr, input_data)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;condition_result&#x27;</span>: condition_result,</span><br><span class="line">            <span class="string">&#x27;input_data&#x27;</span>: input_data</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_execute_parallel_node</span>(<span class="params">self, node: WorkflowNode</span>) -&gt; <span class="type">Any</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;执行并行节点&quot;&quot;&quot;</span></span><br><span class="line">        parallel_tasks = []</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 获取并行执行的子节点</span></span><br><span class="line">        child_nodes = node.config.get(<span class="string">&#x27;child_nodes&#x27;</span>, [])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> child_node_id <span class="keyword">in</span> child_nodes:</span><br><span class="line">            child_node = <span class="variable language_">self</span>._find_node_by_id(child_node_id)</span><br><span class="line">            <span class="keyword">if</span> child_node:</span><br><span class="line">                task = <span class="variable language_">self</span>._execute_node(child_node)</span><br><span class="line">                parallel_tasks.append(task)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 等待所有并行任务完成</span></span><br><span class="line">        results = <span class="keyword">await</span> asyncio.gather(*parallel_tasks, return_exceptions=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;parallel_results&#x27;</span>: results,</span><br><span class="line">            <span class="string">&#x27;completed_tasks&#x27;</span>: <span class="built_in">len</span>([r <span class="keyword">for</span> r <span class="keyword">in</span> results <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(r, Exception)])</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_prepare_node_input</span>(<span class="params">self, node: WorkflowNode</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;准备节点输入数据&quot;&quot;&quot;</span></span><br><span class="line">        input_data = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 收集前置节点的输出</span></span><br><span class="line">        <span class="keyword">for</span> input_source <span class="keyword">in</span> node.inputs:</span><br><span class="line">            <span class="keyword">if</span> input_source <span class="keyword">in</span> <span class="variable language_">self</span>.node_results:</span><br><span class="line">                input_data[input_source] = <span class="variable language_">self</span>.node_results[input_source]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 如果没有前置节点，使用工作流输入</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> input_data:</span><br><span class="line">            input_data = <span class="variable language_">self</span>.input_data</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 添加上下文信息</span></span><br><span class="line">        input_data[<span class="string">&#x27;_context&#x27;</span>] = <span class="variable language_">self</span>.context</span><br><span class="line">        input_data[<span class="string">&#x27;_execution_id&#x27;</span>] = <span class="variable language_">self</span>.execution_id</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> input_data</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_evaluate_condition</span>(<span class="params">self, condition_expr: <span class="built_in">str</span>, data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;评估条件表达式&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 简单的条件评估实现</span></span><br><span class="line">        <span class="comment"># 在实际应用中，可以使用更复杂的表达式引擎</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 创建安全的执行环境</span></span><br><span class="line">            safe_dict = &#123;</span><br><span class="line">                <span class="string">&#x27;data&#x27;</span>: data,</span><br><span class="line">                <span class="string">&#x27;len&#x27;</span>: <span class="built_in">len</span>,</span><br><span class="line">                <span class="string">&#x27;str&#x27;</span>: <span class="built_in">str</span>,</span><br><span class="line">                <span class="string">&#x27;int&#x27;</span>: <span class="built_in">int</span>,</span><br><span class="line">                <span class="string">&#x27;float&#x27;</span>: <span class="built_in">float</span>,</span><br><span class="line">                <span class="string">&#x27;bool&#x27;</span>: <span class="built_in">bool</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">eval</span>(condition_expr, &#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125;, safe_dict)</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_status</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取执行状态&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;execution_id&#x27;</span>: <span class="variable language_">self</span>.execution_id,</span><br><span class="line">            <span class="string">&#x27;workflow_id&#x27;</span>: <span class="variable language_">self</span>.workflow_def.workflow_id,</span><br><span class="line">            <span class="string">&#x27;status&#x27;</span>: <span class="variable language_">self</span>.status.value,</span><br><span class="line">            <span class="string">&#x27;start_time&#x27;</span>: <span class="variable language_">self</span>.start_time.isoformat() <span class="keyword">if</span> <span class="variable language_">self</span>.start_time <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">            <span class="string">&#x27;end_time&#x27;</span>: <span class="variable language_">self</span>.end_time.isoformat() <span class="keyword">if</span> <span class="variable language_">self</span>.end_time <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">            <span class="string">&#x27;error&#x27;</span>: <span class="variable language_">self</span>.error,</span><br><span class="line">            <span class="string">&#x27;node_status&#x27;</span>: &#123;k: v.value <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="variable language_">self</span>.node_status.items()&#125;,</span><br><span class="line">            <span class="string">&#x27;progress&#x27;</span>: <span class="variable language_">self</span>._calculate_progress()</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_calculate_progress</span>(<span class="params">self</span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;计算执行进度&quot;&quot;&quot;</span></span><br><span class="line">        total_nodes = <span class="built_in">len</span>(<span class="variable language_">self</span>.workflow_def.nodes)</span><br><span class="line">        completed_nodes = <span class="built_in">len</span>([</span><br><span class="line">            status <span class="keyword">for</span> status <span class="keyword">in</span> <span class="variable language_">self</span>.node_status.values()</span><br><span class="line">            <span class="keyword">if</span> status == ExecutionStatus.COMPLETED</span><br><span class="line">        ])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> completed_nodes / total_nodes <span class="keyword">if</span> total_nodes &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0.0</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-多模态融合Agent"><a href="#2-2-多模态融合Agent" class="headerlink" title="2.2 多模态融合Agent"></a>2.2 多模态融合Agent</h3><h4 id="2-2-1-多模态数据处理"><a href="#2-2-1-多模态数据处理" class="headerlink" title="2.2.1 多模态数据处理"></a>2.2.1 多模态数据处理</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Any</span>, <span class="type">Optional</span>, <span class="type">Union</span>, <span class="type">Tuple</span></span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> librosa</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> AutoProcessor, AutoModel</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ModalityType</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;模态类型&quot;&quot;&quot;</span></span><br><span class="line">    TEXT = <span class="string">&quot;text&quot;</span></span><br><span class="line">    IMAGE = <span class="string">&quot;image&quot;</span></span><br><span class="line">    AUDIO = <span class="string">&quot;audio&quot;</span></span><br><span class="line">    VIDEO = <span class="string">&quot;video&quot;</span></span><br><span class="line">    DOCUMENT = <span class="string">&quot;document&quot;</span></span><br><span class="line">    STRUCTURED_DATA = <span class="string">&quot;structured_data&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ModalityData</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;模态数据&quot;&quot;&quot;</span></span><br><span class="line">    modality_type: ModalityType</span><br><span class="line">    data: <span class="type">Any</span></span><br><span class="line">    metadata: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>] = <span class="literal">None</span></span><br><span class="line">    encoding: <span class="built_in">str</span> = <span class="string">&quot;utf-8&quot;</span></span><br><span class="line">    <span class="built_in">format</span>: <span class="built_in">str</span> = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MultiModalProcessor</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;多模态处理器&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">        <span class="variable language_">self</span>.config = config</span><br><span class="line">        <span class="variable language_">self</span>.processors = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.models = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>._initialize_processors()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_initialize_processors</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;初始化各模态处理器&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 文本处理器</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;text_model&#x27;</span> <span class="keyword">in</span> <span class="variable language_">self</span>.config:</span><br><span class="line">            <span class="variable language_">self</span>.processors[ModalityType.TEXT] = TextProcessor(</span><br><span class="line">                <span class="variable language_">self</span>.config[<span class="string">&#x27;text_model&#x27;</span>]</span><br><span class="line">            )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 图像处理器</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;image_model&#x27;</span> <span class="keyword">in</span> <span class="variable language_">self</span>.config:</span><br><span class="line">            <span class="variable language_">self</span>.processors[ModalityType.IMAGE] = ImageProcessor(</span><br><span class="line">                <span class="variable language_">self</span>.config[<span class="string">&#x27;image_model&#x27;</span>]</span><br><span class="line">            )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 音频处理器</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;audio_model&#x27;</span> <span class="keyword">in</span> <span class="variable language_">self</span>.config:</span><br><span class="line">            <span class="variable language_">self</span>.processors[ModalityType.AUDIO] = AudioProcessor(</span><br><span class="line">                <span class="variable language_">self</span>.config[<span class="string">&#x27;audio_model&#x27;</span>]</span><br><span class="line">            )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 视频处理器</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;video_model&#x27;</span> <span class="keyword">in</span> <span class="variable language_">self</span>.config:</span><br><span class="line">            <span class="variable language_">self</span>.processors[ModalityType.VIDEO] = VideoProcessor(</span><br><span class="line">                <span class="variable language_">self</span>.config[<span class="string">&#x27;video_model&#x27;</span>]</span><br><span class="line">            )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">process_multimodal_input</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                                     inputs: <span class="type">List</span>[ModalityData]</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;处理多模态输入&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        results = &#123;&#125;</span><br><span class="line">        embeddings = []</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 并行处理各模态数据</span></span><br><span class="line">        tasks = []</span><br><span class="line">        <span class="keyword">for</span> modal_data <span class="keyword">in</span> inputs:</span><br><span class="line">            processor = <span class="variable language_">self</span>.processors.get(modal_data.modality_type)</span><br><span class="line">            <span class="keyword">if</span> processor:</span><br><span class="line">                task = processor.process(modal_data)</span><br><span class="line">                tasks.append((modal_data.modality_type, task))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 等待所有处理完成</span></span><br><span class="line">        processed_results = <span class="keyword">await</span> asyncio.gather(</span><br><span class="line">            *[task <span class="keyword">for</span> _, task <span class="keyword">in</span> tasks], </span><br><span class="line">            return_exceptions=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 整理结果</span></span><br><span class="line">        <span class="keyword">for</span> (modality_type, _), result <span class="keyword">in</span> <span class="built_in">zip</span>(tasks, processed_results):</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(result, Exception):</span><br><span class="line">                results[modality_type.value] = result</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&#x27;embedding&#x27;</span> <span class="keyword">in</span> result:</span><br><span class="line">                    embeddings.append(result[<span class="string">&#x27;embedding&#x27;</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 融合多模态特征</span></span><br><span class="line">        <span class="keyword">if</span> embeddings:</span><br><span class="line">            fused_embedding = <span class="variable language_">self</span>._fuse_embeddings(embeddings)</span><br><span class="line">            results[<span class="string">&#x27;fused_embedding&#x27;</span>] = fused_embedding</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> results</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_fuse_embeddings</span>(<span class="params">self, embeddings: <span class="type">List</span>[np.ndarray]</span>) -&gt; np.ndarray:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;融合多模态嵌入&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 简单的平均融合</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(embeddings) == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> embeddings[<span class="number">0</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 确保所有嵌入维度一致</span></span><br><span class="line">        target_dim = embeddings[<span class="number">0</span>].shape[-<span class="number">1</span>]</span><br><span class="line">        normalized_embeddings = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> emb <span class="keyword">in</span> embeddings:</span><br><span class="line">            <span class="keyword">if</span> emb.shape[-<span class="number">1</span>] != target_dim:</span><br><span class="line">                <span class="comment"># 维度对齐</span></span><br><span class="line">                emb = <span class="variable language_">self</span>._align_embedding_dimension(emb, target_dim)</span><br><span class="line">            normalized_embeddings.append(emb)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 加权平均融合</span></span><br><span class="line">        weights = <span class="variable language_">self</span>._calculate_modality_weights(normalized_embeddings)</span><br><span class="line">        fused = np.average(normalized_embeddings, axis=<span class="number">0</span>, weights=weights)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> fused</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_align_embedding_dimension</span>(<span class="params">self, embedding: np.ndarray, target_dim: <span class="built_in">int</span></span>) -&gt; np.ndarray:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;对齐嵌入维度&quot;&quot;&quot;</span></span><br><span class="line">        current_dim = embedding.shape[-<span class="number">1</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> current_dim &gt; target_dim:</span><br><span class="line">            <span class="comment"># 降维 - 使用PCA或简单截断</span></span><br><span class="line">            <span class="keyword">return</span> embedding[:target_dim]</span><br><span class="line">        <span class="keyword">elif</span> current_dim &lt; target_dim:</span><br><span class="line">            <span class="comment"># 升维 - 零填充</span></span><br><span class="line">            padding = target_dim - current_dim</span><br><span class="line">            <span class="keyword">return</span> np.pad(embedding, (<span class="number">0</span>, padding), mode=<span class="string">&#x27;constant&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> embedding</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_calculate_modality_weights</span>(<span class="params">self, embeddings: <span class="type">List</span>[np.ndarray]</span>) -&gt; <span class="type">List</span>[<span class="built_in">float</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;计算模态权重&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 基于嵌入的信息量计算权重</span></span><br><span class="line">        weights = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> emb <span class="keyword">in</span> embeddings:</span><br><span class="line">            <span class="comment"># 使用方差作为信息量的度量</span></span><br><span class="line">            variance = np.var(emb)</span><br><span class="line">            weights.append(variance)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 归一化权重</span></span><br><span class="line">        total_weight = <span class="built_in">sum</span>(weights)</span><br><span class="line">        <span class="keyword">if</span> total_weight &gt; <span class="number">0</span>:</span><br><span class="line">            weights = [w / total_weight <span class="keyword">for</span> w <span class="keyword">in</span> weights]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            weights = [<span class="number">1.0</span> / <span class="built_in">len</span>(embeddings)] * <span class="built_in">len</span>(embeddings)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> weights</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ImageProcessor</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;图像处理器&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, model_config: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">        <span class="variable language_">self</span>.model_config = model_config</span><br><span class="line">        <span class="variable language_">self</span>.model = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.processor = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>._load_model()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_load_model</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;加载图像模型&quot;&quot;&quot;</span></span><br><span class="line">        model_name = <span class="variable language_">self</span>.model_config.get(<span class="string">&#x27;model_name&#x27;</span>, <span class="string">&#x27;openai/clip-vit-base-patch32&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="variable language_">self</span>.processor = AutoProcessor.from_pretrained(model_name)</span><br><span class="line">            <span class="variable language_">self</span>.model = AutoModel.from_pretrained(model_name)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Failed to load image model: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">process</span>(<span class="params">self, modal_data: ModalityData</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;处理图像数据&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 解码图像数据</span></span><br><span class="line">        image = <span class="variable language_">self</span>._decode_image(modal_data.data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 图像预处理</span></span><br><span class="line">        processed_image = <span class="variable language_">self</span>._preprocess_image(image)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 特征提取</span></span><br><span class="line">        features = <span class="keyword">await</span> <span class="variable language_">self</span>._extract_features(processed_image)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 图像分析</span></span><br><span class="line">        analysis = <span class="keyword">await</span> <span class="variable language_">self</span>._analyze_image(processed_image)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;image_info&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;size&#x27;</span>: image.size,</span><br><span class="line">                <span class="string">&#x27;mode&#x27;</span>: image.mode,</span><br><span class="line">                <span class="string">&#x27;format&#x27;</span>: modal_data.<span class="built_in">format</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;features&#x27;</span>: features,</span><br><span class="line">            <span class="string">&#x27;analysis&#x27;</span>: analysis,</span><br><span class="line">            <span class="string">&#x27;embedding&#x27;</span>: features.get(<span class="string">&#x27;embedding&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_decode_image</span>(<span class="params">self, data: <span class="type">Any</span></span>) -&gt; Image.Image:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;解码图像数据&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(data, <span class="built_in">str</span>):</span><br><span class="line">            <span class="comment"># Base64编码的图像</span></span><br><span class="line">            <span class="keyword">if</span> data.startswith(<span class="string">&#x27;data:image&#x27;</span>):</span><br><span class="line">                <span class="comment"># 移除data URL前缀</span></span><br><span class="line">                data = data.split(<span class="string">&#x27;,&#x27;</span>)[<span class="number">1</span>]</span><br><span class="line">            </span><br><span class="line">            image_bytes = base64.b64decode(data)</span><br><span class="line">            <span class="keyword">return</span> Image.<span class="built_in">open</span>(io.BytesIO(image_bytes))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(data, <span class="built_in">bytes</span>):</span><br><span class="line">            <span class="keyword">return</span> Image.<span class="built_in">open</span>(io.BytesIO(data))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(data, Image.Image):</span><br><span class="line">            <span class="keyword">return</span> data</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Unsupported image data type: <span class="subst">&#123;<span class="built_in">type</span>(data)&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_preprocess_image</span>(<span class="params">self, image: Image.Image</span>) -&gt; Image.Image:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;图像预处理&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 转换为RGB</span></span><br><span class="line">        <span class="keyword">if</span> image.mode != <span class="string">&#x27;RGB&#x27;</span>:</span><br><span class="line">            image = image.convert(<span class="string">&#x27;RGB&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 调整大小</span></span><br><span class="line">        max_size = <span class="variable language_">self</span>.model_config.get(<span class="string">&#x27;max_size&#x27;</span>, <span class="number">512</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">max</span>(image.size) &gt; max_size:</span><br><span class="line">            image.thumbnail((max_size, max_size), Image.Resampling.LANCZOS)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> image</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_extract_features</span>(<span class="params">self, image: Image.Image</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;提取图像特征&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.model <span class="keyword">or</span> <span class="keyword">not</span> <span class="variable language_">self</span>.processor:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&#x27;embedding&#x27;</span>: np.zeros(<span class="number">512</span>)&#125;  <span class="comment"># 默认嵌入</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 使用CLIP模型提取特征</span></span><br><span class="line">            inputs = <span class="variable language_">self</span>.processor(images=image, return_tensors=<span class="string">&quot;pt&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">                image_features = <span class="variable language_">self</span>.model.get_image_features(**inputs)</span><br><span class="line">                embedding = image_features.numpy().flatten()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&#x27;embedding&#x27;</span>: embedding,</span><br><span class="line">                <span class="string">&#x27;feature_dim&#x27;</span>: <span class="built_in">len</span>(embedding)</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Feature extraction failed: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&#x27;embedding&#x27;</span>: np.zeros(<span class="number">512</span>)&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_analyze_image</span>(<span class="params">self, image: Image.Image</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;分析图像内容&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 基本图像分析</span></span><br><span class="line">        analysis = &#123;</span><br><span class="line">            <span class="string">&#x27;brightness&#x27;</span>: <span class="variable language_">self</span>._calculate_brightness(image),</span><br><span class="line">            <span class="string">&#x27;contrast&#x27;</span>: <span class="variable language_">self</span>._calculate_contrast(image),</span><br><span class="line">            <span class="string">&#x27;colors&#x27;</span>: <span class="variable language_">self</span>._analyze_colors(image),</span><br><span class="line">            <span class="string">&#x27;objects&#x27;</span>: <span class="keyword">await</span> <span class="variable language_">self</span>._detect_objects(image)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> analysis</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_calculate_brightness</span>(<span class="params">self, image: Image.Image</span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;计算图像亮度&quot;&quot;&quot;</span></span><br><span class="line">        grayscale = image.convert(<span class="string">&#x27;L&#x27;</span>)</span><br><span class="line">        histogram = grayscale.histogram()</span><br><span class="line">        pixels = <span class="built_in">sum</span>(histogram)</span><br><span class="line">        brightness = <span class="built_in">sum</span>(i * histogram[i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>)) / pixels</span><br><span class="line">        <span class="keyword">return</span> brightness / <span class="number">255.0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_calculate_contrast</span>(<span class="params">self, image: Image.Image</span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;计算图像对比度&quot;&quot;&quot;</span></span><br><span class="line">        grayscale = image.convert(<span class="string">&#x27;L&#x27;</span>)</span><br><span class="line">        histogram = grayscale.histogram()</span><br><span class="line">        pixels = <span class="built_in">sum</span>(histogram)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 计算标准差作为对比度度量</span></span><br><span class="line">        mean = <span class="built_in">sum</span>(i * histogram[i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>)) / pixels</span><br><span class="line">        variance = <span class="built_in">sum</span>((i - mean) ** <span class="number">2</span> * histogram[i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>)) / pixels</span><br><span class="line">        contrast = (variance ** <span class="number">0.5</span>) / <span class="number">255.0</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> contrast</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_analyze_colors</span>(<span class="params">self, image: Image.Image</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;分析图像颜色&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 转换为numpy数组</span></span><br><span class="line">        img_array = np.array(image)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 主要颜色分析</span></span><br><span class="line">        colors = img_array.reshape(-<span class="number">1</span>, <span class="number">3</span>)</span><br><span class="line">        unique_colors = np.unique(colors, axis=<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;unique_colors&#x27;</span>: <span class="built_in">len</span>(unique_colors),</span><br><span class="line">            <span class="string">&#x27;dominant_color&#x27;</span>: np.mean(colors, axis=<span class="number">0</span>).tolist(),</span><br><span class="line">            <span class="string">&#x27;color_variance&#x27;</span>: np.var(colors, axis=<span class="number">0</span>).tolist()</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_detect_objects</span>(<span class="params">self, image: Image.Image</span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检测图像中的对象&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 这里可以集成目标检测模型，如YOLO、DETR等</span></span><br><span class="line">        <span class="comment"># 目前返回模拟结果</span></span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;object&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;confidence&#x27;</span>: <span class="number">0.8</span>,</span><br><span class="line">                <span class="string">&#x27;bbox&#x27;</span>: [<span class="number">100</span>, <span class="number">100</span>, <span class="number">200</span>, <span class="number">200</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AudioProcessor</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;音频处理器&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, model_config: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">        <span class="variable language_">self</span>.model_config = model_config</span><br><span class="line">        <span class="variable language_">self</span>.sample_rate = model_config.get(<span class="string">&#x27;sample_rate&#x27;</span>, <span class="number">16000</span>)</span><br><span class="line">        <span class="variable language_">self</span>.model = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>._load_model()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_load_model</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;加载音频模型&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 这里可以加载语音识别、音频分类等模型</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">process</span>(<span class="params">self, modal_data: ModalityData</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;处理音频数据&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 解码音频数据</span></span><br><span class="line">        audio_data, sr = <span class="variable language_">self</span>._decode_audio(modal_data.data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 音频预处理</span></span><br><span class="line">        processed_audio = <span class="variable language_">self</span>._preprocess_audio(audio_data, sr)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 特征提取</span></span><br><span class="line">        features = <span class="variable language_">self</span>._extract_audio_features(processed_audio)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 语音识别</span></span><br><span class="line">        transcription = <span class="keyword">await</span> <span class="variable language_">self</span>._speech_to_text(processed_audio)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;audio_info&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;duration&#x27;</span>: <span class="built_in">len</span>(processed_audio) / <span class="variable language_">self</span>.sample_rate,</span><br><span class="line">                <span class="string">&#x27;sample_rate&#x27;</span>: <span class="variable language_">self</span>.sample_rate,</span><br><span class="line">                <span class="string">&#x27;channels&#x27;</span>: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;features&#x27;</span>: features,</span><br><span class="line">            <span class="string">&#x27;transcription&#x27;</span>: transcription,</span><br><span class="line">            <span class="string">&#x27;embedding&#x27;</span>: features.get(<span class="string">&#x27;embedding&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_decode_audio</span>(<span class="params">self, data: <span class="type">Any</span></span>) -&gt; <span class="type">Tuple</span>[np.ndarray, <span class="built_in">int</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;解码音频数据&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(data, <span class="built_in">str</span>):</span><br><span class="line">            <span class="comment"># Base64编码的音频</span></span><br><span class="line">            audio_bytes = base64.b64decode(data)</span><br><span class="line">            audio_data, sr = librosa.load(io.BytesIO(audio_bytes), sr=<span class="variable language_">self</span>.sample_rate)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(data, <span class="built_in">bytes</span>):</span><br><span class="line">            audio_data, sr = librosa.load(io.BytesIO(data), sr=<span class="variable language_">self</span>.sample_rate)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(data, np.ndarray):</span><br><span class="line">            audio_data = data</span><br><span class="line">            sr = <span class="variable language_">self</span>.sample_rate</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Unsupported audio data type: <span class="subst">&#123;<span class="built_in">type</span>(data)&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> audio_data, sr</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_preprocess_audio</span>(<span class="params">self, audio_data: np.ndarray, sr: <span class="built_in">int</span></span>) -&gt; np.ndarray:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;音频预处理&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 重采样到目标采样率</span></span><br><span class="line">        <span class="keyword">if</span> sr != <span class="variable language_">self</span>.sample_rate:</span><br><span class="line">            audio_data = librosa.resample(audio_data, orig_sr=sr, target_sr=<span class="variable language_">self</span>.sample_rate)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 音频归一化</span></span><br><span class="line">        audio_data = librosa.util.normalize(audio_data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 去除静音</span></span><br><span class="line">        audio_data, _ = librosa.effects.trim(audio_data, top_db=<span class="number">20</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> audio_data</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_extract_audio_features</span>(<span class="params">self, audio_data: np.ndarray</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;提取音频特征&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># MFCC特征</span></span><br><span class="line">        mfcc = librosa.feature.mfcc(y=audio_data, sr=<span class="variable language_">self</span>.sample_rate, n_mfcc=<span class="number">13</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 谱质心</span></span><br><span class="line">        spectral_centroid = librosa.feature.spectral_centroid(y=audio_data, sr=<span class="variable language_">self</span>.sample_rate)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 谱带宽</span></span><br><span class="line">        spectral_bandwidth = librosa.feature.spectral_bandwidth(y=audio_data, sr=<span class="variable language_">self</span>.sample_rate)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 谱滚降</span></span><br><span class="line">        spectral_rolloff = librosa.feature.spectral_rolloff(y=audio_data, sr=<span class="variable language_">self</span>.sample_rate)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 零交叉率</span></span><br><span class="line">        zero_crossing_rate = librosa.feature.zero_crossing_rate(audio_data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建特征向量</span></span><br><span class="line">        features = np.concatenate([</span><br><span class="line">            np.mean(mfcc, axis=<span class="number">1</span>),</span><br><span class="line">            np.mean(spectral_centroid, axis=<span class="number">1</span>),</span><br><span class="line">            np.mean(spectral_bandwidth, axis=<span class="number">1</span>),</span><br><span class="line">            np.mean(spectral_rolloff, axis=<span class="number">1</span>),</span><br><span class="line">            np.mean(zero_crossing_rate, axis=<span class="number">1</span>)</span><br><span class="line">        ])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;mfcc&#x27;</span>: mfcc.tolist(),</span><br><span class="line">            <span class="string">&#x27;spectral_centroid&#x27;</span>: spectral_centroid.tolist(),</span><br><span class="line">            <span class="string">&#x27;spectral_bandwidth&#x27;</span>: spectral_bandwidth.tolist(),</span><br><span class="line">            <span class="string">&#x27;spectral_rolloff&#x27;</span>: spectral_rolloff.tolist(),</span><br><span class="line">            <span class="string">&#x27;zero_crossing_rate&#x27;</span>: zero_crossing_rate.tolist(),</span><br><span class="line">            <span class="string">&#x27;embedding&#x27;</span>: features</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_speech_to_text</span>(<span class="params">self, audio_data: np.ndarray</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;语音转文本&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 这里可以集成语音识别模型，如Whisper、Wav2Vec等</span></span><br><span class="line">        <span class="comment"># 目前返回模拟结果</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;text&#x27;</span>: <span class="string">&quot;这是语音识别的结果&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;confidence&#x27;</span>: <span class="number">0.95</span>,</span><br><span class="line">            <span class="string">&#x27;language&#x27;</span>: <span class="string">&#x27;zh-CN&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MultiModalAgent</span>(<span class="title class_ inherited__">BaseAgent</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;多模态Agent&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, agent_id: <span class="built_in">str</span>, config: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(agent_id, config)</span><br><span class="line">        <span class="variable language_">self</span>.multimodal_processor = MultiModalProcessor(config.get(<span class="string">&#x27;multimodal_config&#x27;</span>, &#123;&#125;))</span><br><span class="line">        <span class="variable language_">self</span>.fusion_strategy = config.get(<span class="string">&#x27;fusion_strategy&#x27;</span>, <span class="string">&#x27;weighted_average&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_define_capabilities</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[AgentCapability]:</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            AgentCapability(</span><br><span class="line">                name=<span class="string">&quot;multimodal_understanding&quot;</span>,</span><br><span class="line">                description=<span class="string">&quot;理解和处理多模态输入&quot;</span>,</span><br><span class="line">                input_types=[<span class="string">&quot;text&quot;</span>, <span class="string">&quot;image&quot;</span>, <span class="string">&quot;audio&quot;</span>, <span class="string">&quot;video&quot;</span>],</span><br><span class="line">                output_types=[<span class="string">&quot;text&quot;</span>, <span class="string">&quot;structured_data&quot;</span>],</span><br><span class="line">                required_models=[<span class="string">&quot;multimodal_model&quot;</span>],</span><br><span class="line">                optional_tools=[<span class="string">&quot;image_processor&quot;</span>, <span class="string">&quot;audio_processor&quot;</span>]</span><br><span class="line">            )</span><br><span class="line">        ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">process</span>(<span class="params">self, input_data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;处理多模态输入&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 解析输入数据</span></span><br><span class="line">        modal_inputs = <span class="variable language_">self</span>._parse_multimodal_input(input_data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 处理多模态数据</span></span><br><span class="line">        processed_results = <span class="keyword">await</span> <span class="variable language_">self</span>.multimodal_processor.process_multimodal_input(modal_inputs)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 生成响应</span></span><br><span class="line">        response = <span class="keyword">await</span> <span class="variable language_">self</span>._generate_multimodal_response(processed_results, input_data)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_parse_multimodal_input</span>(<span class="params">self, input_data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="type">List</span>[ModalityData]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;解析多模态输入&quot;&quot;&quot;</span></span><br><span class="line">        modal_inputs = []</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 文本数据</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;text&#x27;</span> <span class="keyword">in</span> input_data:</span><br><span class="line">            modal_inputs.append(ModalityData(</span><br><span class="line">                modality_type=ModalityType.TEXT,</span><br><span class="line">                data=input_data[<span class="string">&#x27;text&#x27;</span>]</span><br><span class="line">            ))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 图像数据</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;image&#x27;</span> <span class="keyword">in</span> input_data:</span><br><span class="line">            modal_inputs.append(ModalityData(</span><br><span class="line">                modality_type=ModalityType.IMAGE,</span><br><span class="line">                data=input_data[<span class="string">&#x27;image&#x27;</span>],</span><br><span class="line">                <span class="built_in">format</span>=input_data.get(<span class="string">&#x27;image_format&#x27;</span>, <span class="string">&#x27;base64&#x27;</span>)</span><br><span class="line">            ))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 音频数据</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;audio&#x27;</span> <span class="keyword">in</span> input_data:</span><br><span class="line">            modal_inputs.append(ModalityData(</span><br><span class="line">                modality_type=ModalityType.AUDIO,</span><br><span class="line">                data=input_data[<span class="string">&#x27;audio&#x27;</span>],</span><br><span class="line">                <span class="built_in">format</span>=input_data.get(<span class="string">&#x27;audio_format&#x27;</span>, <span class="string">&#x27;base64&#x27;</span>)</span><br><span class="line">            ))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> modal_inputs</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_generate_multimodal_response</span>(<span class="params">self, </span></span><br><span class="line"><span class="params">                                          processed_results: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>],</span></span><br><span class="line"><span class="params">                                          original_input: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;生成多模态响应&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 构建上下文</span></span><br><span class="line">        context = &#123;</span><br><span class="line">            <span class="string">&#x27;processed_results&#x27;</span>: processed_results,</span><br><span class="line">            <span class="string">&#x27;original_input&#x27;</span>: original_input,</span><br><span class="line">            <span class="string">&#x27;modalities&#x27;</span>: <span class="built_in">list</span>(processed_results.keys())</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 生成文本响应</span></span><br><span class="line">        text_response = <span class="keyword">await</span> <span class="variable language_">self</span>._generate_text_response(context)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 构建结构化响应</span></span><br><span class="line">        response = &#123;</span><br><span class="line">            <span class="string">&#x27;text_response&#x27;</span>: text_response,</span><br><span class="line">            <span class="string">&#x27;analysis_results&#x27;</span>: processed_results,</span><br><span class="line">            <span class="string">&#x27;confidence&#x27;</span>: <span class="variable language_">self</span>._calculate_confidence(processed_results),</span><br><span class="line">            <span class="string">&#x27;modalities_processed&#x27;</span>: <span class="built_in">list</span>(processed_results.keys())</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_generate_text_response</span>(<span class="params">self, context: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;生成文本响应&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 这里可以调用大语言模型生成响应</span></span><br><span class="line">        <span class="comment"># 基于多模态分析结果生成自然语言描述</span></span><br><span class="line">        </span><br><span class="line">        processed_results = context[<span class="string">&#x27;processed_results&#x27;</span>]</span><br><span class="line">        response_parts = []</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 分析每种模态的结果</span></span><br><span class="line">        <span class="keyword">for</span> modality, result <span class="keyword">in</span> processed_results.items():</span><br><span class="line">            <span class="keyword">if</span> modality == <span class="string">&#x27;text&#x27;</span>:</span><br><span class="line">                response_parts.append(<span class="string">f&quot;文本内容: <span class="subst">&#123;result.get(<span class="string">&#x27;content&#x27;</span>, <span class="string">&#x27;&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">elif</span> modality == <span class="string">&#x27;image&#x27;</span>:</span><br><span class="line">                image_info = result.get(<span class="string">&#x27;image_info&#x27;</span>, &#123;&#125;)</span><br><span class="line">                analysis = result.get(<span class="string">&#x27;analysis&#x27;</span>, &#123;&#125;)</span><br><span class="line">                response_parts.append(</span><br><span class="line">                    <span class="string">f&quot;图像分析: 尺寸<span class="subst">&#123;image_info.get(<span class="string">&#x27;size&#x27;</span>)&#125;</span>, &quot;</span></span><br><span class="line">                    <span class="string">f&quot;亮度<span class="subst">&#123;analysis.get(<span class="string">&#x27;brightness&#x27;</span>, <span class="number">0</span>):<span class="number">.2</span>f&#125;</span>, &quot;</span></span><br><span class="line">                    <span class="string">f&quot;对比度<span class="subst">&#123;analysis.get(<span class="string">&#x27;contrast&#x27;</span>, <span class="number">0</span>):<span class="number">.2</span>f&#125;</span>&quot;</span></span><br><span class="line">                )</span><br><span class="line">            <span class="keyword">elif</span> modality == <span class="string">&#x27;audio&#x27;</span>:</span><br><span class="line">                audio_info = result.get(<span class="string">&#x27;audio_info&#x27;</span>, &#123;&#125;)</span><br><span class="line">                transcription = result.get(<span class="string">&#x27;transcription&#x27;</span>, &#123;&#125;)</span><br><span class="line">                response_parts.append(</span><br><span class="line">                    <span class="string">f&quot;音频分析: 时长<span class="subst">&#123;audio_info.get(<span class="string">&#x27;duration&#x27;</span>, <span class="number">0</span>):<span class="number">.2</span>f&#125;</span>秒, &quot;</span></span><br><span class="line">                    <span class="string">f&quot;识别文本: <span class="subst">&#123;transcription.get(<span class="string">&#x27;text&#x27;</span>, <span class="string">&#x27;&#x27;</span>)&#125;</span>&quot;</span></span><br><span class="line">                )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;多模态分析结果:\n&quot;</span> + <span class="string">&quot;\n&quot;</span>.join(response_parts)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_calculate_confidence</span>(<span class="params">self, processed_results: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;计算置信度&quot;&quot;&quot;</span></span><br><span class="line">        confidences = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> modality, result <span class="keyword">in</span> processed_results.items():</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;confidence&#x27;</span> <span class="keyword">in</span> result:</span><br><span class="line">                confidences.append(result[<span class="string">&#x27;confidence&#x27;</span>])</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                confidences.append(<span class="number">0.8</span>)  <span class="comment"># 默认置信度</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">sum</span>(confidences) / <span class="built_in">len</span>(confidences) <span class="keyword">if</span> confidences <span class="keyword">else</span> <span class="number">0.5</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">validate_input</span>(<span class="params">self, input_data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;验证输入数据&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查是否包含至少一种模态数据</span></span><br><span class="line">        supported_modalities = [<span class="string">&#x27;text&#x27;</span>, <span class="string">&#x27;image&#x27;</span>, <span class="string">&#x27;audio&#x27;</span>, <span class="string">&#x27;video&#x27;</span>]</span><br><span class="line">        has_valid_input = <span class="built_in">any</span>(modality <span class="keyword">in</span> input_data <span class="keyword">for</span> modality <span class="keyword">in</span> supported_modalities)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> has_valid_input</span><br></pre></td></tr></table></figure>

<h3 id="2-3-知识图谱集成Agent"><a href="#2-3-知识图谱集成Agent" class="headerlink" title="2.3 知识图谱集成Agent"></a>2.3 知识图谱集成Agent</h3><h4 id="2-3-1-知识图谱架构设计"><a href="#2-3-1-知识图谱架构设计" class="headerlink" title="2.3.1 知识图谱架构设计"></a>2.3.1 知识图谱架构设计</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line">    subgraph &quot;知识图谱层&quot;</span><br><span class="line">        KG[知识图谱]</span><br><span class="line">        ENTITY[实体库]</span><br><span class="line">        RELATION[关系库]</span><br><span class="line">        SCHEMA[模式定义]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph &quot;知识处理层&quot;</span><br><span class="line">        EXTRACT[知识抽取]</span><br><span class="line">        ALIGN[实体对齐]</span><br><span class="line">        REASON[知识推理]</span><br><span class="line">        UPDATE[知识更新]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph &quot;查询服务层&quot;</span><br><span class="line">        SPARQL[SPARQL查询]</span><br><span class="line">        CYPHER[Cypher查询]</span><br><span class="line">        GRAPH_SEARCH[图搜索]</span><br><span class="line">        SEMANTIC_SEARCH[语义搜索]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph &quot;Agent接口层&quot;</span><br><span class="line">        KG_AGENT[知识图谱Agent]</span><br><span class="line">        QA_AGENT[问答Agent]</span><br><span class="line">        REASONING_AGENT[推理Agent]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    KG --&gt; ENTITY</span><br><span class="line">    KG --&gt; RELATION</span><br><span class="line">    KG --&gt; SCHEMA</span><br><span class="line">    </span><br><span class="line">    EXTRACT --&gt; KG</span><br><span class="line">    ALIGN --&gt; KG</span><br><span class="line">    REASON --&gt; KG</span><br><span class="line">    UPDATE --&gt; KG</span><br><span class="line">    </span><br><span class="line">    SPARQL --&gt; KG</span><br><span class="line">    CYPHER --&gt; KG</span><br><span class="line">    GRAPH_SEARCH --&gt; KG</span><br><span class="line">    SEMANTIC_SEARCH --&gt; KG</span><br><span class="line">    </span><br><span class="line">    KG_AGENT --&gt; SPARQL</span><br><span class="line">    QA_AGENT --&gt; SEMANTIC_SEARCH</span><br><span class="line">    REASONING_AGENT --&gt; REASON</span><br><span class="line">    </span><br><span class="line">    style KG fill:#e1f5fe</span><br><span class="line">    style REASONING_AGENT fill:#fff3e0</span><br><span class="line">    style SEMANTIC_SEARCH fill:#e8f5e8</span><br></pre></td></tr></table></figure>

<h4 id="2-3-2-知识图谱Agent实现"><a href="#2-3-2-知识图谱Agent实现" class="headerlink" title="2.3.2 知识图谱Agent实现"></a>2.3.2 知识图谱Agent实现</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> networkx <span class="keyword">as</span> nx</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Any</span>, <span class="type">Optional</span>, <span class="type">Set</span>, <span class="type">Tuple</span></span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics.pairwise <span class="keyword">import</span> cosine_similarity</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EntityType</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;实体类型&quot;&quot;&quot;</span></span><br><span class="line">    PERSON = <span class="string">&quot;person&quot;</span></span><br><span class="line">    ORGANIZATION = <span class="string">&quot;organization&quot;</span></span><br><span class="line">    LOCATION = <span class="string">&quot;location&quot;</span></span><br><span class="line">    PRODUCT = <span class="string">&quot;product&quot;</span></span><br><span class="line">    CONCEPT = <span class="string">&quot;concept&quot;</span></span><br><span class="line">    EVENT = <span class="string">&quot;event&quot;</span></span><br><span class="line">    TIME = <span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RelationType</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;关系类型&quot;&quot;&quot;</span></span><br><span class="line">    IS_A = <span class="string">&quot;is_a&quot;</span></span><br><span class="line">    PART_OF = <span class="string">&quot;part_of&quot;</span></span><br><span class="line">    LOCATED_IN = <span class="string">&quot;located_in&quot;</span></span><br><span class="line">    WORKS_FOR = <span class="string">&quot;works_for&quot;</span></span><br><span class="line">    CREATED_BY = <span class="string">&quot;created_by&quot;</span></span><br><span class="line">    HAPPENED_AT = <span class="string">&quot;happened_at&quot;</span></span><br><span class="line">    RELATED_TO = <span class="string">&quot;related_to&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Entity</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;实体定义&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">id</span>: <span class="built_in">str</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    <span class="built_in">type</span>: EntityType</span><br><span class="line">    properties: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span><br><span class="line">    embedding: <span class="type">Optional</span>[np.ndarray] = <span class="literal">None</span></span><br><span class="line">    confidence: <span class="built_in">float</span> = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Relation</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;关系定义&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">id</span>: <span class="built_in">str</span></span><br><span class="line">    source_entity: <span class="built_in">str</span></span><br><span class="line">    target_entity: <span class="built_in">str</span></span><br><span class="line">    relation_type: RelationType</span><br><span class="line">    properties: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span><br><span class="line">    confidence: <span class="built_in">float</span> = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Triple</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;三元组定义&quot;&quot;&quot;</span></span><br><span class="line">    subject: Entity</span><br><span class="line">    predicate: RelationType</span><br><span class="line">    <span class="built_in">object</span>: Entity</span><br><span class="line">    confidence: <span class="built_in">float</span> = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">KnowledgeGraph</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;知识图谱&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.entities: <span class="type">Dict</span>[<span class="built_in">str</span>, Entity] = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.relations: <span class="type">Dict</span>[<span class="built_in">str</span>, Relation] = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.graph = nx.MultiDiGraph()</span><br><span class="line">        <span class="variable language_">self</span>.entity_embeddings: <span class="type">Dict</span>[<span class="built_in">str</span>, np.ndarray] = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.relation_embeddings: <span class="type">Dict</span>[<span class="built_in">str</span>, np.ndarray] = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_entity</span>(<span class="params">self, entity: Entity</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;添加实体&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.entities[entity.<span class="built_in">id</span>] = entity</span><br><span class="line">        <span class="variable language_">self</span>.graph.add_node(entity.<span class="built_in">id</span>, **entity.properties)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> entity.embedding <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="variable language_">self</span>.entity_embeddings[entity.<span class="built_in">id</span>] = entity.embedding</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_relation</span>(<span class="params">self, relation: Relation</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;添加关系&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.relations[relation.<span class="built_in">id</span>] = relation</span><br><span class="line">        <span class="variable language_">self</span>.graph.add_edge(</span><br><span class="line">            relation.source_entity,</span><br><span class="line">            relation.target_entity,</span><br><span class="line">            relation_id=relation.<span class="built_in">id</span>,</span><br><span class="line">            relation_type=relation.relation_type.value,</span><br><span class="line">            **relation.properties</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_entity</span>(<span class="params">self, entity_id: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[Entity]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取实体&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.entities.get(entity_id)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_relation</span>(<span class="params">self, relation_id: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[Relation]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取关系&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.relations.get(relation_id)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_entities_by_type</span>(<span class="params">self, entity_type: EntityType</span>) -&gt; <span class="type">List</span>[Entity]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;根据类型查找实体&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            entity <span class="keyword">for</span> entity <span class="keyword">in</span> <span class="variable language_">self</span>.entities.values()</span><br><span class="line">            <span class="keyword">if</span> entity.<span class="built_in">type</span> == entity_type</span><br><span class="line">        ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_entities_by_name</span>(<span class="params">self, name: <span class="built_in">str</span>, fuzzy: <span class="built_in">bool</span> = <span class="literal">False</span></span>) -&gt; <span class="type">List</span>[Entity]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;根据名称查找实体&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> fuzzy:</span><br><span class="line">            <span class="comment"># 模糊匹配</span></span><br><span class="line">            matches = []</span><br><span class="line">            <span class="keyword">for</span> entity <span class="keyword">in</span> <span class="variable language_">self</span>.entities.values():</span><br><span class="line">                <span class="keyword">if</span> name.lower() <span class="keyword">in</span> entity.name.lower():</span><br><span class="line">                    matches.append(entity)</span><br><span class="line">            <span class="keyword">return</span> matches</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 精确匹配</span></span><br><span class="line">            <span class="keyword">return</span> [</span><br><span class="line">                entity <span class="keyword">for</span> entity <span class="keyword">in</span> <span class="variable language_">self</span>.entities.values()</span><br><span class="line">                <span class="keyword">if</span> entity.name == name</span><br><span class="line">            ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_neighbors</span>(<span class="params">self, entity_id: <span class="built_in">str</span>, relation_type: <span class="type">Optional</span>[RelationType] = <span class="literal">None</span></span>) -&gt; <span class="type">List</span>[Entity]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取邻居实体&quot;&quot;&quot;</span></span><br><span class="line">        neighbors = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> entity_id <span class="keyword">in</span> <span class="variable language_">self</span>.graph:</span><br><span class="line">            <span class="keyword">for</span> neighbor <span class="keyword">in</span> <span class="variable language_">self</span>.graph.neighbors(entity_id):</span><br><span class="line">                <span class="comment"># 检查关系类型</span></span><br><span class="line">                <span class="keyword">if</span> relation_type:</span><br><span class="line">                    edge_data = <span class="variable language_">self</span>.graph.get_edge_data(entity_id, neighbor)</span><br><span class="line">                    <span class="keyword">if</span> edge_data <span class="keyword">and</span> edge_data.get(<span class="string">&#x27;relation_type&#x27;</span>) == relation_type.value:</span><br><span class="line">                        neighbors.append(<span class="variable language_">self</span>.entities[neighbor])</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    neighbors.append(<span class="variable language_">self</span>.entities[neighbor])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> neighbors</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_path</span>(<span class="params">self, source_id: <span class="built_in">str</span>, target_id: <span class="built_in">str</span>, max_length: <span class="built_in">int</span> = <span class="number">3</span></span>) -&gt; <span class="type">List</span>[<span class="type">List</span>[<span class="built_in">str</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;查找路径&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            paths = <span class="built_in">list</span>(nx.all_simple_paths(</span><br><span class="line">                <span class="variable language_">self</span>.graph, source_id, target_id, cutoff=max_length</span><br><span class="line">            ))</span><br><span class="line">            <span class="keyword">return</span> paths</span><br><span class="line">        <span class="keyword">except</span> nx.NetworkXNoPath:</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_subgraph</span>(<span class="params">self, entity_ids: <span class="type">List</span>[<span class="built_in">str</span>], depth: <span class="built_in">int</span> = <span class="number">1</span></span>) -&gt; <span class="string">&#x27;KnowledgeGraph&#x27;</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取子图&quot;&quot;&quot;</span></span><br><span class="line">        subgraph_nodes = <span class="built_in">set</span>(entity_ids)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 扩展到指定深度</span></span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(depth):</span><br><span class="line">            new_nodes = <span class="built_in">set</span>()</span><br><span class="line">            <span class="keyword">for</span> node <span class="keyword">in</span> subgraph_nodes:</span><br><span class="line">                <span class="keyword">if</span> node <span class="keyword">in</span> <span class="variable language_">self</span>.graph:</span><br><span class="line">                    new_nodes.update(<span class="variable language_">self</span>.graph.neighbors(node))</span><br><span class="line">            subgraph_nodes.update(new_nodes)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建子图</span></span><br><span class="line">        subgraph = KnowledgeGraph()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 添加实体</span></span><br><span class="line">        <span class="keyword">for</span> entity_id <span class="keyword">in</span> subgraph_nodes:</span><br><span class="line">            <span class="keyword">if</span> entity_id <span class="keyword">in</span> <span class="variable language_">self</span>.entities:</span><br><span class="line">                subgraph.add_entity(<span class="variable language_">self</span>.entities[entity_id])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 添加关系</span></span><br><span class="line">        <span class="keyword">for</span> relation <span class="keyword">in</span> <span class="variable language_">self</span>.relations.values():</span><br><span class="line">            <span class="keyword">if</span> (relation.source_entity <span class="keyword">in</span> subgraph_nodes <span class="keyword">and</span> </span><br><span class="line">                relation.target_entity <span class="keyword">in</span> subgraph_nodes):</span><br><span class="line">                subgraph.add_relation(relation)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> subgraph</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">semantic_search</span>(<span class="params">self, query_embedding: np.ndarray, top_k: <span class="built_in">int</span> = <span class="number">10</span></span>) -&gt; <span class="type">List</span>[<span class="type">Tuple</span>[Entity, <span class="built_in">float</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;语义搜索&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.entity_embeddings:</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        </span><br><span class="line">        similarities = []</span><br><span class="line">        <span class="keyword">for</span> entity_id, embedding <span class="keyword">in</span> <span class="variable language_">self</span>.entity_embeddings.items():</span><br><span class="line">            similarity = cosine_similarity(</span><br><span class="line">                query_embedding.reshape(<span class="number">1</span>, -<span class="number">1</span>),</span><br><span class="line">                embedding.reshape(<span class="number">1</span>, -<span class="number">1</span>)</span><br><span class="line">            )[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">            similarities.append((<span class="variable language_">self</span>.entities[entity_id], similarity))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 按相似度排序</span></span><br><span class="line">        similarities.sort(key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> similarities[:top_k]</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">KnowledgeExtractor</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;知识抽取器&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">        <span class="variable language_">self</span>.config = config</span><br><span class="line">        <span class="variable language_">self</span>.entity_patterns = <span class="variable language_">self</span>._load_entity_patterns()</span><br><span class="line">        <span class="variable language_">self</span>.relation_patterns = <span class="variable language_">self</span>._load_relation_patterns()</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_load_entity_patterns</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>[EntityType, <span class="type">List</span>[<span class="built_in">str</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;加载实体识别模式&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            EntityType.PERSON: [</span><br><span class="line">                <span class="string">r&#x27;([A-Z][a-z]+ [A-Z][a-z]+)&#x27;</span>,  <span class="comment"># 人名模式</span></span><br><span class="line">                <span class="string">r&#x27;(先生|女士|博士|教授)\s*([A-Z][a-z]+)&#x27;</span>,</span><br><span class="line">            ],</span><br><span class="line">            EntityType.ORGANIZATION: [</span><br><span class="line">                <span class="string">r&#x27;([A-Z][a-z]+ (Company|Corp|Inc|Ltd))&#x27;</span>,</span><br><span class="line">                <span class="string">r&#x27;(公司|企业|机构)\s*([A-Z][a-z]+)&#x27;</span>,</span><br><span class="line">            ],</span><br><span class="line">            EntityType.LOCATION: [</span><br><span class="line">                <span class="string">r&#x27;([A-Z][a-z]+ (City|State|Country))&#x27;</span>,</span><br><span class="line">                <span class="string">r&#x27;(北京|上海|深圳|广州)&#x27;</span>,</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_load_relation_patterns</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>[RelationType, <span class="type">List</span>[<span class="built_in">str</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;加载关系识别模式&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            RelationType.WORKS_FOR: [</span><br><span class="line">                <span class="string">r&#x27;(\w+)\s+(works for|employed by)\s+(\w+)&#x27;</span>,</span><br><span class="line">                <span class="string">r&#x27;(\w+)\s+(在|就职于)\s+(\w+)&#x27;</span>,</span><br><span class="line">            ],</span><br><span class="line">            RelationType.LOCATED_IN: [</span><br><span class="line">                <span class="string">r&#x27;(\w+)\s+(is located in|位于)\s+(\w+)&#x27;</span>,</span><br><span class="line">            ],</span><br><span class="line">            RelationType.CREATED_BY: [</span><br><span class="line">                <span class="string">r&#x27;(\w+)\s+(created by|developed by|由)\s+(\w+)&#x27;</span>,</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">extract_entities</span>(<span class="params">self, text: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[Entity]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;抽取实体&quot;&quot;&quot;</span></span><br><span class="line">        entities = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> entity_type, patterns <span class="keyword">in</span> <span class="variable language_">self</span>.entity_patterns.items():</span><br><span class="line">            <span class="keyword">for</span> pattern <span class="keyword">in</span> patterns:</span><br><span class="line">                matches = re.findall(pattern, text, re.IGNORECASE)</span><br><span class="line">                <span class="keyword">for</span> <span class="keyword">match</span> <span class="keyword">in</span> matches:</span><br><span class="line">                    entity_name = <span class="keyword">match</span> <span class="keyword">if</span> <span class="built_in">isinstance</span>(<span class="keyword">match</span>, <span class="built_in">str</span>) <span class="keyword">else</span> <span class="keyword">match</span>[<span class="number">0</span>]</span><br><span class="line">                    entity = Entity(</span><br><span class="line">                        <span class="built_in">id</span>=<span class="string">f&quot;<span class="subst">&#123;entity_type.value&#125;</span>_<span class="subst">&#123;<span class="built_in">len</span>(entities)&#125;</span>&quot;</span>,</span><br><span class="line">                        name=entity_name,</span><br><span class="line">                        <span class="built_in">type</span>=entity_type,</span><br><span class="line">                        properties=&#123;<span class="string">&#x27;source&#x27;</span>: <span class="string">&#x27;text_extraction&#x27;</span>&#125;</span><br><span class="line">                    )</span><br><span class="line">                    entities.append(entity)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> entities</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">extract_relations</span>(<span class="params">self, text: <span class="built_in">str</span>, entities: <span class="type">List</span>[Entity]</span>) -&gt; <span class="type">List</span>[Relation]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;抽取关系&quot;&quot;&quot;</span></span><br><span class="line">        relations = []</span><br><span class="line">        entity_map = &#123;entity.name: entity <span class="keyword">for</span> entity <span class="keyword">in</span> entities&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> relation_type, patterns <span class="keyword">in</span> <span class="variable language_">self</span>.relation_patterns.items():</span><br><span class="line">            <span class="keyword">for</span> pattern <span class="keyword">in</span> patterns:</span><br><span class="line">                matches = re.findall(pattern, text, re.IGNORECASE)</span><br><span class="line">                <span class="keyword">for</span> <span class="keyword">match</span> <span class="keyword">in</span> matches:</span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">len</span>(<span class="keyword">match</span>) &gt;= <span class="number">2</span>:</span><br><span class="line">                        subject_name = <span class="keyword">match</span>[<span class="number">0</span>]</span><br><span class="line">                        object_name = <span class="keyword">match</span>[-<span class="number">1</span>]</span><br><span class="line">                        </span><br><span class="line">                        <span class="keyword">if</span> subject_name <span class="keyword">in</span> entity_map <span class="keyword">and</span> object_name <span class="keyword">in</span> entity_map:</span><br><span class="line">                            relation = Relation(</span><br><span class="line">                                <span class="built_in">id</span>=<span class="string">f&quot;inferred_<span class="subst">&#123;<span class="built_in">len</span>(relations)&#125;</span>&quot;</span>,</span><br><span class="line">                                source_entity=entity_map[subject_name].<span class="built_in">id</span>,</span><br><span class="line">                                target_entity=entity_map[object_name].<span class="built_in">id</span>,</span><br><span class="line">                                relation_type=relation_type,</span><br><span class="line">                                properties=&#123;</span><br><span class="line">                                    <span class="string">&#x27;inferred&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">                                    <span class="string">&#x27;rule&#x27;</span>: <span class="string">&#x27;pattern_match&#x27;</span>, <span class="comment"># 示例规则</span></span><br><span class="line">                                    <span class="string">&#x27;path&#x27;</span>: [] <span class="comment"># 示例路径</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            )</span><br><span class="line">                            relations.append(relation)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> relations</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">extract_knowledge</span>(<span class="params">self, text: <span class="built_in">str</span></span>) -&gt; <span class="type">Tuple</span>[<span class="type">List</span>[Entity], <span class="type">List</span>[Relation]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;抽取知识&quot;&quot;&quot;</span></span><br><span class="line">        entities = <span class="keyword">await</span> <span class="variable language_">self</span>.extract_entities(text)</span><br><span class="line">        relations = <span class="keyword">await</span> <span class="variable language_">self</span>.extract_relations(text, entities)</span><br><span class="line">        <span class="keyword">return</span> entities, relations</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">KnowledgeReasoner</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;知识推理器&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, knowledge_graph: KnowledgeGraph</span>):</span><br><span class="line">        <span class="variable language_">self</span>.kg = knowledge_graph</span><br><span class="line">        <span class="variable language_">self</span>.inference_rules = <span class="variable language_">self</span>._load_inference_rules()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_load_inference_rules</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;加载推理规则&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;transitivity&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;pattern&#x27;</span>: [RelationType.IS_A, RelationType.IS_A],</span><br><span class="line">                <span class="string">&#x27;conclusion&#x27;</span>: RelationType.IS_A,</span><br><span class="line">                <span class="string">&#x27;confidence&#x27;</span>: <span class="number">0.8</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;location_hierarchy&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;pattern&#x27;</span>: [RelationType.LOCATED_IN, RelationType.LOCATED_IN],</span><br><span class="line">                <span class="string">&#x27;conclusion&#x27;</span>: RelationType.LOCATED_IN,</span><br><span class="line">                <span class="string">&#x27;confidence&#x27;</span>: <span class="number">0.9</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;work_location&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;pattern&#x27;</span>: [RelationType.WORKS_FOR, RelationType.LOCATED_IN],</span><br><span class="line">                <span class="string">&#x27;conclusion&#x27;</span>: RelationType.LOCATED_IN,</span><br><span class="line">                <span class="string">&#x27;confidence&#x27;</span>: <span class="number">0.7</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">infer_new_relations</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[Relation]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;推理新关系&quot;&quot;&quot;</span></span><br><span class="line">        new_relations = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> rule <span class="keyword">in</span> <span class="variable language_">self</span>.inference_rules:</span><br><span class="line">            inferred = <span class="keyword">await</span> <span class="variable language_">self</span>._apply_rule(rule)</span><br><span class="line">            new_relations.extend(inferred)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> new_relations</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_apply_rule</span>(<span class="params">self, rule: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="type">List</span>[Relation]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;应用推理规则&quot;&quot;&quot;</span></span><br><span class="line">        pattern = rule[<span class="string">&#x27;pattern&#x27;</span>]</span><br><span class="line">        conclusion_type = rule[<span class="string">&#x27;conclusion&#x27;</span>]</span><br><span class="line">        confidence = rule[<span class="string">&#x27;confidence&#x27;</span>]</span><br><span class="line">        </span><br><span class="line">        inferred_relations = []</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 查找匹配模式的路径</span></span><br><span class="line">        <span class="keyword">for</span> entity_id <span class="keyword">in</span> <span class="variable language_">self</span>.kg.entities:</span><br><span class="line">            paths = <span class="variable language_">self</span>._find_pattern_paths(entity_id, pattern)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> path <span class="keyword">in</span> paths:</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(path) &gt;= <span class="number">3</span>:  <span class="comment"># 至少包含起点、中间点、终点</span></span><br><span class="line">                    source_id = path[<span class="number">0</span>]</span><br><span class="line">                    target_id = path[-<span class="number">1</span>]</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># 检查是否已存在该关系</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>._relation_exists(source_id, target_id, conclusion_type):</span><br><span class="line">                        relation = Relation(</span><br><span class="line">                            <span class="built_in">id</span>=<span class="string">f&quot;inferred_<span class="subst">&#123;<span class="built_in">len</span>(inferred_relations)&#125;</span>&quot;</span>,</span><br><span class="line">                            source_entity=source_id,</span><br><span class="line">                            target_entity=target_id,</span><br><span class="line">                            relation_type=conclusion_type,</span><br><span class="line">                            properties=&#123;</span><br><span class="line">                                <span class="string">&#x27;inferred&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">                                <span class="string">&#x27;rule&#x27;</span>: rule[<span class="string">&#x27;name&#x27;</span>],</span><br><span class="line">                                <span class="string">&#x27;path&#x27;</span>: path</span><br><span class="line">                            &#125;,</span><br><span class="line">                            confidence=confidence</span><br><span class="line">                        )</span><br><span class="line">                        inferred_relations.append(relation)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> inferred_relations</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_find_pattern_paths</span>(<span class="params">self, start_entity: <span class="built_in">str</span>, pattern: <span class="type">List</span>[RelationType]</span>) -&gt; <span class="type">List</span>[<span class="type">List</span>[<span class="built_in">str</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;查找匹配模式的路径&quot;&quot;&quot;</span></span><br><span class="line">        paths = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">dfs</span>(<span class="params">current_entity: <span class="built_in">str</span>, current_path: <span class="type">List</span>[<span class="built_in">str</span>], pattern_index: <span class="built_in">int</span></span>):</span><br><span class="line">            <span class="keyword">if</span> pattern_index &gt;= <span class="built_in">len</span>(pattern):</span><br><span class="line">                paths.append(current_path[:])</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            </span><br><span class="line">            target_relation = pattern[pattern_index]</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 查找匹配的邻居</span></span><br><span class="line">            <span class="keyword">if</span> current_entity <span class="keyword">in</span> <span class="variable language_">self</span>.kg.graph:</span><br><span class="line">                <span class="keyword">for</span> neighbor <span class="keyword">in</span> <span class="variable language_">self</span>.kg.graph.neighbors(current_entity):</span><br><span class="line">                    edge_data = <span class="variable language_">self</span>.kg.graph.get_edge_data(current_entity, neighbor)</span><br><span class="line">                    <span class="keyword">if</span> edge_data <span class="keyword">and</span> edge_data.get(<span class="string">&#x27;relation_type&#x27;</span>) == target_relation.value:</span><br><span class="line">                        current_path.append(neighbor)</span><br><span class="line">                        dfs(neighbor, current_path, pattern_index + <span class="number">1</span>)</span><br><span class="line">                        current_path.pop()</span><br><span class="line">        </span><br><span class="line">        dfs(start_entity, [start_entity], <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> paths</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_relation_exists</span>(<span class="params">self, source_id: <span class="built_in">str</span>, target_id: <span class="built_in">str</span>, relation_type: RelationType</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检查关系是否存在&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> source_id <span class="keyword">in</span> <span class="variable language_">self</span>.kg.graph <span class="keyword">and</span> target_id <span class="keyword">in</span> <span class="variable language_">self</span>.kg.graph.neighbors(source_id):</span><br><span class="line">            edge_data = <span class="variable language_">self</span>.kg.graph.get_edge_data(source_id, target_id)</span><br><span class="line">            <span class="keyword">return</span> edge_data <span class="keyword">and</span> edge_data.get(<span class="string">&#x27;relation_type&#x27;</span>) == relation_type.value</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">KnowledgeGraphAgent</span>(<span class="title class_ inherited__">BaseAgent</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;知识图谱Agent&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, agent_id: <span class="built_in">str</span>, config: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(agent_id, config)</span><br><span class="line">        <span class="variable language_">self</span>.knowledge_graph = KnowledgeGraph()</span><br><span class="line">        <span class="variable language_">self</span>.knowledge_extractor = KnowledgeExtractor(config.get(<span class="string">&#x27;extractor_config&#x27;</span>, &#123;&#125;))</span><br><span class="line">        <span class="variable language_">self</span>.knowledge_reasoner = KnowledgeReasoner(<span class="variable language_">self</span>.knowledge_graph)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_define_capabilities</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[AgentCapability]:</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            AgentCapability(</span><br><span class="line">                name=<span class="string">&quot;knowledge_extraction&quot;</span>,</span><br><span class="line">                description=<span class="string">&quot;从文本中抽取知识&quot;</span>,</span><br><span class="line">                input_types=[<span class="string">&quot;text&quot;</span>],</span><br><span class="line">                output_types=[<span class="string">&quot;entities&quot;</span>, <span class="string">&quot;relations&quot;</span>],</span><br><span class="line">                required_models=[<span class="string">&quot;ner_model&quot;</span>],</span><br><span class="line">                optional_tools=[<span class="string">&quot;relation_extractor&quot;</span>]</span><br><span class="line">            ),</span><br><span class="line">            AgentCapability(</span><br><span class="line">                name=<span class="string">&quot;knowledge_query&quot;</span>,</span><br><span class="line">                description=<span class="string">&quot;查询知识图谱&quot;</span>,</span><br><span class="line">                input_types=[<span class="string">&quot;query&quot;</span>],</span><br><span class="line">                output_types=[<span class="string">&quot;entities&quot;</span>, <span class="string">&quot;relations&quot;</span>, <span class="string">&quot;paths&quot;</span>],</span><br><span class="line">                required_models=[<span class="string">&quot;embedding_model&quot;</span>],</span><br><span class="line">                optional_tools=[<span class="string">&quot;graph_database&quot;</span>]</span><br><span class="line">            ),</span><br><span class="line">            AgentCapability(</span><br><span class="line">                name=<span class="string">&quot;knowledge_reasoning&quot;</span>,</span><br><span class="line">                description=<span class="string">&quot;基于知识图谱进行推理&quot;</span>,</span><br><span class="line">                input_types=[<span class="string">&quot;entities&quot;</span>, <span class="string">&quot;relations&quot;</span>],</span><br><span class="line">                output_types=[<span class="string">&quot;inferred_relations&quot;</span>],</span><br><span class="line">                required_models=[<span class="string">&quot;reasoning_model&quot;</span>],</span><br><span class="line">                optional_tools=[<span class="string">&quot;rule_engine&quot;</span>]</span><br><span class="line">            )</span><br><span class="line">        ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">process</span>(<span class="params">self, input_data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;处理输入数据&quot;&quot;&quot;</span></span><br><span class="line">        task_type = input_data.get(<span class="string">&#x27;task_type&#x27;</span>, <span class="string">&#x27;query&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> task_type == <span class="string">&#x27;extract&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> <span class="variable language_">self</span>._extract_knowledge(input_data)</span><br><span class="line">        <span class="keyword">elif</span> task_type == <span class="string">&#x27;query&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> <span class="variable language_">self</span>._query_knowledge(input_data)</span><br><span class="line">        <span class="keyword">elif</span> task_type == <span class="string">&#x27;reason&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> <span class="variable language_">self</span>._reason_knowledge(input_data)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Unsupported task type: <span class="subst">&#123;task_type&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_extract_knowledge</span>(<span class="params">self, input_data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;抽取知识&quot;&quot;&quot;</span></span><br><span class="line">        text = input_data.get(<span class="string">&#x27;text&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 抽取实体和关系</span></span><br><span class="line">        entities, relations = <span class="keyword">await</span> <span class="variable language_">self</span>.knowledge_extractor.extract_knowledge(text)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 添加到知识图谱</span></span><br><span class="line">        <span class="keyword">for</span> entity <span class="keyword">in</span> entities:</span><br><span class="line">            <span class="variable language_">self</span>.knowledge_graph.add_entity(entity)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> relation <span class="keyword">in</span> relations:</span><br><span class="line">            <span class="variable language_">self</span>.knowledge_graph.add_relation(relation)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;entities&#x27;</span>: [<span class="variable language_">self</span>._entity_to_dict(entity) <span class="keyword">for</span> entity <span class="keyword">in</span> entities],</span><br><span class="line">            <span class="string">&#x27;relations&#x27;</span>: [<span class="variable language_">self</span>._relation_to_dict(relation) <span class="keyword">for</span> relation <span class="keyword">in</span> relations],</span><br><span class="line">            <span class="string">&#x27;total_entities&#x27;</span>: <span class="built_in">len</span>(entities),</span><br><span class="line">            <span class="string">&#x27;total_relations&#x27;</span>: <span class="built_in">len</span>(relations)</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_query_knowledge</span>(<span class="params">self, input_data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;查询知识&quot;&quot;&quot;</span></span><br><span class="line">        query_type = input_data.get(<span class="string">&#x27;query_type&#x27;</span>, <span class="string">&#x27;entity&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> query_type == <span class="string">&#x27;entity&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> <span class="variable language_">self</span>._query_entity(input_data)</span><br><span class="line">        <span class="keyword">elif</span> query_type == <span class="string">&#x27;relation&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> <span class="variable language_">self</span>._query_relation(input_data)</span><br><span class="line">        <span class="keyword">elif</span> query_type == <span class="string">&#x27;path&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> <span class="variable language_">self</span>._query_path(input_data)</span><br><span class="line">        <span class="keyword">elif</span> query_type == <span class="string">&#x27;semantic&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> <span class="variable language_">self</span>._semantic_query(input_data)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Unsupported query type: <span class="subst">&#123;query_type&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_query_entity</span>(<span class="params">self, input_data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;查询实体&quot;&quot;&quot;</span></span><br><span class="line">        entity_name = input_data.get(<span class="string">&#x27;entity_name&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        entity_type = input_data.get(<span class="string">&#x27;entity_type&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        results = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> entity_name:</span><br><span class="line">            entities = <span class="variable language_">self</span>.knowledge_graph.find_entities_by_name(entity_name, fuzzy=<span class="literal">True</span>)</span><br><span class="line">            results.extend(entities)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> entity_type:</span><br><span class="line">            entity_type_enum = EntityType(entity_type)</span><br><span class="line">            entities = <span class="variable language_">self</span>.knowledge_graph.find_entities_by_type(entity_type_enum)</span><br><span class="line">            results.extend(entities)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;entities&#x27;</span>: [<span class="variable language_">self</span>._entity_to_dict(entity) <span class="keyword">for</span> entity <span class="keyword">in</span> results],</span><br><span class="line">            <span class="string">&#x27;total_found&#x27;</span>: <span class="built_in">len</span>(results)</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_query_path</span>(<span class="params">self, input_data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;查询路径&quot;&quot;&quot;</span></span><br><span class="line">        source_entity = input_data.get(<span class="string">&#x27;source_entity&#x27;</span>)</span><br><span class="line">        target_entity = input_data.get(<span class="string">&#x27;target_entity&#x27;</span>)</span><br><span class="line">        max_length = input_data.get(<span class="string">&#x27;max_length&#x27;</span>, <span class="number">3</span>)</span><br><span class="line">        </span><br><span class="line">        paths = <span class="variable language_">self</span>.knowledge_graph.find_path(source_entity, target_entity, max_length)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;paths&#x27;</span>: paths,</span><br><span class="line">            <span class="string">&#x27;total_paths&#x27;</span>: <span class="built_in">len</span>(paths)</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_semantic_query</span>(<span class="params">self, input_data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;语义查询&quot;&quot;&quot;</span></span><br><span class="line">        query_text = input_data.get(<span class="string">&#x27;query_text&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        top_k = input_data.get(<span class="string">&#x27;top_k&#x27;</span>, <span class="number">10</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 这里需要将查询文本转换为嵌入向量</span></span><br><span class="line">        <span class="comment"># 实际实现中需要调用嵌入模型</span></span><br><span class="line">        query_embedding = np.random.rand(<span class="number">512</span>)  <span class="comment"># 模拟嵌入</span></span><br><span class="line">        </span><br><span class="line">        results = <span class="variable language_">self</span>.knowledge_graph.semantic_search(query_embedding, top_k)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;results&#x27;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&#x27;entity&#x27;</span>: <span class="variable language_">self</span>._entity_to_dict(entity),</span><br><span class="line">                    <span class="string">&#x27;similarity&#x27;</span>: <span class="built_in">float</span>(similarity)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> entity, similarity <span class="keyword">in</span> results</span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&#x27;total_found&#x27;</span>: <span class="built_in">len</span>(results)</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_reason_knowledge</span>(<span class="params">self, input_data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;推理知识&quot;&quot;&quot;</span></span><br><span class="line">        inferred_relations = <span class="keyword">await</span> <span class="variable language_">self</span>.knowledge_reasoner.infer_new_relations()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 添加推理出的关系到知识图谱</span></span><br><span class="line">        <span class="keyword">for</span> relation <span class="keyword">in</span> inferred_relations:</span><br><span class="line">            <span class="variable language_">self</span>.knowledge_graph.add_relation(relation)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;inferred_relations&#x27;</span>: [</span><br><span class="line">                <span class="variable language_">self</span>._relation_to_dict(relation) <span class="keyword">for</span> relation <span class="keyword">in</span> inferred_relations</span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&#x27;total_inferred&#x27;</span>: <span class="built_in">len</span>(inferred_relations)</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_entity_to_dict</span>(<span class="params">self, entity: Entity</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;实体转字典&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>: entity.<span class="built_in">id</span>,</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span>: entity.name,</span><br><span class="line">            <span class="string">&#x27;type&#x27;</span>: entity.<span class="built_in">type</span>.value,</span><br><span class="line">            <span class="string">&#x27;properties&#x27;</span>: entity.properties,</span><br><span class="line">            <span class="string">&#x27;confidence&#x27;</span>: entity.confidence</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_relation_to_dict</span>(<span class="params">self, relation: Relation</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;关系转字典&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>: relation.<span class="built_in">id</span>,</span><br><span class="line">            <span class="string">&#x27;source_entity&#x27;</span>: relation.source_entity,</span><br><span class="line">            <span class="string">&#x27;target_entity&#x27;</span>: relation.target_entity,</span><br><span class="line">            <span class="string">&#x27;relation_type&#x27;</span>: relation.relation_type.value,</span><br><span class="line">            <span class="string">&#x27;properties&#x27;</span>: relation.properties,</span><br><span class="line">            <span class="string">&#x27;confidence&#x27;</span>: relation.confidence</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">validate_input</span>(<span class="params">self, input_data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;验证输入数据&quot;&quot;&quot;</span></span><br><span class="line">        task_type = input_data.get(<span class="string">&#x27;task_type&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> task_type == <span class="string">&#x27;extract&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;text&#x27;</span> <span class="keyword">in</span> input_data</span><br><span class="line">        <span class="keyword">elif</span> task_type == <span class="string">&#x27;query&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;query_type&#x27;</span> <span class="keyword">in</span> input_data</span><br><span class="line">        <span class="keyword">elif</span> task_type == <span class="string">&#x27;reason&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span>  <span class="comment"># 推理不需要特定输入</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<p>这个企业级大模型Agent框架的架构设计展示了：</p>
<ol>
<li><strong>模块化设计</strong>：通过BaseAgent基类和AgentRegistry实现了可扩展的Agent架构</li>
<li><strong>智能路由</strong>：IntelligentRouter实现了基于多维度评分的智能路由算法</li>
<li><strong>工作流引擎</strong>：支持复杂的业务流程编排和执行</li>
<li><strong>多模态融合</strong>：完整的多模态数据处理和特征融合机制</li>
<li><strong>知识图谱集成</strong>：提供了完整的知识抽取、推理和查询能力</li>
<li><strong>异步处理</strong>：全面的异步任务管理和并发控制</li>
</ol>
<p>这个框架能够处理企业级应用中的复杂场景，如多模态理解、复杂业务流程自动化、知识推理和智能决策支持等。接下来我可以继续完善其他核心组件，如模型管理、安全控制、监控告警等部分。</p>
<h2 id="三、模型管理与服务化"><a href="#三、模型管理与服务化" class="headerlink" title="三、模型管理与服务化"></a>三、模型管理与服务化</h2><h3 id="3-1-模型网关架构"><a href="#3-1-模型网关架构" class="headerlink" title="3.1 模型网关架构"></a>3.1 模型网关架构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line">    subgraph &quot;模型网关层&quot;</span><br><span class="line">        MG[模型网关]</span><br><span class="line">        LB[负载均衡]</span><br><span class="line">        CACHE[模型缓存]</span><br><span class="line">        POOL[连接池]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph &quot;模型服务层&quot;</span><br><span class="line">        LLM1[LLM服务1]</span><br><span class="line">        LLM2[LLM服务2]</span><br><span class="line">        LLM3[LLM服务3]</span><br><span class="line">        EMB1[嵌入模型1]</span><br><span class="line">        EMB2[嵌入模型2]</span><br><span class="line">        MM1[多模态模型1]</span><br><span class="line">        MM2[多模态模型2]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph &quot;模型管理层&quot;</span><br><span class="line">        MM[模型管理器]</span><br><span class="line">        VER[版本控制]</span><br><span class="line">        DEPLOY[部署管理]</span><br><span class="line">        MONITOR[性能监控]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph &quot;资源管理层&quot;</span><br><span class="line">        GPU[GPU资源池]</span><br><span class="line">        CPU[CPU资源池]</span><br><span class="line">        MEM[内存管理]</span><br><span class="line">        STORAGE[存储管理]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    MG --&gt; LB</span><br><span class="line">    LB --&gt; CACHE</span><br><span class="line">    CACHE --&gt; POOL</span><br><span class="line">    </span><br><span class="line">    POOL --&gt; LLM1</span><br><span class="line">    POOL --&gt; LLM2</span><br><span class="line">    POOL --&gt; LLM3</span><br><span class="line">    POOL --&gt; EMB1</span><br><span class="line">    POOL --&gt; EMB2</span><br><span class="line">    POOL --&gt; MM1</span><br><span class="line">    POOL --&gt; MM2</span><br><span class="line">    </span><br><span class="line">    MM --&gt; VER</span><br><span class="line">    MM --&gt; DEPLOY</span><br><span class="line">    MM --&gt; MONITOR</span><br><span class="line">    </span><br><span class="line">    DEPLOY --&gt; GPU</span><br><span class="line">    DEPLOY --&gt; CPU</span><br><span class="line">    DEPLOY --&gt; MEM</span><br><span class="line">    DEPLOY --&gt; STORAGE</span><br><span class="line">    </span><br><span class="line">    style MG fill:#ff9999</span><br><span class="line">    style MM fill:#99ccff</span><br><span class="line">    style GPU fill:#99ff99</span><br></pre></td></tr></table></figure>

<h3 id="3-2-模型网关实现"><a href="#3-2-模型网关实现" class="headerlink" title="3.2 模型网关实现"></a>3.2 模型网关实现</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Any</span>, <span class="type">Optional</span>, <span class="type">Union</span></span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ModelType</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;模型类型&quot;&quot;&quot;</span></span><br><span class="line">    LLM = <span class="string">&quot;llm&quot;</span></span><br><span class="line">    EMBEDDING = <span class="string">&quot;embedding&quot;</span></span><br><span class="line">    MULTIMODAL = <span class="string">&quot;multimodal&quot;</span></span><br><span class="line">    FINE_TUNED = <span class="string">&quot;fine_tuned&quot;</span></span><br><span class="line">    CUSTOM = <span class="string">&quot;custom&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ModelStatus</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;模型状态&quot;&quot;&quot;</span></span><br><span class="line">    LOADING = <span class="string">&quot;loading&quot;</span></span><br><span class="line">    READY = <span class="string">&quot;ready&quot;</span></span><br><span class="line">    BUSY = <span class="string">&quot;busy&quot;</span></span><br><span class="line">    ERROR = <span class="string">&quot;error&quot;</span></span><br><span class="line">    MAINTENANCE = <span class="string">&quot;maintenance&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ModelInfo</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;模型信息&quot;&quot;&quot;</span></span><br><span class="line">    model_id: <span class="built_in">str</span></span><br><span class="line">    model_name: <span class="built_in">str</span></span><br><span class="line">    model_type: ModelType</span><br><span class="line">    version: <span class="built_in">str</span></span><br><span class="line">    endpoint: <span class="built_in">str</span></span><br><span class="line">    max_tokens: <span class="built_in">int</span></span><br><span class="line">    context_length: <span class="built_in">int</span></span><br><span class="line">    capabilities: <span class="type">List</span>[<span class="built_in">str</span>]</span><br><span class="line">    resource_requirements: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span><br><span class="line">    status: ModelStatus = ModelStatus.LOADING</span><br><span class="line">    last_health_check: <span class="type">Optional</span>[datetime] = <span class="literal">None</span></span><br><span class="line">    performance_metrics: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">float</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ModelRequest</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;模型请求&quot;&quot;&quot;</span></span><br><span class="line">    request_id: <span class="built_in">str</span></span><br><span class="line">    model_id: <span class="built_in">str</span></span><br><span class="line">    prompt: <span class="built_in">str</span></span><br><span class="line">    parameters: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span><br><span class="line">    timestamp: datetime</span><br><span class="line">    priority: <span class="built_in">int</span> = <span class="number">0</span></span><br><span class="line">    timeout: <span class="built_in">int</span> = <span class="number">30</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ModelResponse</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;模型响应&quot;&quot;&quot;</span></span><br><span class="line">    request_id: <span class="built_in">str</span></span><br><span class="line">    model_id: <span class="built_in">str</span></span><br><span class="line">    response: <span class="built_in">str</span></span><br><span class="line">    tokens_used: <span class="built_in">int</span></span><br><span class="line">    latency: <span class="built_in">float</span></span><br><span class="line">    timestamp: datetime</span><br><span class="line">    error: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ModelGateway</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;模型网关&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">        <span class="variable language_">self</span>.config = config</span><br><span class="line">        <span class="variable language_">self</span>.models: <span class="type">Dict</span>[<span class="built_in">str</span>, ModelInfo] = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.model_instances: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">List</span>[<span class="built_in">str</span>]] = defaultdict(<span class="built_in">list</span>)</span><br><span class="line">        <span class="variable language_">self</span>.load_balancer = ModelLoadBalancer()</span><br><span class="line">        <span class="variable language_">self</span>.cache = ModelCache(config.get(<span class="string">&#x27;cache_config&#x27;</span>, &#123;&#125;))</span><br><span class="line">        <span class="variable language_">self</span>.connection_pool = ModelConnectionPool(config.get(<span class="string">&#x27;pool_config&#x27;</span>, &#123;&#125;))</span><br><span class="line">        <span class="variable language_">self</span>.rate_limiter = ModelRateLimiter(config.get(<span class="string">&#x27;rate_limit_config&#x27;</span>, &#123;&#125;))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 性能监控</span></span><br><span class="line">        <span class="variable language_">self</span>.metrics = &#123;</span><br><span class="line">            <span class="string">&#x27;total_requests&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&#x27;successful_requests&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&#x27;failed_requests&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&#x27;avg_latency&#x27;</span>: <span class="number">0.0</span>,</span><br><span class="line">            <span class="string">&#x27;cache_hit_rate&#x27;</span>: <span class="number">0.0</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">register_model</span>(<span class="params">self, model_info: ModelInfo</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;注册模型&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.models[model_info.model_id] = model_info</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 健康检查</span></span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">self</span>._health_check(model_info)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 添加到负载均衡器</span></span><br><span class="line">        <span class="variable language_">self</span>.load_balancer.add_model(model_info)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Model registered: <span class="subst">&#123;model_info.model_id&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">process_request</span>(<span class="params">self, request: ModelRequest</span>) -&gt; ModelResponse:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;处理模型请求&quot;&quot;&quot;</span></span><br><span class="line">        start_time = time.time()</span><br><span class="line">        <span class="variable language_">self</span>.metrics[<span class="string">&#x27;total_requests&#x27;</span>] += <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 速率限制检查</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">await</span> <span class="variable language_">self</span>.rate_limiter.check_rate_limit(request):</span><br><span class="line">                <span class="keyword">raise</span> Exception(<span class="string">&quot;Rate limit exceeded&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 缓存检查</span></span><br><span class="line">            cached_response = <span class="keyword">await</span> <span class="variable language_">self</span>.cache.get(request)</span><br><span class="line">            <span class="keyword">if</span> cached_response:</span><br><span class="line">                <span class="variable language_">self</span>.metrics[<span class="string">&#x27;cache_hit_rate&#x27;</span>] = (</span><br><span class="line">                    <span class="variable language_">self</span>.metrics[<span class="string">&#x27;cache_hit_rate&#x27;</span>] * <span class="number">0.9</span> + <span class="number">0.1</span></span><br><span class="line">                )</span><br><span class="line">                <span class="keyword">return</span> cached_response</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 选择模型实例</span></span><br><span class="line">            model_instance = <span class="keyword">await</span> <span class="variable language_">self</span>.load_balancer.select_model(</span><br><span class="line">                request.model_id, request</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> model_instance:</span><br><span class="line">                <span class="keyword">raise</span> Exception(<span class="string">f&quot;No available instance for model: <span class="subst">&#123;request.model_id&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 发送请求</span></span><br><span class="line">            response = <span class="keyword">await</span> <span class="variable language_">self</span>._send_request(model_instance, request)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 缓存响应</span></span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">self</span>.cache.put(request, response)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 更新指标</span></span><br><span class="line">            latency = time.time() - start_time</span><br><span class="line">            <span class="variable language_">self</span>._update_metrics(latency, <span class="literal">True</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> response</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="variable language_">self</span>._update_metrics(time.time() - start_time, <span class="literal">False</span>)</span><br><span class="line">            <span class="keyword">return</span> ModelResponse(</span><br><span class="line">                request_id=request.request_id,</span><br><span class="line">                model_id=request.model_id,</span><br><span class="line">                response=<span class="string">&quot;&quot;</span>,</span><br><span class="line">                tokens_used=<span class="number">0</span>,</span><br><span class="line">                latency=time.time() - start_time,</span><br><span class="line">                timestamp=datetime.now(),</span><br><span class="line">                error=<span class="built_in">str</span>(e)</span><br><span class="line">            )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_send_request</span>(<span class="params">self, model_instance: <span class="built_in">str</span>, request: ModelRequest</span>) -&gt; ModelResponse:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;发送请求到模型实例&quot;&quot;&quot;</span></span><br><span class="line">        model_info = <span class="variable language_">self</span>.models[request.model_id]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 获取连接</span></span><br><span class="line">        connection = <span class="keyword">await</span> <span class="variable language_">self</span>.connection_pool.get_connection(model_instance)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 构造请求数据</span></span><br><span class="line">            request_data = &#123;</span><br><span class="line">                <span class="string">&#x27;prompt&#x27;</span>: request.prompt,</span><br><span class="line">                <span class="string">&#x27;parameters&#x27;</span>: request.parameters,</span><br><span class="line">                <span class="string">&#x27;max_tokens&#x27;</span>: <span class="built_in">min</span>(</span><br><span class="line">                    request.parameters.get(<span class="string">&#x27;max_tokens&#x27;</span>, <span class="number">1000</span>),</span><br><span class="line">                    model_info.max_tokens</span><br><span class="line">                )</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 发送HTTP请求</span></span><br><span class="line">            <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">                <span class="keyword">async</span> <span class="keyword">with</span> session.post(</span><br><span class="line">                    model_info.endpoint,</span><br><span class="line">                    json=request_data,</span><br><span class="line">                    timeout=aiohttp.ClientTimeout(total=request.timeout)</span><br><span class="line">                ) <span class="keyword">as</span> response:</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> response.status == <span class="number">200</span>:</span><br><span class="line">                        result = <span class="keyword">await</span> response.json()</span><br><span class="line">                        </span><br><span class="line">                        <span class="keyword">return</span> ModelResponse(</span><br><span class="line">                            request_id=request.request_id,</span><br><span class="line">                            model_id=request.model_id,</span><br><span class="line">                            response=result.get(<span class="string">&#x27;response&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                            tokens_used=result.get(<span class="string">&#x27;tokens_used&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">                            latency=result.get(<span class="string">&#x27;latency&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">                            timestamp=datetime.now()</span><br><span class="line">                        )</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="keyword">raise</span> Exception(<span class="string">f&quot;Model request failed: <span class="subst">&#123;response.status&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            <span class="comment"># 释放连接</span></span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">self</span>.connection_pool.release_connection(model_instance, connection)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_health_check</span>(<span class="params">self, model_info: ModelInfo</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;健康检查&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 发送健康检查请求</span></span><br><span class="line">            test_request = ModelRequest(</span><br><span class="line">                request_id=<span class="string">&quot;health_check&quot;</span>,</span><br><span class="line">                model_id=model_info.model_id,</span><br><span class="line">                prompt=<span class="string">&quot;Hello&quot;</span>,</span><br><span class="line">                parameters=&#123;<span class="string">&#x27;max_tokens&#x27;</span>: <span class="number">1</span>&#125;,</span><br><span class="line">                timestamp=datetime.now()</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            response = <span class="keyword">await</span> <span class="variable language_">self</span>._send_request(model_info.model_id, test_request)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> response.error:</span><br><span class="line">                model_info.status = ModelStatus.ERROR</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                model_info.status = ModelStatus.READY</span><br><span class="line">                </span><br><span class="line">            model_info.last_health_check = datetime.now()</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            model_info.status = ModelStatus.ERROR</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Health check failed for <span class="subst">&#123;model_info.model_id&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_update_metrics</span>(<span class="params">self, latency: <span class="built_in">float</span>, success: <span class="built_in">bool</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;更新性能指标&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> success:</span><br><span class="line">            <span class="variable language_">self</span>.metrics[<span class="string">&#x27;successful_requests&#x27;</span>] += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.metrics[<span class="string">&#x27;failed_requests&#x27;</span>] += <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 更新平均延迟</span></span><br><span class="line">        total_requests = <span class="variable language_">self</span>.metrics[<span class="string">&#x27;total_requests&#x27;</span>]</span><br><span class="line">        current_avg = <span class="variable language_">self</span>.metrics[<span class="string">&#x27;avg_latency&#x27;</span>]</span><br><span class="line">        <span class="variable language_">self</span>.metrics[<span class="string">&#x27;avg_latency&#x27;</span>] = (</span><br><span class="line">            (current_avg * (total_requests - <span class="number">1</span>) + latency) / total_requests</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_metrics</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取性能指标&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            **<span class="variable language_">self</span>.metrics,</span><br><span class="line">            <span class="string">&#x27;success_rate&#x27;</span>: (</span><br><span class="line">                <span class="variable language_">self</span>.metrics[<span class="string">&#x27;successful_requests&#x27;</span>] / </span><br><span class="line">                <span class="built_in">max</span>(<span class="variable language_">self</span>.metrics[<span class="string">&#x27;total_requests&#x27;</span>], <span class="number">1</span>)</span><br><span class="line">            ),</span><br><span class="line">            <span class="string">&#x27;models_status&#x27;</span>: &#123;</span><br><span class="line">                model_id: model_info.status.value</span><br><span class="line">                <span class="keyword">for</span> model_id, model_info <span class="keyword">in</span> <span class="variable language_">self</span>.models.items()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ModelLoadBalancer</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;模型负载均衡器&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.model_weights: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">float</span>] = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.model_loads: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">int</span>] = defaultdict(<span class="built_in">int</span>)</span><br><span class="line">        <span class="variable language_">self</span>.model_response_times: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">float</span>] = defaultdict(<span class="built_in">float</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_model</span>(<span class="params">self, model_info: ModelInfo</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;添加模型到负载均衡&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.model_weights[model_info.model_id] = <span class="number">1.0</span></span><br><span class="line">        <span class="variable language_">self</span>.model_loads[model_info.model_id] = <span class="number">0</span></span><br><span class="line">        <span class="variable language_">self</span>.model_response_times[model_info.model_id] = <span class="number">0.0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">select_model</span>(<span class="params">self, model_id: <span class="built_in">str</span>, request: ModelRequest</span>) -&gt; <span class="type">Optional</span>[<span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;选择模型实例&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 基于负载和响应时间的智能选择</span></span><br><span class="line">        <span class="keyword">if</span> model_id <span class="keyword">in</span> <span class="variable language_">self</span>.model_loads:</span><br><span class="line">            current_load = <span class="variable language_">self</span>.model_loads[model_id]</span><br><span class="line">            avg_response_time = <span class="variable language_">self</span>.model_response_times[model_id]</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 计算综合得分</span></span><br><span class="line">            load_score = <span class="number">1.0</span> / (current_load + <span class="number">1</span>)</span><br><span class="line">            response_score = <span class="number">1.0</span> / (avg_response_time + <span class="number">0.1</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 如果负载过高，等待</span></span><br><span class="line">            <span class="keyword">if</span> current_load &gt; <span class="number">10</span>:  <span class="comment"># 可配置的阈值</span></span><br><span class="line">                <span class="keyword">await</span> asyncio.sleep(<span class="number">0.1</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 增加负载计数</span></span><br><span class="line">            <span class="variable language_">self</span>.model_loads[model_id] += <span class="number">1</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> model_id</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update_model_metrics</span>(<span class="params">self, model_id: <span class="built_in">str</span>, response_time: <span class="built_in">float</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;更新模型指标&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 减少负载计数</span></span><br><span class="line">        <span class="keyword">if</span> model_id <span class="keyword">in</span> <span class="variable language_">self</span>.model_loads:</span><br><span class="line">            <span class="variable language_">self</span>.model_loads[model_id] = <span class="built_in">max</span>(<span class="number">0</span>, <span class="variable language_">self</span>.model_loads[model_id] - <span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 更新平均响应时间</span></span><br><span class="line">        current_avg = <span class="variable language_">self</span>.model_response_times[model_id]</span><br><span class="line">        <span class="variable language_">self</span>.model_response_times[model_id] = (current_avg * <span class="number">0.9</span> + response_time * <span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ModelCache</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;模型缓存&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">        <span class="variable language_">self</span>.config = config</span><br><span class="line">        <span class="variable language_">self</span>.cache: <span class="type">Dict</span>[<span class="built_in">str</span>, ModelResponse] = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.cache_ttl = config.get(<span class="string">&#x27;ttl&#x27;</span>, <span class="number">300</span>)  <span class="comment"># 5分钟</span></span><br><span class="line">        <span class="variable language_">self</span>.max_size = config.get(<span class="string">&#x27;max_size&#x27;</span>, <span class="number">1000</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, request: ModelRequest</span>) -&gt; <span class="type">Optional</span>[ModelResponse]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取缓存响应&quot;&quot;&quot;</span></span><br><span class="line">        cache_key = <span class="variable language_">self</span>._generate_cache_key(request)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> cache_key <span class="keyword">in</span> <span class="variable language_">self</span>.cache:</span><br><span class="line">            response = <span class="variable language_">self</span>.cache[cache_key]</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 检查是否过期</span></span><br><span class="line">            <span class="keyword">if</span> (datetime.now() - response.timestamp).seconds &lt; <span class="variable language_">self</span>.cache_ttl:</span><br><span class="line">                <span class="keyword">return</span> response</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># 删除过期缓存</span></span><br><span class="line">                <span class="keyword">del</span> <span class="variable language_">self</span>.cache[cache_key]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">put</span>(<span class="params">self, request: ModelRequest, response: ModelResponse</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;缓存响应&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> response.error:</span><br><span class="line">            <span class="keyword">return</span>  <span class="comment"># 不缓存错误响应</span></span><br><span class="line">        </span><br><span class="line">        cache_key = <span class="variable language_">self</span>._generate_cache_key(request)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查缓存大小</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(<span class="variable language_">self</span>.cache) &gt;= <span class="variable language_">self</span>.max_size:</span><br><span class="line">            <span class="comment"># 删除最旧的缓存项</span></span><br><span class="line">            oldest_key = <span class="built_in">min</span>(<span class="variable language_">self</span>.cache.keys(), </span><br><span class="line">                           key=<span class="keyword">lambda</span> k: <span class="variable language_">self</span>.cache[k].timestamp)</span><br><span class="line">            <span class="keyword">del</span> <span class="variable language_">self</span>.cache[oldest_key]</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.cache[cache_key] = response</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_generate_cache_key</span>(<span class="params">self, request: ModelRequest</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;生成缓存键&quot;&quot;&quot;</span></span><br><span class="line">        key_data = &#123;</span><br><span class="line">            <span class="string">&#x27;model_id&#x27;</span>: request.model_id,</span><br><span class="line">            <span class="string">&#x27;prompt&#x27;</span>: request.prompt,</span><br><span class="line">            <span class="string">&#x27;parameters&#x27;</span>: request.parameters</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        key_str = json.dumps(key_data, sort_keys=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> hashlib.md5(key_str.encode()).hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ModelConnectionPool</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;模型连接池&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">        <span class="variable language_">self</span>.config = config</span><br><span class="line">        <span class="variable language_">self</span>.pools: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">List</span>[<span class="type">Any</span>]] = defaultdict(<span class="built_in">list</span>)</span><br><span class="line">        <span class="variable language_">self</span>.max_connections = config.get(<span class="string">&#x27;max_connections&#x27;</span>, <span class="number">10</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_connection</span>(<span class="params">self, model_instance: <span class="built_in">str</span></span>) -&gt; <span class="type">Any</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取连接&quot;&quot;&quot;</span></span><br><span class="line">        pool = <span class="variable language_">self</span>.pools[model_instance]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> pool:</span><br><span class="line">            <span class="keyword">return</span> pool.pop()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 创建新连接</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> <span class="variable language_">self</span>._create_connection(model_instance)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">release_connection</span>(<span class="params">self, model_instance: <span class="built_in">str</span>, connection: <span class="type">Any</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;释放连接&quot;&quot;&quot;</span></span><br><span class="line">        pool = <span class="variable language_">self</span>.pools[model_instance]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(pool) &lt; <span class="variable language_">self</span>.max_connections:</span><br><span class="line">            pool.append(connection)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 关闭多余连接</span></span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">self</span>._close_connection(connection)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_create_connection</span>(<span class="params">self, model_instance: <span class="built_in">str</span></span>) -&gt; <span class="type">Any</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;创建连接&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 这里实现具体的连接创建逻辑</span></span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&#x27;instance&#x27;</span>: model_instance, <span class="string">&#x27;created_at&#x27;</span>: datetime.now()&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_close_connection</span>(<span class="params">self, connection: <span class="type">Any</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;关闭连接&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 这里实现连接关闭逻辑</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ModelRateLimiter</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;模型速率限制器&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">        <span class="variable language_">self</span>.config = config</span><br><span class="line">        <span class="variable language_">self</span>.request_counts: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">List</span>[datetime]] = defaultdict(<span class="built_in">list</span>)</span><br><span class="line">        <span class="variable language_">self</span>.rate_limits = config.get(<span class="string">&#x27;rate_limits&#x27;</span>, &#123;&#125;)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">check_rate_limit</span>(<span class="params">self, request: ModelRequest</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检查速率限制&quot;&quot;&quot;</span></span><br><span class="line">        model_id = request.model_id</span><br><span class="line">        current_time = datetime.now()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 获取该模型的速率限制配置</span></span><br><span class="line">        rate_limit = <span class="variable language_">self</span>.rate_limits.get(model_id, &#123;</span><br><span class="line">            <span class="string">&#x27;requests_per_minute&#x27;</span>: <span class="number">60</span>,</span><br><span class="line">            <span class="string">&#x27;requests_per_hour&#x27;</span>: <span class="number">1000</span></span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 清理过期的请求记录</span></span><br><span class="line">        <span class="variable language_">self</span>._cleanup_old_requests(model_id, current_time)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查每分钟限制</span></span><br><span class="line">        minute_ago = current_time - timedelta(minutes=<span class="number">1</span>)</span><br><span class="line">        recent_requests = [</span><br><span class="line">            req_time <span class="keyword">for</span> req_time <span class="keyword">in</span> <span class="variable language_">self</span>.request_counts[model_id]</span><br><span class="line">            <span class="keyword">if</span> req_time &gt; minute_ago</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(recent_requests) &gt;= rate_limit[<span class="string">&#x27;requests_per_minute&#x27;</span>]:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查每小时限制</span></span><br><span class="line">        hour_ago = current_time - timedelta(hours=<span class="number">1</span>)</span><br><span class="line">        hourly_requests = [</span><br><span class="line">            req_time <span class="keyword">for</span> req_time <span class="keyword">in</span> <span class="variable language_">self</span>.request_counts[model_id]</span><br><span class="line">            <span class="keyword">if</span> req_time &gt; hour_ago</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(hourly_requests) &gt;= rate_limit[<span class="string">&#x27;requests_per_hour&#x27;</span>]:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 记录请求</span></span><br><span class="line">        <span class="variable language_">self</span>.request_counts[model_id].append(current_time)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_cleanup_old_requests</span>(<span class="params">self, model_id: <span class="built_in">str</span>, current_time: datetime</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;清理过期的请求记录&quot;&quot;&quot;</span></span><br><span class="line">        hour_ago = current_time - timedelta(hours=<span class="number">1</span>)</span><br><span class="line">        <span class="variable language_">self</span>.request_counts[model_id] = [</span><br><span class="line">            req_time <span class="keyword">for</span> req_time <span class="keyword">in</span> <span class="variable language_">self</span>.request_counts[model_id]</span><br><span class="line">            <span class="keyword">if</span> req_time &gt; hour_ago</span><br><span class="line">        ]</span><br></pre></td></tr></table></figure>

<h2 id="四、安全与权限控制"><a href="#四、安全与权限控制" class="headerlink" title="四、安全与权限控制"></a>四、安全与权限控制</h2><h3 id="4-1-安全架构设计"><a href="#4-1-安全架构设计" class="headerlink" title="4.1 安全架构设计"></a>4.1 安全架构设计</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line">    subgraph &quot;安全控制层&quot;</span><br><span class="line">        AUTH[认证服务]</span><br><span class="line">        AUTHZ[授权服务]</span><br><span class="line">        AUDIT[审计服务]</span><br><span class="line">        ENCRYPT[加密服务]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph &quot;权限管理&quot;</span><br><span class="line">        RBAC[角色权限控制]</span><br><span class="line">        POLICY[策略引擎]</span><br><span class="line">        TOKEN[令牌管理]</span><br><span class="line">        SESSION[会话管理]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph &quot;数据安全&quot;</span><br><span class="line">        MASK[数据脱敏]</span><br><span class="line">        FILTER[内容过滤]</span><br><span class="line">        BACKUP[备份加密]</span><br><span class="line">        RECOVERY[安全恢复]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph &quot;网络安全&quot;</span><br><span class="line">        FIREWALL[防火墙]</span><br><span class="line">        WAF[Web应用防火墙]</span><br><span class="line">        DDOS[DDoS防护]</span><br><span class="line">        SSL[SSL/TLS]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    AUTH --&gt; RBAC</span><br><span class="line">    AUTHZ --&gt; POLICY</span><br><span class="line">    AUDIT --&gt; TOKEN</span><br><span class="line">    ENCRYPT --&gt; SESSION</span><br><span class="line">    </span><br><span class="line">    RBAC --&gt; MASK</span><br><span class="line">    POLICY --&gt; FILTER</span><br><span class="line">    TOKEN --&gt; BACKUP</span><br><span class="line">    SESSION --&gt; RECOVERY</span><br><span class="line">    </span><br><span class="line">    MASK --&gt; FIREWALL</span><br><span class="line">    FILTER --&gt; WAF</span><br><span class="line">    BACKUP --&gt; DDOS</span><br><span class="line">    RECOVERY --&gt; SSL</span><br><span class="line">    </span><br><span class="line">    style AUTH fill:#ff9999</span><br><span class="line">    style RBAC fill:#99ccff</span><br><span class="line">    style MASK fill:#99ff99</span><br><span class="line">    style FIREWALL fill:#ffcc99</span><br></pre></td></tr></table></figure>

<h3 id="4-2-安全控制实现"><a href="#4-2-安全控制实现" class="headerlink" title="4.2 安全控制实现"></a>4.2 安全控制实现</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Any</span>, <span class="type">Optional</span>, <span class="type">Set</span></span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> secrets</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"><span class="keyword">import</span> bcrypt</span><br><span class="line"><span class="keyword">from</span> cryptography.fernet <span class="keyword">import</span> Fernet</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserRole</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;用户角色&quot;&quot;&quot;</span></span><br><span class="line">    ADMIN = <span class="string">&quot;admin&quot;</span></span><br><span class="line">    DEVELOPER = <span class="string">&quot;developer&quot;</span></span><br><span class="line">    ANALYST = <span class="string">&quot;analyst&quot;</span></span><br><span class="line">    VIEWER = <span class="string">&quot;viewer&quot;</span></span><br><span class="line">    GUEST = <span class="string">&quot;guest&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Permission</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;权限枚举&quot;&quot;&quot;</span></span><br><span class="line">    READ = <span class="string">&quot;read&quot;</span></span><br><span class="line">    WRITE = <span class="string">&quot;write&quot;</span></span><br><span class="line">    DELETE = <span class="string">&quot;delete&quot;</span></span><br><span class="line">    EXECUTE = <span class="string">&quot;execute&quot;</span></span><br><span class="line">    ADMIN = <span class="string">&quot;admin&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ResourceType</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;资源类型&quot;&quot;&quot;</span></span><br><span class="line">    AGENT = <span class="string">&quot;agent&quot;</span></span><br><span class="line">    WORKFLOW = <span class="string">&quot;workflow&quot;</span></span><br><span class="line">    MODEL = <span class="string">&quot;model&quot;</span></span><br><span class="line">    DATA = <span class="string">&quot;data&quot;</span></span><br><span class="line">    SYSTEM = <span class="string">&quot;system&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;用户信息&quot;&quot;&quot;</span></span><br><span class="line">    user_id: <span class="built_in">str</span></span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    email: <span class="built_in">str</span></span><br><span class="line">    password_hash: <span class="built_in">str</span></span><br><span class="line">    roles: <span class="type">List</span>[UserRole]</span><br><span class="line">    permissions: <span class="type">List</span>[Permission]</span><br><span class="line">    created_at: datetime</span><br><span class="line">    last_login: <span class="type">Optional</span>[datetime] = <span class="literal">None</span></span><br><span class="line">    is_active: <span class="built_in">bool</span> = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SecurityPolicy</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;安全策略&quot;&quot;&quot;</span></span><br><span class="line">    policy_id: <span class="built_in">str</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    resource_type: ResourceType</span><br><span class="line">    required_permissions: <span class="type">List</span>[Permission]</span><br><span class="line">    conditions: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span><br><span class="line">    is_active: <span class="built_in">bool</span> = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SecurityManager</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;安全管理器&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">        <span class="variable language_">self</span>.config = config</span><br><span class="line">        <span class="variable language_">self</span>.users: <span class="type">Dict</span>[<span class="built_in">str</span>, User] = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.policies: <span class="type">Dict</span>[<span class="built_in">str</span>, SecurityPolicy] = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.sessions: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]] = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.audit_logs: <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]] = []</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 初始化加密</span></span><br><span class="line">        <span class="variable language_">self</span>.encryption_key = config.get(<span class="string">&#x27;encryption_key&#x27;</span>, Fernet.generate_key())</span><br><span class="line">        <span class="variable language_">self</span>.cipher = Fernet(<span class="variable language_">self</span>.encryption_key)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># JWT配置</span></span><br><span class="line">        <span class="variable language_">self</span>.jwt_secret = config.get(<span class="string">&#x27;jwt_secret&#x27;</span>, secrets.token_urlsafe(<span class="number">32</span>))</span><br><span class="line">        <span class="variable language_">self</span>.jwt_algorithm = config.get(<span class="string">&#x27;jwt_algorithm&#x27;</span>, <span class="string">&#x27;HS256&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.jwt_expiration = config.get(<span class="string">&#x27;jwt_expiration&#x27;</span>, <span class="number">3600</span>)  <span class="comment"># 1小时</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 内容过滤配置</span></span><br><span class="line">        <span class="variable language_">self</span>.content_filter = ContentFilter(config.get(<span class="string">&#x27;content_filter&#x27;</span>, &#123;&#125;))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 数据脱敏配置</span></span><br><span class="line">        <span class="variable language_">self</span>.data_masker = DataMasker(config.get(<span class="string">&#x27;data_masker&#x27;</span>, &#123;&#125;))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">authenticate</span>(<span class="params">self, username: <span class="built_in">str</span>, password: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;用户认证&quot;&quot;&quot;</span></span><br><span class="line">        user = <span class="variable language_">self</span>._get_user_by_username(username)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user <span class="keyword">or</span> <span class="keyword">not</span> user.is_active:</span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">self</span>._log_security_event(<span class="string">&#x27;AUTH_FAILED&#x27;</span>, &#123;</span><br><span class="line">                <span class="string">&#x27;username&#x27;</span>: username,</span><br><span class="line">                <span class="string">&#x27;reason&#x27;</span>: <span class="string">&#x27;user_not_found_or_inactive&#x27;</span></span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 验证密码</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> bcrypt.checkpw(password.encode(<span class="string">&#x27;utf-8&#x27;</span>), user.password_hash.encode(<span class="string">&#x27;utf-8&#x27;</span>)):</span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">self</span>._log_security_event(<span class="string">&#x27;AUTH_FAILED&#x27;</span>, &#123;</span><br><span class="line">                <span class="string">&#x27;username&#x27;</span>: username,</span><br><span class="line">                <span class="string">&#x27;reason&#x27;</span>: <span class="string">&#x27;invalid_password&#x27;</span></span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 生成JWT令牌</span></span><br><span class="line">        token = <span class="variable language_">self</span>._generate_jwt_token(user)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建会话</span></span><br><span class="line">        session_id = secrets.token_urlsafe(<span class="number">32</span>)</span><br><span class="line">        <span class="variable language_">self</span>.sessions[session_id] = &#123;</span><br><span class="line">            <span class="string">&#x27;user_id&#x27;</span>: user.user_id,</span><br><span class="line">            <span class="string">&#x27;username&#x27;</span>: user.username,</span><br><span class="line">            <span class="string">&#x27;roles&#x27;</span>: [role.value <span class="keyword">for</span> role <span class="keyword">in</span> user.roles],</span><br><span class="line">            <span class="string">&#x27;created_at&#x27;</span>: datetime.now(),</span><br><span class="line">            <span class="string">&#x27;last_activity&#x27;</span>: datetime.now()</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 更新用户最后登录时间</span></span><br><span class="line">        user.last_login = datetime.now()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">self</span>._log_security_event(<span class="string">&#x27;AUTH_SUCCESS&#x27;</span>, &#123;</span><br><span class="line">            <span class="string">&#x27;username&#x27;</span>: username,</span><br><span class="line">            <span class="string">&#x27;session_id&#x27;</span>: session_id</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> token</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">authorize</span>(<span class="params">self, token: <span class="built_in">str</span>, resource_type: ResourceType, </span></span><br><span class="line"><span class="params">                       permission: Permission, resource_id: <span class="built_in">str</span> = <span class="literal">None</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;权限验证&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 验证JWT令牌</span></span><br><span class="line">            payload = jwt.decode(token, <span class="variable language_">self</span>.jwt_secret, algorithms=[<span class="variable language_">self</span>.jwt_algorithm])</span><br><span class="line">            user_id = payload.get(<span class="string">&#x27;user_id&#x27;</span>)</span><br><span class="line">            </span><br><span class="line">            user = <span class="variable language_">self</span>.users.get(user_id)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> user <span class="keyword">or</span> <span class="keyword">not</span> user.is_active:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 检查用户权限</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>._check_user_permission(user, resource_type, permission):</span><br><span class="line">                <span class="comment"># 检查策略</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">await</span> <span class="variable language_">self</span>._check_policies(user, resource_type, permission, resource_id):</span><br><span class="line">                    <span class="keyword">await</span> <span class="variable language_">self</span>._log_security_event(<span class="string">&#x27;AUTHZ_SUCCESS&#x27;</span>, &#123;</span><br><span class="line">                        <span class="string">&#x27;user_id&#x27;</span>: user_id,</span><br><span class="line">                        <span class="string">&#x27;resource_type&#x27;</span>: resource_type.value,</span><br><span class="line">                        <span class="string">&#x27;permission&#x27;</span>: permission.value,</span><br><span class="line">                        <span class="string">&#x27;resource_id&#x27;</span>: resource_id</span><br><span class="line">                    &#125;)</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">self</span>._log_security_event(<span class="string">&#x27;AUTHZ_FAILED&#x27;</span>, &#123;</span><br><span class="line">                <span class="string">&#x27;user_id&#x27;</span>: user_id,</span><br><span class="line">                <span class="string">&#x27;resource_type&#x27;</span>: resource_type.value,</span><br><span class="line">                <span class="string">&#x27;permission&#x27;</span>: permission.value,</span><br><span class="line">                <span class="string">&#x27;resource_id&#x27;</span>: resource_id</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> jwt.ExpiredSignatureError:</span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">self</span>._log_security_event(<span class="string">&#x27;TOKEN_EXPIRED&#x27;</span>, &#123;<span class="string">&#x27;token&#x27;</span>: token[:<span class="number">20</span>]&#125;)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">except</span> jwt.InvalidTokenError:</span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">self</span>._log_security_event(<span class="string">&#x27;TOKEN_INVALID&#x27;</span>, &#123;<span class="string">&#x27;token&#x27;</span>: token[:<span class="number">20</span>]&#125;)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_check_user_permission</span>(<span class="params">self, user: User, resource_type: ResourceType, </span></span><br><span class="line"><span class="params">                              permission: Permission</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检查用户权限&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 管理员拥有所有权限</span></span><br><span class="line">        <span class="keyword">if</span> UserRole.ADMIN <span class="keyword">in</span> user.roles:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查直接权限</span></span><br><span class="line">        <span class="keyword">if</span> permission <span class="keyword">in</span> user.permissions:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查角色权限</span></span><br><span class="line">        role_permissions = <span class="variable language_">self</span>._get_role_permissions(user.roles)</span><br><span class="line">        <span class="keyword">return</span> permission <span class="keyword">in</span> role_permissions</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_role_permissions</span>(<span class="params">self, roles: <span class="type">List</span>[UserRole]</span>) -&gt; <span class="type">Set</span>[Permission]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取角色权限&quot;&quot;&quot;</span></span><br><span class="line">        permissions = <span class="built_in">set</span>()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> role <span class="keyword">in</span> roles:</span><br><span class="line">            <span class="keyword">if</span> role == UserRole.ADMIN:</span><br><span class="line">                permissions.update(Permission)</span><br><span class="line">            <span class="keyword">elif</span> role == UserRole.DEVELOPER:</span><br><span class="line">                permissions.update([Permission.READ, Permission.WRITE, Permission.EXECUTE])</span><br><span class="line">            <span class="keyword">elif</span> role == UserRole.ANALYST:</span><br><span class="line">                permissions.update([Permission.READ, Permission.EXECUTE])</span><br><span class="line">            <span class="keyword">elif</span> role == UserRole.VIEWER:</span><br><span class="line">                permissions.add(Permission.READ)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> permissions</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_check_policies</span>(<span class="params">self, user: User, resource_type: ResourceType,</span></span><br><span class="line"><span class="params">                             permission: Permission, resource_id: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检查安全策略&quot;&quot;&quot;</span></span><br><span class="line">        applicable_policies = [</span><br><span class="line">            policy <span class="keyword">for</span> policy <span class="keyword">in</span> <span class="variable language_">self</span>.policies.values()</span><br><span class="line">            <span class="keyword">if</span> (policy.resource_type == resource_type <span class="keyword">and</span> </span><br><span class="line">                policy.is_active <span class="keyword">and</span></span><br><span class="line">                permission <span class="keyword">in</span> policy.required_permissions)</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> policy <span class="keyword">in</span> applicable_policies:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">await</span> <span class="variable language_">self</span>._evaluate_policy_conditions(policy, user, resource_id):</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_evaluate_policy_conditions</span>(<span class="params">self, policy: SecurityPolicy, </span></span><br><span class="line"><span class="params">                                        user: User, resource_id: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;评估策略条件&quot;&quot;&quot;</span></span><br><span class="line">        conditions = policy.conditions</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 时间条件</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;time_range&#x27;</span> <span class="keyword">in</span> conditions:</span><br><span class="line">            time_range = conditions[<span class="string">&#x27;time_range&#x27;</span>]</span><br><span class="line">            current_time = datetime.now().time()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> (time_range[<span class="string">&#x27;start&#x27;</span>] &lt;= current_time &lt;= time_range[<span class="string">&#x27;end&#x27;</span>]):</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># IP地址条件</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;allowed_ips&#x27;</span> <span class="keyword">in</span> conditions:</span><br><span class="line">            <span class="comment"># 这里需要从请求上下文获取IP地址</span></span><br><span class="line">            <span class="comment"># 实际实现中需要传入请求信息</span></span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 资源所有者条件</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;owner_only&#x27;</span> <span class="keyword">in</span> conditions <span class="keyword">and</span> conditions[<span class="string">&#x27;owner_only&#x27;</span>]:</span><br><span class="line">            <span class="comment"># 检查用户是否为资源所有者</span></span><br><span class="line">            <span class="comment"># 实际实现中需要查询资源所有者信息</span></span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_generate_jwt_token</span>(<span class="params">self, user: User</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;生成JWT令牌&quot;&quot;&quot;</span></span><br><span class="line">        payload = &#123;</span><br><span class="line">            <span class="string">&#x27;user_id&#x27;</span>: user.user_id,</span><br><span class="line">            <span class="string">&#x27;username&#x27;</span>: user.username,</span><br><span class="line">            <span class="string">&#x27;roles&#x27;</span>: [role.value <span class="keyword">for</span> role <span class="keyword">in</span> user.roles],</span><br><span class="line">            <span class="string">&#x27;exp&#x27;</span>: datetime.utcnow() + timedelta(seconds=<span class="variable language_">self</span>.jwt_expiration),</span><br><span class="line">            <span class="string">&#x27;iat&#x27;</span>: datetime.utcnow()</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> jwt.encode(payload, <span class="variable language_">self</span>.jwt_secret, algorithm=<span class="variable language_">self</span>.jwt_algorithm)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_user_by_username</span>(<span class="params">self, username: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[User]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;根据用户名获取用户&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> user <span class="keyword">in</span> <span class="variable language_">self</span>.users.values():</span><br><span class="line">            <span class="keyword">if</span> user.username == username:</span><br><span class="line">                <span class="keyword">return</span> user</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_log_security_event</span>(<span class="params">self, event_type: <span class="built_in">str</span>, details: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;记录安全事件&quot;&quot;&quot;</span></span><br><span class="line">        log_entry = &#123;</span><br><span class="line">            <span class="string">&#x27;timestamp&#x27;</span>: datetime.now(),</span><br><span class="line">            <span class="string">&#x27;event_type&#x27;</span>: event_type,</span><br><span class="line">            <span class="string">&#x27;details&#x27;</span>: details</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.audit_logs.append(log_entry)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 记录到日志文件</span></span><br><span class="line">        logging.info(<span class="string">f&quot;Security Event: <span class="subst">&#123;event_type&#125;</span> - <span class="subst">&#123;details&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">encrypt_data</span>(<span class="params">self, data: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;加密数据&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.cipher.encrypt(data.encode()).decode()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">decrypt_data</span>(<span class="params">self, encrypted_data: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;解密数据&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.cipher.decrypt(encrypted_data.encode()).decode()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">filter_content</span>(<span class="params">self, content: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;过滤内容&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> <span class="variable language_">self</span>.content_filter.<span class="built_in">filter</span>(content)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">mask_sensitive_data</span>(<span class="params">self, data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;脱敏敏感数据&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> <span class="variable language_">self</span>.data_masker.mask(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ContentFilter</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;内容过滤器&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">        <span class="variable language_">self</span>.config = config</span><br><span class="line">        <span class="variable language_">self</span>.blocked_words = config.get(<span class="string">&#x27;blocked_words&#x27;</span>, [])</span><br><span class="line">        <span class="variable language_">self</span>.sensitive_patterns = config.get(<span class="string">&#x27;sensitive_patterns&#x27;</span>, [])</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">filter</span>(<span class="params">self, content: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;过滤内容&quot;&quot;&quot;</span></span><br><span class="line">        filtered_content = content</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 过滤敏感词汇</span></span><br><span class="line">        <span class="keyword">for</span> word <span class="keyword">in</span> <span class="variable language_">self</span>.blocked_words:</span><br><span class="line">            filtered_content = re.sub(</span><br><span class="line">                re.escape(word), </span><br><span class="line">                <span class="string">&#x27;*&#x27;</span> * <span class="built_in">len</span>(word), </span><br><span class="line">                filtered_content, </span><br><span class="line">                flags=re.IGNORECASE</span><br><span class="line">            )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 过滤敏感模式</span></span><br><span class="line">        <span class="keyword">for</span> pattern <span class="keyword">in</span> <span class="variable language_">self</span>.sensitive_patterns:</span><br><span class="line">            filtered_content = re.sub(</span><br><span class="line">                pattern[<span class="string">&#x27;regex&#x27;</span>], </span><br><span class="line">                pattern[<span class="string">&#x27;replacement&#x27;</span>], </span><br><span class="line">                filtered_content</span><br><span class="line">            )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> filtered_content</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DataMasker</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;数据脱敏器&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">        <span class="variable language_">self</span>.config = config</span><br><span class="line">        <span class="variable language_">self</span>.masking_rules = config.get(<span class="string">&#x27;masking_rules&#x27;</span>, &#123;&#125;)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">mask</span>(<span class="params">self, data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;脱敏数据&quot;&quot;&quot;</span></span><br><span class="line">        masked_data = data.copy()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> field, rule <span class="keyword">in</span> <span class="variable language_">self</span>.masking_rules.items():</span><br><span class="line">            <span class="keyword">if</span> field <span class="keyword">in</span> masked_data:</span><br><span class="line">                masked_data[field] = <span class="variable language_">self</span>._apply_masking_rule(</span><br><span class="line">                    masked_data[field], rule</span><br><span class="line">                )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> masked_data</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_apply_masking_rule</span>(<span class="params">self, value: <span class="type">Any</span>, rule: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="type">Any</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;应用脱敏规则&quot;&quot;&quot;</span></span><br><span class="line">        rule_type = rule.get(<span class="string">&#x27;type&#x27;</span>, <span class="string">&#x27;replace&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> rule_type == <span class="string">&#x27;replace&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> rule.get(<span class="string">&#x27;replacement&#x27;</span>, <span class="string">&#x27;***&#x27;</span>)</span><br><span class="line">        <span class="keyword">elif</span> rule_type == <span class="string">&#x27;partial&#x27;</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(value, <span class="built_in">str</span>):</span><br><span class="line">                start = rule.get(<span class="string">&#x27;start&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">                end = rule.get(<span class="string">&#x27;end&#x27;</span>, <span class="built_in">len</span>(value))</span><br><span class="line">                <span class="keyword">return</span> value[:start] + <span class="string">&#x27;*&#x27;</span> * (end - start) + value[end:]</span><br><span class="line">        <span class="keyword">elif</span> rule_type == <span class="string">&#x27;hash&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> hashlib.md5(<span class="built_in">str</span>(value).encode()).hexdigest()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> value</span><br></pre></td></tr></table></figure>

<h2 id="五、监控与运维"><a href="#五、监控与运维" class="headerlink" title="五、监控与运维"></a>五、监控与运维</h2><h3 id="5-1-监控架构"><a href="#5-1-监控架构" class="headerlink" title="5.1 监控架构"></a>5.1 监控架构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line">    subgraph &quot;监控数据收集&quot;</span><br><span class="line">        METRICS[指标收集]</span><br><span class="line">        LOGS[日志收集]</span><br><span class="line">        TRACES[链路追踪]</span><br><span class="line">        EVENTS[事件收集]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph &quot;数据处理&quot;</span><br><span class="line">        PROCESS[数据处理]</span><br><span class="line">        AGGREGATE[聚合分析]</span><br><span class="line">        FILTER[过滤清洗]</span><br><span class="line">        ENRICH[数据增强]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph &quot;存储层&quot;</span><br><span class="line">        TSDB[时序数据库]</span><br><span class="line">        LOGDB[日志数据库]</span><br><span class="line">        METADB[元数据库]</span><br><span class="line">        CACHE[缓存层]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph &quot;分析与告警&quot;</span><br><span class="line">        ANALYZE[实时分析]</span><br><span class="line">        ALERT[告警引擎]</span><br><span class="line">        PREDICT[预测分析]</span><br><span class="line">        REPORT[报告生成]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph &quot;可视化&quot;</span><br><span class="line">        DASHBOARD[监控面板]</span><br><span class="line">        GRAPH[图表展示]</span><br><span class="line">        REPORT_UI[报告界面]</span><br><span class="line">        ALERT_UI[告警界面]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    METRICS --&gt; PROCESS</span><br><span class="line">    LOGS --&gt; PROCESS</span><br><span class="line">    TRACES --&gt; PROCESS</span><br><span class="line">    EVENTS --&gt; PROCESS</span><br><span class="line">    </span><br><span class="line">    PROCESS --&gt; AGGREGATE</span><br><span class="line">    AGGREGATE --&gt; FILTER</span><br><span class="line">    FILTER --&gt; ENRICH</span><br><span class="line">    </span><br><span class="line">    ENRICH --&gt; TSDB</span><br><span class="line">    ENRICH --&gt; LOGDB</span><br><span class="line">    ENRICH --&gt; METADB</span><br><span class="line">    ENRICH --&gt; CACHE</span><br><span class="line">    </span><br><span class="line">    TSDB --&gt; ANALYZE</span><br><span class="line">    LOGDB --&gt; ANALYZE</span><br><span class="line">    METADB --&gt; ANALYZE</span><br><span class="line">    CACHE --&gt; ANALYZE</span><br><span class="line">    </span><br><span class="line">    ANALYZE --&gt; ALERT</span><br><span class="line">    ANALYZE --&gt; PREDICT</span><br><span class="line">    ANALYZE --&gt; REPORT</span><br><span class="line">    </span><br><span class="line">    ALERT --&gt; DASHBOARD</span><br><span class="line">    PREDICT --&gt; DASHBOARD</span><br><span class="line">    REPORT --&gt; DASHBOARD</span><br><span class="line">    </span><br><span class="line">    DASHBOARD --&gt; GRAPH</span><br><span class="line">    DASHBOARD --&gt; REPORT_UI</span><br><span class="line">    DASHBOARD --&gt; ALERT_UI</span><br><span class="line">    </span><br><span class="line">    style METRICS fill:#e1f5fe</span><br><span class="line">    style ANALYZE fill:#fff3e0</span><br><span class="line">    style DASHBOARD fill:#e8f5e8</span><br></pre></td></tr></table></figure>

<h3 id="5-2-监控系统实现"><a href="#5-2-监控系统实现" class="headerlink" title="5.2 监控系统实现"></a>5.2 监控系统实现</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Any</span>, <span class="type">Optional</span>, <span class="type">Callable</span></span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass, field</span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict, deque</span><br><span class="line"><span class="keyword">import</span> statistics</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MetricType</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;指标类型&quot;&quot;&quot;</span></span><br><span class="line">    COUNTER = <span class="string">&quot;counter&quot;</span></span><br><span class="line">    GAUGE = <span class="string">&quot;gauge&quot;</span></span><br><span class="line">    HISTOGRAM = <span class="string">&quot;histogram&quot;</span></span><br><span class="line">    SUMMARY = <span class="string">&quot;summary&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AlertLevel</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;告警级别&quot;&quot;&quot;</span></span><br><span class="line">    INFO = <span class="string">&quot;info&quot;</span></span><br><span class="line">    WARNING = <span class="string">&quot;warning&quot;</span></span><br><span class="line">    ERROR = <span class="string">&quot;error&quot;</span></span><br><span class="line">    CRITICAL = <span class="string">&quot;critical&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Metric</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;指标定义&quot;&quot;&quot;</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    <span class="built_in">type</span>: MetricType</span><br><span class="line">    value: <span class="built_in">float</span></span><br><span class="line">    timestamp: datetime</span><br><span class="line">    labels: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">str</span>] = field(default_factory=<span class="built_in">dict</span>)</span><br><span class="line">    description: <span class="built_in">str</span> = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Alert</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;告警定义&quot;&quot;&quot;</span></span><br><span class="line">    alert_id: <span class="built_in">str</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    level: AlertLevel</span><br><span class="line">    message: <span class="built_in">str</span></span><br><span class="line">    timestamp: datetime</span><br><span class="line">    source: <span class="built_in">str</span></span><br><span class="line">    labels: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">str</span>] = field(default_factory=<span class="built_in">dict</span>)</span><br><span class="line">    resolved: <span class="built_in">bool</span> = <span class="literal">False</span></span><br><span class="line">    resolved_at: <span class="type">Optional</span>[datetime] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AlertRule</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;告警规则&quot;&quot;&quot;</span></span><br><span class="line">    rule_id: <span class="built_in">str</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    metric_name: <span class="built_in">str</span></span><br><span class="line">    condition: <span class="built_in">str</span>  <span class="comment"># 条件表达式</span></span><br><span class="line">    threshold: <span class="built_in">float</span></span><br><span class="line">    level: AlertLevel</span><br><span class="line">    duration: <span class="built_in">int</span>  <span class="comment"># 持续时间（秒）</span></span><br><span class="line">    is_active: <span class="built_in">bool</span> = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MonitoringSystem</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;监控系统&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">        <span class="variable language_">self</span>.config = config</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 指标存储</span></span><br><span class="line">        <span class="variable language_">self</span>.metrics: <span class="type">Dict</span>[<span class="built_in">str</span>, deque] = defaultdict(<span class="keyword">lambda</span>: deque(maxlen=<span class="number">1000</span>))</span><br><span class="line">        <span class="variable language_">self</span>.metric_definitions: <span class="type">Dict</span>[<span class="built_in">str</span>, MetricType] = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 告警系统</span></span><br><span class="line">        <span class="variable language_">self</span>.alerts: <span class="type">List</span>[Alert] = []</span><br><span class="line">        <span class="variable language_">self</span>.alert_rules: <span class="type">Dict</span>[<span class="built_in">str</span>, AlertRule] = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.alert_handlers: <span class="type">List</span>[<span class="type">Callable</span>] = []</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 性能统计</span></span><br><span class="line">        <span class="variable language_">self</span>.performance_stats = &#123;</span><br><span class="line">            <span class="string">&#x27;agent_performance&#x27;</span>: defaultdict(<span class="built_in">dict</span>),</span><br><span class="line">            <span class="string">&#x27;model_performance&#x27;</span>: defaultdict(<span class="built_in">dict</span>),</span><br><span class="line">            <span class="string">&#x27;workflow_performance&#x27;</span>: defaultdict(<span class="built_in">dict</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 健康状态</span></span><br><span class="line">        <span class="variable language_">self</span>.health_status = &#123;</span><br><span class="line">            <span class="string">&#x27;overall&#x27;</span>: <span class="string">&#x27;healthy&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;components&#x27;</span>: &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 启动后台任务</span></span><br><span class="line">        <span class="variable language_">self</span>.monitoring_task = <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">start</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;启动监控系统&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.monitoring_task = asyncio.create_task(<span class="variable language_">self</span>._monitoring_loop())</span><br><span class="line">        logging.info(<span class="string">&quot;Monitoring system started&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">stop</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;停止监控系统&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.monitoring_task:</span><br><span class="line">            <span class="variable language_">self</span>.monitoring_task.cancel()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">await</span> <span class="variable language_">self</span>.monitoring_task</span><br><span class="line">            <span class="keyword">except</span> asyncio.CancelledError:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">        logging.info(<span class="string">&quot;Monitoring system stopped&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">record_metric</span>(<span class="params">self, metric: Metric</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;记录指标&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.metrics[metric.name].append(metric)</span><br><span class="line">        <span class="variable language_">self</span>.metric_definitions[metric.name] = metric.<span class="built_in">type</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查告警规则</span></span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">self</span>._check_alert_rules(metric)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_monitoring_loop</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;监控循环&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># 收集系统指标</span></span><br><span class="line">                <span class="keyword">await</span> <span class="variable language_">self</span>._collect_system_metrics()</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 分析性能趋势</span></span><br><span class="line">                <span class="keyword">await</span> <span class="variable language_">self</span>._analyze_performance_trends()</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 更新健康状态</span></span><br><span class="line">                <span class="keyword">await</span> <span class="variable language_">self</span>._update_health_status()</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 清理过期数据</span></span><br><span class="line">                <span class="keyword">await</span> <span class="variable language_">self</span>._cleanup_old_data()</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">await</span> asyncio.sleep(<span class="number">10</span>)  <span class="comment"># 10秒间隔</span></span><br><span class="line">                </span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                logging.error(<span class="string">f&quot;Monitoring loop error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">await</span> asyncio.sleep(<span class="number">5</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_collect_system_metrics</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;收集系统指标&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">import</span> psutil</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># CPU使用率</span></span><br><span class="line">        cpu_metric = Metric(</span><br><span class="line">            name=<span class="string">&quot;system_cpu_usage&quot;</span>,</span><br><span class="line">            <span class="built_in">type</span>=MetricType.GAUGE,</span><br><span class="line">            value=psutil.cpu_percent(),</span><br><span class="line">            timestamp=datetime.now()</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">self</span>.record_metric(cpu_metric)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 内存使用率</span></span><br><span class="line">        memory = psutil.virtual_memory()</span><br><span class="line">        memory_metric = Metric(</span><br><span class="line">            name=<span class="string">&quot;system_memory_usage&quot;</span>,</span><br><span class="line">            <span class="built_in">type</span>=MetricType.GAUGE,</span><br><span class="line">            value=memory.percent,</span><br><span class="line">            timestamp=datetime.now()</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">self</span>.record_metric(memory_metric)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 磁盘使用率</span></span><br><span class="line">        disk = psutil.disk_usage(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">        disk_metric = Metric(</span><br><span class="line">            name=<span class="string">&quot;system_disk_usage&quot;</span>,</span><br><span class="line">            <span class="built_in">type</span>=MetricType.GAUGE,</span><br><span class="line">            value=(disk.used / disk.total) * <span class="number">100</span>,</span><br><span class="line">            timestamp=datetime.now()</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">self</span>.record_metric(disk_metric)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_check_alert_rules</span>(<span class="params">self, metric: Metric</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检查告警规则&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> rule <span class="keyword">in</span> <span class="variable language_">self</span>.alert_rules.values():</span><br><span class="line">            <span class="keyword">if</span> rule.metric_name == metric.name <span class="keyword">and</span> rule.is_active:</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">await</span> <span class="variable language_">self</span>._evaluate_alert_condition(rule, metric):</span><br><span class="line">                    <span class="keyword">await</span> <span class="variable language_">self</span>._trigger_alert(rule, metric)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_evaluate_alert_condition</span>(<span class="params">self, rule: AlertRule, metric: Metric</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;评估告警条件&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 简单的条件评估</span></span><br><span class="line">            <span class="keyword">if</span> rule.condition == <span class="string">&quot;greater_than&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> metric.value &gt; rule.threshold</span><br><span class="line">            <span class="keyword">elif</span> rule.condition == <span class="string">&quot;less_than&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> metric.value &lt; rule.threshold</span><br><span class="line">            <span class="keyword">elif</span> rule.condition == <span class="string">&quot;equals&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> metric.value == rule.threshold</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 更复杂的条件可以使用表达式解析器</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logging.error(<span class="string">f&quot;Error evaluating alert condition: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_trigger_alert</span>(<span class="params">self, rule: AlertRule, metric: Metric</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;触发告警&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 检查是否已存在相同告警</span></span><br><span class="line">        existing_alert = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">for</span> alert <span class="keyword">in</span> <span class="variable language_">self</span>.alerts:</span><br><span class="line">            <span class="keyword">if</span> (alert.name == rule.name <span class="keyword">and</span> </span><br><span class="line">                <span class="keyword">not</span> alert.resolved <span class="keyword">and</span></span><br><span class="line">                alert.source == metric.name):</span><br><span class="line">                existing_alert = alert</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> existing_alert:</span><br><span class="line">            <span class="comment"># 更新现有告警</span></span><br><span class="line">            existing_alert.timestamp = datetime.now()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 创建新告警</span></span><br><span class="line">            alert = Alert(</span><br><span class="line">                alert_id=<span class="string">f&quot;alert_<span class="subst">&#123;<span class="built_in">int</span>(time.time() * <span class="number">1000</span>)&#125;</span>&quot;</span>,</span><br><span class="line">                name=rule.name,</span><br><span class="line">                level=rule.level,</span><br><span class="line">                message=<span class="string">f&quot;Metric <span class="subst">&#123;metric.name&#125;</span> value <span class="subst">&#123;metric.value&#125;</span> <span class="subst">&#123;rule.condition&#125;</span> <span class="subst">&#123;rule.threshold&#125;</span>&quot;</span>,</span><br><span class="line">                timestamp=datetime.now(),</span><br><span class="line">                source=metric.name,</span><br><span class="line">                labels=metric.labels</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">self</span>.alerts.append(alert)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 通知告警处理器</span></span><br><span class="line">            <span class="keyword">for</span> handler <span class="keyword">in</span> <span class="variable language_">self</span>.alert_handlers:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">await</span> handler(alert)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    logging.error(<span class="string">f&quot;Alert handler error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_analyze_performance_trends</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;分析性能趋势&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 分析Agent性能</span></span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">self</span>._analyze_agent_performance()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 分析模型性能</span></span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">self</span>._analyze_model_performance()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 分析工作流性能</span></span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">self</span>._analyze_workflow_performance()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_analyze_agent_performance</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;分析Agent性能&quot;&quot;&quot;</span></span><br><span class="line">        agent_metrics = [</span><br><span class="line">            name <span class="keyword">for</span> name <span class="keyword">in</span> <span class="variable language_">self</span>.metrics.keys()</span><br><span class="line">            <span class="keyword">if</span> name.startswith(<span class="string">&#x27;agent_&#x27;</span>)</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> metric_name <span class="keyword">in</span> agent_metrics:</span><br><span class="line">            metrics = <span class="built_in">list</span>(<span class="variable language_">self</span>.metrics[metric_name])</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(metrics) &gt;= <span class="number">10</span>:  <span class="comment"># 至少10个数据点</span></span><br><span class="line">                values = [m.value <span class="keyword">for</span> m <span class="keyword">in</span> metrics[-<span class="number">10</span>:]]</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 计算统计信息</span></span><br><span class="line">                stats = &#123;</span><br><span class="line">                    <span class="string">&#x27;avg&#x27;</span>: statistics.mean(values),</span><br><span class="line">                    <span class="string">&#x27;min&#x27;</span>: <span class="built_in">min</span>(values),</span><br><span class="line">                    <span class="string">&#x27;max&#x27;</span>: <span class="built_in">max</span>(values),</span><br><span class="line">                    <span class="string">&#x27;std&#x27;</span>: statistics.stdev(values) <span class="keyword">if</span> <span class="built_in">len</span>(values) &gt; <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span>,</span><br><span class="line">                    <span class="string">&#x27;trend&#x27;</span>: <span class="variable language_">self</span>._calculate_trend(values)</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="variable language_">self</span>.performance_stats[<span class="string">&#x27;agent_performance&#x27;</span>][metric_name] = stats</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_analyze_model_performance</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;分析模型性能&quot;&quot;&quot;</span></span><br><span class="line">        model_metrics = [</span><br><span class="line">            name <span class="keyword">for</span> name <span class="keyword">in</span> <span class="variable language_">self</span>.metrics.keys()</span><br><span class="line">            <span class="keyword">if</span> name.startswith(<span class="string">&#x27;model_&#x27;</span>)</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> metric_name <span class="keyword">in</span> model_metrics:</span><br><span class="line">            metrics = <span class="built_in">list</span>(<span class="variable language_">self</span>.metrics[metric_name])</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(metrics) &gt;= <span class="number">5</span>:</span><br><span class="line">                values = [m.value <span class="keyword">for</span> m <span class="keyword">in</span> metrics[-<span class="number">5</span>:]]</span><br><span class="line">                </span><br><span class="line">                stats = &#123;</span><br><span class="line">                    <span class="string">&#x27;avg_latency&#x27;</span>: statistics.mean(values),</span><br><span class="line">                    <span class="string">&#x27;p95_latency&#x27;</span>: <span class="variable language_">self</span>._calculate_percentile(values, <span class="number">95</span>),</span><br><span class="line">                    <span class="string">&#x27;p99_latency&#x27;</span>: <span class="variable language_">self</span>._calculate_percentile(values, <span class="number">99</span>),</span><br><span class="line">                    <span class="string">&#x27;throughput&#x27;</span>: <span class="built_in">len</span>(values) / <span class="number">60</span>  <span class="comment"># 每分钟请求数</span></span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="variable language_">self</span>.performance_stats[<span class="string">&#x27;model_performance&#x27;</span>][metric_name] = stats</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_analyze_workflow_performance</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;分析工作流性能&quot;&quot;&quot;</span></span><br><span class="line">        workflow_metrics = [</span><br><span class="line">            name <span class="keyword">for</span> name <span class="keyword">in</span> <span class="variable language_">self</span>.metrics.keys()</span><br><span class="line">            <span class="keyword">if</span> name.startswith(<span class="string">&#x27;workflow_&#x27;</span>)</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> metric_name <span class="keyword">in</span> workflow_metrics:</span><br><span class="line">            metrics = <span class="built_in">list</span>(<span class="variable language_">self</span>.metrics[metric_name])</span><br><span class="line">            <span class="keyword">if</span> metrics:</span><br><span class="line">                recent_metrics = [</span><br><span class="line">                    m <span class="keyword">for</span> m <span class="keyword">in</span> metrics</span><br><span class="line">                    <span class="keyword">if</span> (datetime.now() - m.timestamp).seconds &lt; <span class="number">3600</span></span><br><span class="line">                ]</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> recent_metrics:</span><br><span class="line">                    values = [m.value <span class="keyword">for</span> m <span class="keyword">in</span> recent_metrics]</span><br><span class="line">                    </span><br><span class="line">                    stats = &#123;</span><br><span class="line">                        <span class="string">&#x27;success_rate&#x27;</span>: <span class="built_in">len</span>([v <span class="keyword">for</span> v <span class="keyword">in</span> values <span class="keyword">if</span> v == <span class="number">1</span>]) / <span class="built_in">len</span>(values),</span><br><span class="line">                        <span class="string">&#x27;avg_duration&#x27;</span>: statistics.mean(values),</span><br><span class="line">                        <span class="string">&#x27;total_executions&#x27;</span>: <span class="built_in">len</span>(values)</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="variable language_">self</span>.performance_stats[<span class="string">&#x27;workflow_performance&#x27;</span>][metric_name] = stats</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_calculate_trend</span>(<span class="params">self, values: <span class="type">List</span>[<span class="built_in">float</span>]</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;计算趋势&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(values) &lt; <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;stable&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 简单的趋势计算</span></span><br><span class="line">        first_half = values[:<span class="built_in">len</span>(values)//<span class="number">2</span>]</span><br><span class="line">        second_half = values[<span class="built_in">len</span>(values)//<span class="number">2</span>:]</span><br><span class="line">        </span><br><span class="line">        first_avg = statistics.mean(first_half)</span><br><span class="line">        second_avg = statistics.mean(second_half)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> second_avg &gt; first_avg * <span class="number">1.1</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;increasing&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> second_avg &lt; first_avg * <span class="number">0.9</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;decreasing&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;stable&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_calculate_percentile</span>(<span class="params">self, values: <span class="type">List</span>[<span class="built_in">float</span>], percentile: <span class="built_in">int</span></span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;计算百分位数&quot;&quot;&quot;</span></span><br><span class="line">        sorted_values = <span class="built_in">sorted</span>(values)</span><br><span class="line">        index = <span class="built_in">int</span>((percentile / <span class="number">100</span>) * <span class="built_in">len</span>(sorted_values))</span><br><span class="line">        <span class="keyword">return</span> sorted_values[<span class="built_in">min</span>(index, <span class="built_in">len</span>(sorted_values) - <span class="number">1</span>)]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_update_health_status</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;更新健康状态&quot;&quot;&quot;</span></span><br><span class="line">        component_health = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查各组件健康状态</span></span><br><span class="line">        <span class="keyword">for</span> component <span class="keyword">in</span> [<span class="string">&#x27;agents&#x27;</span>, <span class="string">&#x27;models&#x27;</span>, <span class="string">&#x27;workflows&#x27;</span>, <span class="string">&#x27;storage&#x27;</span>]:</span><br><span class="line">            health = <span class="keyword">await</span> <span class="variable language_">self</span>._check_component_health(component)</span><br><span class="line">            component_health[component] = health</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 计算整体健康状态</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">all</span>(status == <span class="string">&#x27;healthy&#x27;</span> <span class="keyword">for</span> status <span class="keyword">in</span> component_health.values()):</span><br><span class="line">            overall_health = <span class="string">&#x27;healthy&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">any</span>(status == <span class="string">&#x27;critical&#x27;</span> <span class="keyword">for</span> status <span class="keyword">in</span> component_health.values()):</span><br><span class="line">            overall_health = <span class="string">&#x27;critical&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">any</span>(status == <span class="string">&#x27;warning&#x27;</span> <span class="keyword">for</span> status <span class="keyword">in</span> component_health.values()):</span><br><span class="line">            overall_health = <span class="string">&#x27;warning&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            overall_health = <span class="string">&#x27;unknown&#x27;</span></span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.health_status = &#123;</span><br><span class="line">            <span class="string">&#x27;overall&#x27;</span>: overall_health,</span><br><span class="line">            <span class="string">&#x27;components&#x27;</span>: component_health,</span><br><span class="line">            <span class="string">&#x27;last_updated&#x27;</span>: datetime.now()</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_check_component_health</span>(<span class="params">self, component: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检查组件健康状态&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 根据相关指标判断组件健康状态</span></span><br><span class="line">        relevant_metrics = [</span><br><span class="line">            name <span class="keyword">for</span> name <span class="keyword">in</span> <span class="variable language_">self</span>.metrics.keys()</span><br><span class="line">            <span class="keyword">if</span> name.startswith(<span class="string">f&#x27;<span class="subst">&#123;component&#125;</span>_&#x27;</span>)</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> relevant_metrics:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;unknown&#x27;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查是否有严重告警</span></span><br><span class="line">        critical_alerts = [</span><br><span class="line">            alert <span class="keyword">for</span> alert <span class="keyword">in</span> <span class="variable language_">self</span>.alerts</span><br><span class="line">            <span class="keyword">if</span> (alert.level == AlertLevel.CRITICAL <span class="keyword">and</span> </span><br><span class="line">                <span class="keyword">not</span> alert.resolved <span class="keyword">and</span></span><br><span class="line">                alert.source.startswith(<span class="string">f&#x27;<span class="subst">&#123;component&#125;</span>_&#x27;</span>))</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> critical_alerts:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;critical&#x27;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查是否有警告告警</span></span><br><span class="line">        warning_alerts = [</span><br><span class="line">            alert <span class="keyword">for</span> alert <span class="keyword">in</span> <span class="variable language_">self</span>.alerts</span><br><span class="line">            <span class="keyword">if</span> (alert.level == AlertLevel.WARNING <span class="keyword">and</span> </span><br><span class="line">                <span class="keyword">not</span> alert.resolved <span class="keyword">and</span></span><br><span class="line">                alert.source.startswith(<span class="string">f&#x27;<span class="subst">&#123;component&#125;</span>_&#x27;</span>))</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> warning_alerts:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;warning&#x27;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;healthy&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_cleanup_old_data</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;清理过期数据&quot;&quot;&quot;</span></span><br><span class="line">        cutoff_time = datetime.now() - timedelta(hours=<span class="number">24</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 清理过期告警</span></span><br><span class="line">        <span class="variable language_">self</span>.alerts = [</span><br><span class="line">            alert <span class="keyword">for</span> alert <span class="keyword">in</span> <span class="variable language_">self</span>.alerts</span><br><span class="line">            <span class="keyword">if</span> alert.timestamp &gt; cutoff_time <span class="keyword">or</span> <span class="keyword">not</span> alert.resolved</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 清理过期指标（deque会自动限制大小）</span></span><br><span class="line">        <span class="comment"># 这里可以添加更复杂的清理逻辑</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_alert_rule</span>(<span class="params">self, rule: AlertRule</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;添加告警规则&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.alert_rules[rule.rule_id] = rule</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_alert_handler</span>(<span class="params">self, handler: <span class="type">Callable</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;添加告警处理器&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.alert_handlers.append(handler)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_metrics</span>(<span class="params">self, metric_name: <span class="built_in">str</span>, </span></span><br><span class="line"><span class="params">                   start_time: <span class="type">Optional</span>[datetime] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                   end_time: <span class="type">Optional</span>[datetime] = <span class="literal">None</span></span>) -&gt; <span class="type">List</span>[Metric]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取指标数据&quot;&quot;&quot;</span></span><br><span class="line">        metrics = <span class="built_in">list</span>(<span class="variable language_">self</span>.metrics.get(metric_name, []))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> start_time <span class="keyword">or</span> end_time:</span><br><span class="line">            filtered_metrics = []</span><br><span class="line">            <span class="keyword">for</span> metric <span class="keyword">in</span> metrics:</span><br><span class="line">                <span class="keyword">if</span> start_time <span class="keyword">and</span> metric.timestamp &lt; start_time:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="keyword">if</span> end_time <span class="keyword">and</span> metric.timestamp &gt; end_time:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                filtered_metrics.append(metric)</span><br><span class="line">            <span class="keyword">return</span> filtered_metrics</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> metrics</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_alerts</span>(<span class="params">self, resolved: <span class="type">Optional</span>[<span class="built_in">bool</span>] = <span class="literal">None</span></span>) -&gt; <span class="type">List</span>[Alert]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取告警信息&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> resolved <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.alerts</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> [alert <span class="keyword">for</span> alert <span class="keyword">in</span> <span class="variable language_">self</span>.alerts <span class="keyword">if</span> alert.resolved == resolved]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_performance_stats</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取性能统计&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.performance_stats</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_health_status</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取健康状态&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.health_status</span><br></pre></td></tr></table></figure>

<h2 id="六、复杂场景解决方案"><a href="#六、复杂场景解决方案" class="headerlink" title="六、复杂场景解决方案"></a>六、复杂场景解决方案</h2><h3 id="6-1-长对话上下文管理"><a href="#6-1-长对话上下文管理" class="headerlink" title="6.1 长对话上下文管理"></a>6.1 长对话上下文管理</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Any</span>, <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> deque</span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConversationContext</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;对话上下文&quot;&quot;&quot;</span></span><br><span class="line">    conversation_id: <span class="built_in">str</span></span><br><span class="line">    user_id: <span class="built_in">str</span></span><br><span class="line">    messages: deque</span><br><span class="line">    context_summary: <span class="built_in">str</span></span><br><span class="line">    entities: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span><br><span class="line">    current_topic: <span class="built_in">str</span></span><br><span class="line">    context_length: <span class="built_in">int</span></span><br><span class="line">    max_context_length: <span class="built_in">int</span> = <span class="number">4000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LongContextManager</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;长对话上下文管理器&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">        <span class="variable language_">self</span>.config = config</span><br><span class="line">        <span class="variable language_">self</span>.conversations: <span class="type">Dict</span>[<span class="built_in">str</span>, ConversationContext] = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.summarizer = ContextSummarizer(config.get(<span class="string">&#x27;summarizer_config&#x27;</span>, &#123;&#125;))</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">manage_context</span>(<span class="params">self, conversation_id: <span class="built_in">str</span>, </span></span><br><span class="line"><span class="params">                           new_message: <span class="built_in">str</span>, </span></span><br><span class="line"><span class="params">                           response: <span class="built_in">str</span></span>) -&gt; ConversationContext:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;管理对话上下文&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> conversation_id <span class="keyword">not</span> <span class="keyword">in</span> <span class="variable language_">self</span>.conversations:</span><br><span class="line">            <span class="variable language_">self</span>.conversations[conversation_id] = ConversationContext(</span><br><span class="line">                conversation_id=conversation_id,</span><br><span class="line">                user_id=<span class="string">&quot;&quot;</span>,  <span class="comment"># 需要从请求中获取</span></span><br><span class="line">                messages=deque(maxlen=<span class="number">100</span>),</span><br><span class="line">                context_summary=<span class="string">&quot;&quot;</span>,</span><br><span class="line">                entities=&#123;&#125;,</span><br><span class="line">                current_topic=<span class="string">&quot;&quot;</span>,</span><br><span class="line">                context_length=<span class="number">0</span></span><br><span class="line">            )</span><br><span class="line">        </span><br><span class="line">        context = <span class="variable language_">self</span>.conversations[conversation_id]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 添加新消息</span></span><br><span class="line">        context.messages.append(&#123;</span><br><span class="line">            <span class="string">&#x27;role&#x27;</span>: <span class="string">&#x27;user&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;content&#x27;</span>: new_message,</span><br><span class="line">            <span class="string">&#x27;timestamp&#x27;</span>: datetime.now()</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">        context.messages.append(&#123;</span><br><span class="line">            <span class="string">&#x27;role&#x27;</span>: <span class="string">&#x27;assistant&#x27;</span>, </span><br><span class="line">            <span class="string">&#x27;content&#x27;</span>: response,</span><br><span class="line">            <span class="string">&#x27;timestamp&#x27;</span>: datetime.now()</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 更新上下文长度</span></span><br><span class="line">        context.context_length += <span class="built_in">len</span>(new_message) + <span class="built_in">len</span>(response)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查是否需要压缩上下文</span></span><br><span class="line">        <span class="keyword">if</span> context.context_length &gt; context.max_context_length:</span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">self</span>._compress_context(context)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> context</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_compress_context</span>(<span class="params">self, context: ConversationContext</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;压缩上下文&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 保留最近的几条消息</span></span><br><span class="line">        recent_messages = <span class="built_in">list</span>(context.messages)[-<span class="number">10</span>:]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 对较早的消息进行摘要</span></span><br><span class="line">        old_messages = <span class="built_in">list</span>(context.messages)[:-<span class="number">10</span>]</span><br><span class="line">        <span class="keyword">if</span> old_messages:</span><br><span class="line">            summary = <span class="keyword">await</span> <span class="variable language_">self</span>.summarizer.summarize_messages(old_messages)</span><br><span class="line">            context.context_summary = summary</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 重建消息队列</span></span><br><span class="line">        context.messages.clear()</span><br><span class="line">        context.messages.extend(recent_messages)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 重新计算上下文长度</span></span><br><span class="line">        context.context_length = <span class="built_in">sum</span>(</span><br><span class="line">            <span class="built_in">len</span>(msg[<span class="string">&#x27;content&#x27;</span>]) <span class="keyword">for</span> msg <span class="keyword">in</span> recent_messages</span><br><span class="line">        ) + <span class="built_in">len</span>(context.context_summary)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ContextSummarizer</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;上下文摘要器&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">        <span class="variable language_">self</span>.config = config</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">summarize_messages</span>(<span class="params">self, messages: <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;摘要消息&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 构建摘要提示</span></span><br><span class="line">        conversation_text = <span class="string">&quot;\n&quot;</span>.join([</span><br><span class="line">            <span class="string">f&quot;<span class="subst">&#123;msg[<span class="string">&#x27;role&#x27;</span>]&#125;</span>: <span class="subst">&#123;msg[<span class="string">&#x27;content&#x27;</span>]&#125;</span>&quot;</span> </span><br><span class="line">            <span class="keyword">for</span> msg <span class="keyword">in</span> messages</span><br><span class="line">        ])</span><br><span class="line">        </span><br><span class="line">        summary_prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        请对以下对话进行摘要，保留关键信息和上下文：</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        <span class="subst">&#123;conversation_text&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        摘要：</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 调用大语言模型进行摘要</span></span><br><span class="line">        <span class="comment"># 这里需要调用实际的模型服务</span></span><br><span class="line">        summary = <span class="keyword">await</span> <span class="variable language_">self</span>._call_summarization_model(summary_prompt)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> summary</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_call_summarization_model</span>(<span class="params">self, prompt: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;调用摘要模型&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 实际实现中需要调用模型服务</span></span><br><span class="line">        <span class="comment"># 这里返回模拟结果</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;对话摘要：用户询问了关于产品功能的问题，助手提供了详细的解答。&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-多轮复杂推理"><a href="#6-2-多轮复杂推理" class="headerlink" title="6.2 多轮复杂推理"></a>6.2 多轮复杂推理</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Any</span>, <span class="type">Optional</span>, <span class="type">Tuple</span></span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReasoningType</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;推理类型&quot;&quot;&quot;</span></span><br><span class="line">    DEDUCTIVE = <span class="string">&quot;deductive&quot;</span>  <span class="comment"># 演绎推理</span></span><br><span class="line">    INDUCTIVE = <span class="string">&quot;inductive&quot;</span>  <span class="comment"># 归纳推理</span></span><br><span class="line">    ABDUCTIVE = <span class="string">&quot;abductive&quot;</span>  <span class="comment"># 溯因推理</span></span><br><span class="line">    CAUSAL = <span class="string">&quot;causal&quot;</span>        <span class="comment"># 因果推理</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReasoningStep</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;推理步骤&quot;&quot;&quot;</span></span><br><span class="line">    step_id: <span class="built_in">str</span></span><br><span class="line">    reasoning_type: ReasoningType</span><br><span class="line">    premise: <span class="built_in">str</span></span><br><span class="line">    conclusion: <span class="built_in">str</span></span><br><span class="line">    confidence: <span class="built_in">float</span></span><br><span class="line">    evidence: <span class="type">List</span>[<span class="built_in">str</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReasoningChain</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;推理链&quot;&quot;&quot;</span></span><br><span class="line">    chain_id: <span class="built_in">str</span></span><br><span class="line">    question: <span class="built_in">str</span></span><br><span class="line">    steps: <span class="type">List</span>[ReasoningStep]</span><br><span class="line">    final_answer: <span class="built_in">str</span></span><br><span class="line">    overall_confidence: <span class="built_in">float</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ComplexReasoningEngine</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;复杂推理引擎&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">        <span class="variable language_">self</span>.config = config</span><br><span class="line">        <span class="variable language_">self</span>.knowledge_base = config.get(<span class="string">&#x27;knowledge_base&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.reasoning_strategies = &#123;</span><br><span class="line">            ReasoningType.DEDUCTIVE: <span class="variable language_">self</span>._deductive_reasoning,</span><br><span class="line">            ReasoningType.INDUCTIVE: <span class="variable language_">self</span>._inductive_reasoning,</span><br><span class="line">            ReasoningType.ABDUCTIVE: <span class="variable language_">self</span>._abductive_reasoning,</span><br><span class="line">            ReasoningType.CAUSAL: <span class="variable language_">self</span>._causal_reasoning</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">complex_reasoning</span>(<span class="params">self, question: <span class="built_in">str</span>, </span></span><br><span class="line"><span class="params">                              context: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; ReasoningChain:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;复杂推理&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 分析问题类型</span></span><br><span class="line">        question_type = <span class="keyword">await</span> <span class="variable language_">self</span>._analyze_question_type(question)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 构建推理链</span></span><br><span class="line">        reasoning_chain = ReasoningChain(</span><br><span class="line">            chain_id=<span class="string">f&quot;reasoning_<span class="subst">&#123;<span class="built_in">int</span>(time.time())&#125;</span>&quot;</span>,</span><br><span class="line">            question=question,</span><br><span class="line">            steps=[],</span><br><span class="line">            final_answer=<span class="string">&quot;&quot;</span>,</span><br><span class="line">            overall_confidence=<span class="number">0.0</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 执行多轮推理</span></span><br><span class="line">        current_context = context.copy()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> step_num <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):  <span class="comment"># 最多5轮推理</span></span><br><span class="line">            <span class="comment"># 选择推理策略</span></span><br><span class="line">            reasoning_type = <span class="keyword">await</span> <span class="variable language_">self</span>._select_reasoning_strategy(</span><br><span class="line">                question, current_context, reasoning_chain.steps</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 执行推理步骤</span></span><br><span class="line">            step = <span class="keyword">await</span> <span class="variable language_">self</span>._execute_reasoning_step(</span><br><span class="line">                reasoning_type, question, current_context, reasoning_chain.steps</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> step:</span><br><span class="line">                reasoning_chain.steps.append(step)</span><br><span class="line">                current_context.update(&#123;</span><br><span class="line">                    <span class="string">&#x27;previous_conclusions&#x27;</span>: [s.conclusion <span class="keyword">for</span> s <span class="keyword">in</span> reasoning_chain.steps],</span><br><span class="line">                    <span class="string">&#x27;current_step&#x27;</span>: step_num + <span class="number">1</span></span><br><span class="line">                &#125;)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 检查是否达到最终答案</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">await</span> <span class="variable language_">self</span>._is_reasoning_complete(reasoning_chain):</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 生成最终答案</span></span><br><span class="line">        reasoning_chain.final_answer = <span class="keyword">await</span> <span class="variable language_">self</span>._generate_final_answer(reasoning_chain)</span><br><span class="line">        reasoning_chain.overall_confidence = <span class="variable language_">self</span>._calculate_overall_confidence(reasoning_chain)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> reasoning_chain</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_analyze_question_type</span>(<span class="params">self, question: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;分析问题类型&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 使用NLP技术分析问题类型</span></span><br><span class="line">        <span class="comment"># 这里简化处理</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">any</span>(word <span class="keyword">in</span> question.lower() <span class="keyword">for</span> word <span class="keyword">in</span> [<span class="string">&#x27;why&#x27;</span>, <span class="string">&#x27;because&#x27;</span>, <span class="string">&#x27;cause&#x27;</span>]):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;causal&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">any</span>(word <span class="keyword">in</span> question.lower() <span class="keyword">for</span> word <span class="keyword">in</span> [<span class="string">&#x27;what if&#x27;</span>, <span class="string">&#x27;suppose&#x27;</span>, <span class="string">&#x27;assume&#x27;</span>]):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;hypothetical&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">any</span>(word <span class="keyword">in</span> question.lower() <span class="keyword">for</span> word <span class="keyword">in</span> [<span class="string">&#x27;compare&#x27;</span>, <span class="string">&#x27;difference&#x27;</span>, <span class="string">&#x27;similar&#x27;</span>]):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;comparative&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;factual&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_select_reasoning_strategy</span>(<span class="params">self, question: <span class="built_in">str</span>, </span></span><br><span class="line"><span class="params">                                       context: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>],</span></span><br><span class="line"><span class="params">                                       previous_steps: <span class="type">List</span>[ReasoningStep]</span>) -&gt; ReasoningType:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;选择推理策略&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 基于问题类型和上下文选择推理策略</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> previous_steps:</span><br><span class="line">            <span class="comment"># 第一步通常使用演绎推理</span></span><br><span class="line">            <span class="keyword">return</span> ReasoningType.DEDUCTIVE</span><br><span class="line">        </span><br><span class="line">        last_step = previous_steps[-<span class="number">1</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 如果前一步是演绎推理，可以尝试归纳推理</span></span><br><span class="line">        <span class="keyword">if</span> last_step.reasoning_type == ReasoningType.DEDUCTIVE:</span><br><span class="line">            <span class="keyword">return</span> ReasoningType.INDUCTIVE</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 如果需要寻找原因，使用溯因推理</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;why&#x27;</span> <span class="keyword">in</span> question.lower() <span class="keyword">or</span> <span class="string">&#x27;cause&#x27;</span> <span class="keyword">in</span> question.lower():</span><br><span class="line">            <span class="keyword">return</span> ReasoningType.ABDUCTIVE</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 默认使用因果推理</span></span><br><span class="line">        <span class="keyword">return</span> ReasoningType.CAUSAL</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_execute_reasoning_step</span>(<span class="params">self, reasoning_type: ReasoningType,</span></span><br><span class="line"><span class="params">                                    question: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">                                    context: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>],</span></span><br><span class="line"><span class="params">                                    previous_steps: <span class="type">List</span>[ReasoningStep]</span>) -&gt; <span class="type">Optional</span>[ReasoningStep]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;执行推理步骤&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        strategy = <span class="variable language_">self</span>.reasoning_strategies.get(reasoning_type)</span><br><span class="line">        <span class="keyword">if</span> strategy:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> strategy(question, context, previous_steps)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_deductive_reasoning</span>(<span class="params">self, question: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">                                 context: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>],</span></span><br><span class="line"><span class="params">                                 previous_steps: <span class="type">List</span>[ReasoningStep]</span>) -&gt; ReasoningStep:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;演绎推理&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 从一般规则推导出特定结论</span></span><br><span class="line">        premise = <span class="string">&quot;基于已知的一般规则和事实&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 查找相关规则</span></span><br><span class="line">        relevant_rules = <span class="keyword">await</span> <span class="variable language_">self</span>._find_relevant_rules(question, context)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 应用规则</span></span><br><span class="line">        conclusion = <span class="keyword">await</span> <span class="variable language_">self</span>._apply_deductive_rules(relevant_rules, context)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ReasoningStep(</span><br><span class="line">            step_id=<span class="string">f&quot;deductive_<span class="subst">&#123;<span class="built_in">len</span>(previous_steps)&#125;</span>&quot;</span>,</span><br><span class="line">            reasoning_type=ReasoningType.DEDUCTIVE,</span><br><span class="line">            premise=premise,</span><br><span class="line">            conclusion=conclusion,</span><br><span class="line">            confidence=<span class="number">0.8</span>,</span><br><span class="line">            evidence=relevant_rules</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_inductive_reasoning</span>(<span class="params">self, question: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">                                 context: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>],</span></span><br><span class="line"><span class="params">                                 previous_steps: <span class="type">List</span>[ReasoningStep]</span>) -&gt; ReasoningStep:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;归纳推理&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 从特定观察推导出一般规律</span></span><br><span class="line">        premise = <span class="string">&quot;基于观察到的特定案例&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 收集相关案例</span></span><br><span class="line">        cases = <span class="keyword">await</span> <span class="variable language_">self</span>._collect_relevant_cases(question, context)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 归纳出一般规律</span></span><br><span class="line">        conclusion = <span class="keyword">await</span> <span class="variable language_">self</span>._induce_general_pattern(cases)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ReasoningStep(</span><br><span class="line">            step_id=<span class="string">f&quot;inductive_<span class="subst">&#123;<span class="built_in">len</span>(previous_steps)&#125;</span>&quot;</span>,</span><br><span class="line">            reasoning_type=ReasoningType.INDUCTIVE,</span><br><span class="line">            premise=premise,</span><br><span class="line">            conclusion=conclusion,</span><br><span class="line">            confidence=<span class="number">0.7</span>,</span><br><span class="line">            evidence=cases</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_abductive_reasoning</span>(<span class="params">self, question: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">                                 context: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>],</span></span><br><span class="line"><span class="params">                                 previous_steps: <span class="type">List</span>[ReasoningStep]</span>) -&gt; ReasoningStep:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;溯因推理&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 从结果推导出最可能的原因</span></span><br><span class="line">        premise = <span class="string">&quot;基于观察到的结果&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 生成可能的假设</span></span><br><span class="line">        hypotheses = <span class="keyword">await</span> <span class="variable language_">self</span>._generate_hypotheses(question, context)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 选择最佳假设</span></span><br><span class="line">        best_hypothesis = <span class="keyword">await</span> <span class="variable language_">self</span>._select_best_hypothesis(hypotheses, context)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ReasoningStep(</span><br><span class="line">            step_id=<span class="string">f&quot;abductive_<span class="subst">&#123;<span class="built_in">len</span>(previous_steps)&#125;</span>&quot;</span>,</span><br><span class="line">            reasoning_type=ReasoningType.ABDUCTIVE,</span><br><span class="line">            premise=premise,</span><br><span class="line">            conclusion=best_hypothesis,</span><br><span class="line">            confidence=<span class="number">0.6</span>,</span><br><span class="line">            evidence=hypotheses</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_causal_reasoning</span>(<span class="params">self, question: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">                              context: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>],</span></span><br><span class="line"><span class="params">                              previous_steps: <span class="type">List</span>[ReasoningStep]</span>) -&gt; ReasoningStep:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;因果推理&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 分析因果关系</span></span><br><span class="line">        premise = <span class="string">&quot;基于因果关系分析&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 识别因果链</span></span><br><span class="line">        causal_chain = <span class="keyword">await</span> <span class="variable language_">self</span>._identify_causal_chain(question, context)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 推导因果结论</span></span><br><span class="line">        conclusion = <span class="keyword">await</span> <span class="variable language_">self</span>._derive_causal_conclusion(causal_chain)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ReasoningStep(</span><br><span class="line">            step_id=<span class="string">f&quot;causal_<span class="subst">&#123;<span class="built_in">len</span>(previous_steps)&#125;</span>&quot;</span>,</span><br><span class="line">            reasoning_type=ReasoningType.CAUSAL,</span><br><span class="line">            premise=premise,</span><br><span class="line">            conclusion=conclusion,</span><br><span class="line">            confidence=<span class="number">0.75</span>,</span><br><span class="line">            evidence=causal_chain</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_is_reasoning_complete</span>(<span class="params">self, reasoning_chain: ReasoningChain</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检查推理是否完成&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查是否有足够的推理步骤</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(reasoning_chain.steps) &lt; <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查最后一步的置信度</span></span><br><span class="line">        last_step = reasoning_chain.steps[-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">if</span> last_step.confidence &lt; <span class="number">0.5</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查是否形成了完整的推理链</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> <span class="variable language_">self</span>._check_reasoning_completeness(reasoning_chain)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_check_reasoning_completeness</span>(<span class="params">self, reasoning_chain: ReasoningChain</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检查推理完整性&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查推理步骤之间的连贯性</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="built_in">len</span>(reasoning_chain.steps)):</span><br><span class="line">            prev_step = reasoning_chain.steps[i-<span class="number">1</span>]</span><br><span class="line">            curr_step = reasoning_chain.steps[i]</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 检查逻辑连接</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">await</span> <span class="variable language_">self</span>._check_logical_connection(prev_step, curr_step):</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_check_logical_connection</span>(<span class="params">self, step1: ReasoningStep, step2: ReasoningStep</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检查逻辑连接&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查前一步的结论是否能支持后一步的前提</span></span><br><span class="line">        <span class="comment"># 这里简化处理</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span>  <span class="comment"># 实际实现需要更复杂的逻辑检查</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">_generate_final_answer</span>(<span class="params">self, reasoning_chain: ReasoningChain</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;生成最终答案&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 整合所有推理步骤</span></span><br><span class="line">        all_conclusions = [step.conclusion <span class="keyword">for</span> step <span class="keyword">in</span> reasoning_chain.steps]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 构建最终答案</span></span><br><span class="line">        final_answer_prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        基于以下推理步骤，请给出最终答案：</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        问题：<span class="subst">&#123;reasoning_chain.question&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        推理步骤：</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;<span class="built_in">chr</span>(<span class="number">10</span>).join([<span class="string">f&quot;<span class="subst">&#123;i+<span class="number">1</span>&#125;</span>. <span class="subst">&#123;conclusion&#125;</span>&quot;</span> <span class="keyword">for</span> i, conclusion <span class="keyword">in</span> <span class="built_in">enumerate</span>(all_conclusions)])&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        最终答案：</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 调用语言模型生成最终答案</span></span><br><span class="line">        final_answer = <span class="keyword">await</span> <span class="variable language_">self</span>._call_language_model(final_answer_prompt)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> final_answer</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_calculate_overall_confidence</span>(<span class="params">self, reasoning_chain: ReasoningChain</span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;计算整体置信度&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> reasoning_chain.steps:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0.0</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 使用几何平均数计算整体置信度</span></span><br><span class="line">        confidences = [step.confidence <span class="keyword">for</span> step <span class="keyword">in</span> reasoning_chain.steps]</span><br><span class="line">        overall_confidence = <span class="number">1.0</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> confidence <span class="keyword">in</span> confidences:</span><br><span class="line">            overall_confidence *= confidence</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> overall_confidence ** (<span class="number">1.0</span> / <span class="built_in">len</span>(confidences))</span><br></pre></td></tr></table></figure>

<p>这个企业级大模型Agent框架的完整架构设计涵盖了：</p>
<ol>
<li><strong>核心Agent架构</strong>：模块化、可扩展的Agent设计</li>
<li><strong>智能编排系统</strong>：支持复杂工作流和智能路由</li>
<li><strong>多模态融合</strong>：完整的多模态数据处理能力</li>
<li><strong>知识图谱集成</strong>：知识抽取、推理和查询</li>
<li><strong>模型管理服务</strong>：统一的模型网关和服务化</li>
<li><strong>安全权限控制</strong>：完善的认证授权和数据安全</li>
<li><strong>监控运维系统</strong>：全面的性能监控和告警</li>
<li><strong>复杂场景解决方案</strong>：长对话管理和复杂推理</li>
</ol>
<p>这个框架能够支持企业级的复杂应用场景，提供了完整的技术解决方案。</p>
<h2 id="七、总结与展望"><a href="#七、总结与展望" class="headerlink" title="七、总结与展望"></a>七、总结与展望</h2><h3 id="7-1-框架核心优势"><a href="#7-1-框架核心优势" class="headerlink" title="7.1 框架核心优势"></a>7.1 框架核心优势</h3><p>本企业级大模型Agent框架具有以下核心优势：</p>
<h4 id="7-1-1-架构优势"><a href="#7-1-1-架构优势" class="headerlink" title="7.1.1 架构优势"></a>7.1.1 架构优势</h4><ul>
<li><strong>模块化设计</strong>：组件解耦，便于扩展和维护</li>
<li><strong>微服务架构</strong>：支持分布式部署和横向扩展</li>
<li><strong>插件化机制</strong>：支持自定义Agent和工具扩展</li>
<li><strong>容器化支持</strong>：基于Kubernetes的云原生部署</li>
</ul>
<h4 id="7-1-2-技术优势"><a href="#7-1-2-技术优势" class="headerlink" title="7.1.2 技术优势"></a>7.1.2 技术优势</h4><ul>
<li><strong>多模态融合</strong>：统一处理文本、图像、音频等多种数据类型</li>
<li><strong>知识图谱集成</strong>：提供强大的知识推理和查询能力</li>
<li><strong>智能路由</strong>：基于多维度评分的负载均衡和任务分发</li>
<li><strong>复杂推理</strong>：支持多轮推理和复杂逻辑链条</li>
</ul>
<h4 id="7-1-3-工程优势"><a href="#7-1-3-工程优势" class="headerlink" title="7.1.3 工程优势"></a>7.1.3 工程优势</h4><ul>
<li><strong>高可用性</strong>：完善的故障恢复和容错机制</li>
<li><strong>高性能</strong>：异步处理和并发优化</li>
<li><strong>安全可靠</strong>：全面的权限控制和数据安全保护</li>
<li><strong>可观测性</strong>：完整的监控、日志和链路追踪</li>
</ul>
<h3 id="7-2-部署建议"><a href="#7-2-部署建议" class="headerlink" title="7.2 部署建议"></a>7.2 部署建议</h3><h4 id="7-2-1-硬件配置建议"><a href="#7-2-1-硬件配置建议" class="headerlink" title="7.2.1 硬件配置建议"></a>7.2.1 硬件配置建议</h4><p><strong>生产环境配置：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 最小配置</span></span><br><span class="line"><span class="attr">minimum_config:</span></span><br><span class="line">  <span class="attr">cpu:</span> <span class="number">16</span> <span class="string">cores</span></span><br><span class="line">  <span class="attr">memory:</span> <span class="string">64GB</span></span><br><span class="line">  <span class="attr">gpu:</span> <span class="string">2x</span> <span class="string">NVIDIA</span> <span class="string">A100</span> <span class="string">40GB</span></span><br><span class="line">  <span class="attr">storage:</span> <span class="string">1TB</span> <span class="string">NVMe</span> <span class="string">SSD</span></span><br><span class="line">  <span class="attr">network:</span> <span class="string">10Gbps</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 推荐配置</span></span><br><span class="line"><span class="attr">recommended_config:</span></span><br><span class="line">  <span class="attr">cpu:</span> <span class="number">32</span> <span class="string">cores</span></span><br><span class="line">  <span class="attr">memory:</span> <span class="string">128GB</span></span><br><span class="line">  <span class="attr">gpu:</span> <span class="string">4x</span> <span class="string">NVIDIA</span> <span class="string">A100</span> <span class="string">80GB</span></span><br><span class="line">  <span class="attr">storage:</span> <span class="string">2TB</span> <span class="string">NVMe</span> <span class="string">SSD</span></span><br><span class="line">  <span class="attr">network:</span> <span class="string">25Gbps</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 高负载配置</span></span><br><span class="line"><span class="attr">high_load_config:</span></span><br><span class="line">  <span class="attr">cpu:</span> <span class="number">64</span> <span class="string">cores</span></span><br><span class="line">  <span class="attr">memory:</span> <span class="string">256GB</span></span><br><span class="line">  <span class="attr">gpu:</span> <span class="string">8x</span> <span class="string">NVIDIA</span> <span class="string">H100</span> <span class="string">80GB</span></span><br><span class="line">  <span class="attr">storage:</span> <span class="string">4TB</span> <span class="string">NVMe</span> <span class="string">SSD</span></span><br><span class="line">  <span class="attr">network:</span> <span class="string">100Gbps</span></span><br></pre></td></tr></table></figure>

<h4 id="7-2-2-部署架构建议"><a href="#7-2-2-部署架构建议" class="headerlink" title="7.2.2 部署架构建议"></a>7.2.2 部署架构建议</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line">    subgraph &quot;负载均衡层&quot;</span><br><span class="line">        LB1[负载均衡器1]</span><br><span class="line">        LB2[负载均衡器2]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph &quot;网关集群&quot;</span><br><span class="line">        GW1[网关节点1]</span><br><span class="line">        GW2[网关节点2]</span><br><span class="line">        GW3[网关节点3]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph &quot;Agent服务集群&quot;</span><br><span class="line">        AS1[Agent服务1]</span><br><span class="line">        AS2[Agent服务2]</span><br><span class="line">        AS3[Agent服务3]</span><br><span class="line">        AS4[Agent服务4]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph &quot;模型服务集群&quot;</span><br><span class="line">        MS1[模型服务1]</span><br><span class="line">        MS2[模型服务2]</span><br><span class="line">        MS3[模型服务3]</span><br><span class="line">        MS4[模型服务4]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph &quot;存储集群&quot;</span><br><span class="line">        VDB[向量数据库集群]</span><br><span class="line">        GDB[图数据库集群]</span><br><span class="line">        CACHE[缓存集群]</span><br><span class="line">        FS[文件存储集群]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph &quot;监控集群&quot;</span><br><span class="line">        PROM[Prometheus]</span><br><span class="line">        GRAF[Grafana]</span><br><span class="line">        ELK[ELK Stack]</span><br><span class="line">        JAEGER[Jaeger]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    LB1 --&gt; GW1</span><br><span class="line">    LB1 --&gt; GW2</span><br><span class="line">    LB2 --&gt; GW2</span><br><span class="line">    LB2 --&gt; GW3</span><br><span class="line">    </span><br><span class="line">    GW1 --&gt; AS1</span><br><span class="line">    GW1 --&gt; AS2</span><br><span class="line">    GW2 --&gt; AS2</span><br><span class="line">    GW2 --&gt; AS3</span><br><span class="line">    GW3 --&gt; AS3</span><br><span class="line">    GW3 --&gt; AS4</span><br><span class="line">    </span><br><span class="line">    AS1 --&gt; MS1</span><br><span class="line">    AS2 --&gt; MS2</span><br><span class="line">    AS3 --&gt; MS3</span><br><span class="line">    AS4 --&gt; MS4</span><br><span class="line">    </span><br><span class="line">    AS1 --&gt; VDB</span><br><span class="line">    AS2 --&gt; GDB</span><br><span class="line">    AS3 --&gt; CACHE</span><br><span class="line">    AS4 --&gt; FS</span><br><span class="line">    </span><br><span class="line">    PROM --&gt; GRAF</span><br><span class="line">    ELK --&gt; GRAF</span><br><span class="line">    JAEGER --&gt; GRAF</span><br><span class="line">    </span><br><span class="line">    style LB1 fill:#ff9999</span><br><span class="line">    style VDB fill:#99ccff</span><br><span class="line">    style PROM fill:#99ff99</span><br></pre></td></tr></table></figure>

<h4 id="7-2-3-部署步骤"><a href="#7-2-3-部署步骤" class="headerlink" title="7.2.3 部署步骤"></a>7.2.3 部署步骤</h4><p><strong>1. 环境准备</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装Kubernetes集群</span></span><br><span class="line">kubeadm init --pod-network-cidr=10.244.0.0/16</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装Helm</span></span><br><span class="line">curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装必要的Operator</span></span><br><span class="line">kubectl apply -f https://github.com/prometheus-operator/prometheus-operator/releases/download/v0.68.0/bundle.yaml</span><br></pre></td></tr></table></figure>

<p><strong>2. 基础设施部署</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 部署向量数据库</span></span><br><span class="line">helm install milvus milvus/milvus --<span class="built_in">set</span> cluster.enabled=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署图数据库</span></span><br><span class="line">helm install neo4j neo4j/neo4j --<span class="built_in">set</span> core.numberOfServers=3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署缓存集群</span></span><br><span class="line">helm install redis bitnami/redis-cluster --<span class="built_in">set</span> cluster.nodes=6</span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署监控系统</span></span><br><span class="line">helm install prometheus prometheus-community/kube-prometheus-stack</span><br></pre></td></tr></table></figure>

<p><strong>3. 框架部署</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 部署Agent框架</span></span><br><span class="line">kubectl apply -f deployment/agent-framework.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署模型服务</span></span><br><span class="line">kubectl apply -f deployment/model-services.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署网关服务</span></span><br><span class="line">kubectl apply -f deployment/gateway-services.yaml</span><br></pre></td></tr></table></figure>

<h3 id="7-3-性能优化建议"><a href="#7-3-性能优化建议" class="headerlink" title="7.3 性能优化建议"></a>7.3 性能优化建议</h3><h4 id="7-3-1-系统级优化"><a href="#7-3-1-系统级优化" class="headerlink" title="7.3.1 系统级优化"></a>7.3.1 系统级优化</h4><ul>
<li><strong>CPU优化</strong>：使用NUMA绑定和CPU亲和性</li>
<li><strong>内存优化</strong>：配置大页内存和内存池</li>
<li><strong>网络优化</strong>：使用DPDK和SR-IOV</li>
<li><strong>存储优化</strong>：配置NVMe多队列和IO调度器</li>
</ul>
<h4 id="7-3-2-应用级优化"><a href="#7-3-2-应用级优化" class="headerlink" title="7.3.2 应用级优化"></a>7.3.2 应用级优化</h4><ul>
<li><strong>模型优化</strong>：量化、剪枝、蒸馏等技术</li>
<li><strong>缓存优化</strong>：多级缓存和缓存预热</li>
<li><strong>并发优化</strong>：异步处理和协程池</li>
<li><strong>负载均衡</strong>：智能路由和动态权重</li>
</ul>
<h4 id="7-3-3-数据库优化"><a href="#7-3-3-数据库优化" class="headerlink" title="7.3.3 数据库优化"></a>7.3.3 数据库优化</h4><ul>
<li><strong>向量数据库</strong>：索引优化和分片策略</li>
<li><strong>图数据库</strong>：查询优化和缓存策略</li>
<li><strong>关系数据库</strong>：索引设计和分区策略</li>
<li><strong>缓存系统</strong>：过期策略和内存管理</li>
</ul>
<h3 id="7-4-运维最佳实践"><a href="#7-4-运维最佳实践" class="headerlink" title="7.4 运维最佳实践"></a>7.4 运维最佳实践</h3><h4 id="7-4-1-监控指标"><a href="#7-4-1-监控指标" class="headerlink" title="7.4.1 监控指标"></a>7.4.1 监控指标</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关键监控指标</span></span><br><span class="line">key_metrics = &#123;</span><br><span class="line">    <span class="string">&quot;系统指标&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;CPU使用率&quot;</span>, <span class="string">&quot;内存使用率&quot;</span>, <span class="string">&quot;磁盘使用率&quot;</span>, <span class="string">&quot;网络带宽&quot;</span>,</span><br><span class="line">        <span class="string">&quot;GPU使用率&quot;</span>, <span class="string">&quot;GPU内存使用率&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;应用指标&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;请求响应时间&quot;</span>, <span class="string">&quot;吞吐量&quot;</span>, <span class="string">&quot;错误率&quot;</span>, <span class="string">&quot;并发数&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Agent执行时间&quot;</span>, <span class="string">&quot;模型推理时间&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;业务指标&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;用户活跃度&quot;</span>, <span class="string">&quot;对话轮次&quot;</span>, <span class="string">&quot;任务成功率&quot;</span>, <span class="string">&quot;用户满意度&quot;</span>,</span><br><span class="line">        <span class="string">&quot;知识库命中率&quot;</span>, <span class="string">&quot;推理准确率&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="7-4-2-告警策略"><a href="#7-4-2-告警策略" class="headerlink" title="7.4.2 告警策略"></a>7.4.2 告警策略</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 告警规则配置</span></span><br><span class="line"><span class="attr">alert_rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;高CPU使用率&quot;</span></span><br><span class="line">    <span class="attr">condition:</span> <span class="string">&quot;cpu_usage &gt; 80%&quot;</span></span><br><span class="line">    <span class="attr">duration:</span> <span class="string">&quot;5m&quot;</span></span><br><span class="line">    <span class="attr">severity:</span> <span class="string">&quot;warning&quot;</span></span><br><span class="line">    </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;内存不足&quot;</span></span><br><span class="line">    <span class="attr">condition:</span> <span class="string">&quot;memory_usage &gt; 90%&quot;</span></span><br><span class="line">    <span class="attr">duration:</span> <span class="string">&quot;2m&quot;</span></span><br><span class="line">    <span class="attr">severity:</span> <span class="string">&quot;critical&quot;</span></span><br><span class="line">    </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;响应时间过长&quot;</span></span><br><span class="line">    <span class="attr">condition:</span> <span class="string">&quot;response_time &gt; 5s&quot;</span></span><br><span class="line">    <span class="attr">duration:</span> <span class="string">&quot;1m&quot;</span></span><br><span class="line">    <span class="attr">severity:</span> <span class="string">&quot;warning&quot;</span></span><br><span class="line">    </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;错误率过高&quot;</span></span><br><span class="line">    <span class="attr">condition:</span> <span class="string">&quot;error_rate &gt; 5%&quot;</span></span><br><span class="line">    <span class="attr">duration:</span> <span class="string">&quot;3m&quot;</span></span><br><span class="line">    <span class="attr">severity:</span> <span class="string">&quot;critical&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="7-4-3-容灾方案"><a href="#7-4-3-容灾方案" class="headerlink" title="7.4.3 容灾方案"></a>7.4.3 容灾方案</h4><ul>
<li><strong>多地域部署</strong>：跨地域的高可用架构</li>
<li><strong>数据备份</strong>：定期备份和异地存储</li>
<li><strong>故障转移</strong>：自动故障检测和切换</li>
<li><strong>灾难恢复</strong>：完整的灾难恢复预案</li>
</ul>
<h3 id="7-5-安全加固建议"><a href="#7-5-安全加固建议" class="headerlink" title="7.5 安全加固建议"></a>7.5 安全加固建议</h3><h4 id="7-5-1-网络安全"><a href="#7-5-1-网络安全" class="headerlink" title="7.5.1 网络安全"></a>7.5.1 网络安全</h4><ul>
<li><strong>网络隔离</strong>：使用VPC和安全组</li>
<li><strong>防火墙配置</strong>：限制不必要的端口访问</li>
<li><strong>DDoS防护</strong>：部署DDoS防护设备</li>
<li><strong>SSL&#x2F;TLS</strong>：全链路加密传输</li>
</ul>
<h4 id="7-5-2-应用安全"><a href="#7-5-2-应用安全" class="headerlink" title="7.5.2 应用安全"></a>7.5.2 应用安全</h4><ul>
<li><strong>身份认证</strong>：多因素认证和SSO</li>
<li><strong>权限控制</strong>：细粒度的RBAC</li>
<li><strong>数据加密</strong>：敏感数据加密存储</li>
<li><strong>安全审计</strong>：完整的操作日志记录</li>
</ul>
<h4 id="7-5-3-合规要求"><a href="#7-5-3-合规要求" class="headerlink" title="7.5.3 合规要求"></a>7.5.3 合规要求</h4><ul>
<li><strong>数据保护</strong>：符合GDPR、CCPA等法规</li>
<li><strong>隐私保护</strong>：数据脱敏和匿名化</li>
<li><strong>审计日志</strong>：满足SOX、ISO27001要求</li>
<li><strong>安全认证</strong>：通过相关安全认证</li>
</ul>
<h3 id="7-6-未来发展方向"><a href="#7-6-未来发展方向" class="headerlink" title="7.6 未来发展方向"></a>7.6 未来发展方向</h3><h4 id="7-6-1-技术演进"><a href="#7-6-1-技术演进" class="headerlink" title="7.6.1 技术演进"></a>7.6.1 技术演进</h4><ul>
<li><strong>模型能力提升</strong>：更强的推理和理解能力</li>
<li><strong>多模态融合</strong>：更自然的多模态交互</li>
<li><strong>知识图谱</strong>：更智能的知识推理</li>
<li><strong>边缘计算</strong>：支持边缘部署和离线运行</li>
</ul>
<h4 id="7-6-2-功能扩展"><a href="#7-6-2-功能扩展" class="headerlink" title="7.6.2 功能扩展"></a>7.6.2 功能扩展</h4><ul>
<li><strong>自动化运维</strong>：智能化的运维管理</li>
<li><strong>个性化服务</strong>：基于用户画像的个性化</li>
<li><strong>行业定制</strong>：针对特定行业的解决方案</li>
<li><strong>生态集成</strong>：与更多第三方系统集成</li>
</ul>
<h4 id="7-6-3-性能优化"><a href="#7-6-3-性能优化" class="headerlink" title="7.6.3 性能优化"></a>7.6.3 性能优化</h4><ul>
<li><strong>硬件加速</strong>：利用新一代AI芯片</li>
<li><strong>算法优化</strong>：更高效的推理算法</li>
<li><strong>系统优化</strong>：更优的系统架构设计</li>
<li><strong>成本优化</strong>：降低部署和运维成本</li>
</ul>
<h3 id="7-7-结语"><a href="#7-7-结语" class="headerlink" title="7.7 结语"></a>7.7 结语</h3><p>本企业级大模型Agent框架提供了一个完整、可扩展、高性能的解决方案，能够满足企业在智能化转型过程中的各种需求。通过模块化的设计、先进的技术架构和完善的运维体系，该框架能够帮助企业快速构建和部署大模型应用，实现业务的智能化升级。</p>
<p>随着大模型技术的不断发展，该框架也将持续演进，为企业提供更加强大、灵活和易用的AI能力。我们相信，通过这个框架的应用，企业能够在激烈的市场竞争中获得技术优势，实现可持续的发展。</p>
<hr>
<p><em>本文档详细介绍了企业级大模型Agent框架的完整架构设计，包括核心组件、技术实现、部署方案和最佳实践。希望能为大模型应用的落地提供有价值的参考。</em></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/blog/tags/%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/" rel="tag"># 架构设计</a>
              <a href="/blog/tags/%E5%A4%A7%E6%A8%A1%E5%9E%8B/" rel="tag"># 大模型</a>
              <a href="/blog/tags/Agent/" rel="tag"># Agent</a>
              <a href="/blog/tags/%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%BA%94%E7%94%A8/" rel="tag"># 企业级应用</a>
              <a href="/blog/tags/AI%E6%A1%86%E6%9E%B6/" rel="tag"># AI框架</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/blog/2024/11/23/%E7%BA%BF%E7%BC%86%E8%A1%8C%E4%B8%9A%E6%95%B0%E6%8D%AE%E5%BC%82%E6%9E%84%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3/" rel="prev" title="线缆行业数据异构问题解决">
                  <i class="fa fa-angle-left"></i> 线缆行业数据异构问题解决
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/blog/2025/03/18/%E9%AB%98%E7%AB%AF%E9%80%9A%E4%BF%A1%E7%BA%BF%E7%BC%86%E7%94%9F%E4%BA%A7%E8%AE%BE%E5%A4%87%E4%B8%8E%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/" rel="next" title="高端通信线缆生产设备与通信协议深度解析">
                  高端通信线缆生产设备与通信协议深度解析 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2014 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">NexT</span>
  </div>
  <div class="powered-by">由 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZw==">NexT.Gemini</span> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRlZS5jb20vYWRkcm9j" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"next-theme","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/blog/js/third-party/comments/disqus.js" defer></script>

</body>
</html>
